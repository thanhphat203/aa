<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web Xem Phim - Sử dụng API phimapi.com</title>
    <style>
        body { font-family: Arial, sans-serif; background: #121212; color: #fff; margin: 0; padding: 20px; }
        .movie-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 20px; }
        .movie-item { cursor: pointer; text-align: center; }
        .movie-item img { width: 100%; height: auto; border-radius: 8px; }
        .movie-detail { display: none; margin-top: 20px; }
        .player { width: 100%; height: 500px; }
        #search { margin-bottom: 20px; padding: 10px; width: 100%; max-width: 400px; }
    </style>
</head>
<body>
    <h1>Danh Sách Phim Mới Cập Nhật</h1>
    <input type="text" id="search" placeholder="Tìm kiếm phim...">
    <div class="movie-list" id="movieList"></div>
    <div class="movie-detail" id="movieDetail">
        <h2 id="movieTitle"></h2>
        <p id="movieDesc"></p>
        <div id="episodeList"></div>
        <iframe id="playerIframe" class="player" allowfullscreen></iframe>
        <button onclick="closeDetail()">Đóng</button>
    </div>

    <script>
        const API_BASE = 'https://phimapi.com/';
        
        // Lấy danh sách phim mới
        async function fetchMovies(page = 1) {
            try {
                const res = await fetch(`${API_BASE}danh-sach/phim-moi-cap-nhat?page=${page}`);
                const data = await res.json();
                displayMovies(data.items);
            } catch (err) {
                console.error('Lỗi fetch:', err);
            }
        }
        
        // Hiển thị danh sách phim
        function displayMovies(movies) {
            const list = document.getElementById('movieList');
            list.innerHTML = '';
            movies.forEach(movie => {
                const div = document.createElement('div');
                div.className = 'movie-item';
                div.innerHTML = `
                    <img src="${movie.thumb_url || movie.poster_url}" alt="${movie.name}">
                    <p>${movie.name} (${movie.year})</p>
                `;
                div.onclick = () => fetchMovieDetail(movie.slug);
                list.appendChild(div);
            });
        }
        
        // Lấy chi tiết phim
        async function fetchMovieDetail(slug) {
            try {
                const res = await fetch(`${API_BASE}phim/${slug}`);
                const data = await res.json();
                const movie = data.movie;
                document.getElementById('movieTitle').textContent = movie.name;
                document.getElementById('movieDesc').textContent = movie.content;
                
                const episodeList = document.getElementById('episodeList');
                episodeList.innerHTML = '<h3>Danh sách tập:</h3>';
                data.episodes[0].server_data.forEach(ep => {
                    const btn = document.createElement('button');
                    btn.textContent = ep.name;
                    btn.onclick = () => playEpisode(ep.link_embed || ep.link_m3u8);
                    episodeList.appendChild(btn);
                });
                
                document.getElementById('movieDetail').style.display = 'block';
                // Play tập đầu tiên mặc định
                if (data.episodes[0].server_data[0]) {
                    playEpisode(data.episodes[0].server_data[0].link_embed || data.episodes[0].server_data[0].link_m3u8);
                }
            } catch (err) {
                console.error('Lỗi fetch chi tiết:', err);
            }
        }
        
        // Phát phim (sử dụng iframe cho embed, hoặc video cho m3u8)
        function playEpisode(link) {
            const player = document.getElementById('playerIframe');
            if (link.endsWith('.m3u8')) {
                // Để hỗ trợ m3u8 tốt hơn, dùng thư viện như hls.js (thêm script bên dưới)
                player.src = ''; // Reset
                player.outerHTML = `<video id="playerVideo" class="player" controls></video>`;
                const video = document.getElementById('playerVideo');
                if (Hls.isSupported()) {
                    const hls = new Hls();
                    hls.loadSource(link);
                    hls.attachMedia(video);
                } else {
                    video.src = link;
                }
            } else {
                player.src = link;
            }
        }
        
        // Đóng chi tiết
        function closeDetail() {
            document.getElementById('movieDetail').style.display = 'none';
        }
        
        // Tìm kiếm (sử dụng API tổng hợp với type=search nếu có, tạm dùng filter local)
        document.getElementById('search').addEventListener('input', (e) => {
            const term = e.target.value.toLowerCase();
            const items = document.querySelectorAll('.movie-item');
            items.forEach(item => {
                item.style.display = item.textContent.toLowerCase().includes(term) ? 'block' : 'none';
            });
        });
        
        // Load phim đầu tiên
        fetchMovies();
    </script>
    
    <!-- Thêm thư viện HLS.js để hỗ trợ m3u8 -->
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
</body>
</html>