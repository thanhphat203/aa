<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>THANHPHAT ‚Ä¢ Phim hay m∆∞·ª£t nh∆∞ app</title>
<meta name="description" content="Duy·ªát & xem th√¥ng tin phim m∆∞·ª£t. D·ªØ li·ªáu t·ª´ phimapi.com." />
<meta name="theme-color" content="#0b1020" />

<!-- Prefetch/Preconnect -->
<link rel="dns-prefetch" href="https://phimapi.com">
<link rel="dns-prefetch" href="https://phimimg.com">
<link rel="preconnect" href="https://phimapi.com" crossorigin>
<link rel="preconnect" href="https://phimimg.com" crossorigin>
<link rel="preconnect" href="https://images.weserv.nl" crossorigin>

<!-- Fonts -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">

<style>
:root{
  --bg:#0b1020;--panel:#11172c;--panel2:#0e152b;--ring:#2563eb;
  --accent:#e50914;--accent2:#7c3aed;--text:#f5f7fb;--muted:#97a2b3;
  --hdr-h:68px;--container:1220px;
}
@media(max-width:640px){:root{--hdr-h:72px}}
*{box-sizing:border-box}
html,body{height:100%}
html{scroll-padding-top:calc(var(--hdr-h) + env(safe-area-inset-top,0px))}
body{
  margin:0;color:var(--text);
  -webkit-tap-highlight-color: transparent;
  font-family:"Plus Jakarta Sans",system-ui,Segoe UI,Roboto,Arial,sans-serif;
  background:
    radial-gradient(900px 600px at 50% -200px, rgba(59,130,246,.25), transparent 60%),
    linear-gradient(180deg, rgba(2,6,23,.85), rgba(2,6,23,0)),
    var(--bg);
  padding-top:calc(var(--hdr-h) + env(safe-area-inset-top,0px));
}
a{color:inherit;text-decoration:none}
.container{max-width:var(--container);margin:0 auto;padding:0 14px}

/* ===== Header ===== */
.hdr{
  position:fixed;inset:0 0 auto 0;z-index:1000;
  backdrop-filter:blur(10px);
  background:linear-gradient(180deg,rgba(7,11,24,.92),rgba(7,11,24,.6));
  border-bottom:1px solid rgba(255,255,255,.06);
  padding-top:env(safe-area-inset-top,0px);
}
.hdr__row{
  display:grid;grid-template-columns:auto 1fr auto;gap:12px;align-items:center;
  padding:10px 12px;min-height:var(--hdr-h);
}
.brand{display:flex;align-items:center;gap:10px}
.brand__t{font-family:"Cinzel",serif;font-weight:800;letter-spacing:.5px;
  background:linear-gradient(90deg,#c7d2fe,#f0abfc);
  -webkit-background-clip:text;background-clip:text;color:transparent;
  text-shadow:0 0 16px rgba(124,58,237,.25);cursor:pointer;user-select:none}
.btn{background:linear-gradient(135deg,#2563eb,#7c3aed);border:0;color:#fff;
  padding:9px 12px;border-radius:12px;font-weight:800;cursor:pointer}
.btn:hover{transform:translateY(-1px)}
.btn:active{transform:translateY(0)}
.btn-pill{border-radius:999px}
.btn-ghost{background:#0f172a;border:1px solid rgba(255,255,255,.12);color:#e5e7eb}
.search{display:flex;gap:8px;background:rgba(255,255,255,.06);
  border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:8px 10px;min-width:220px}
.search input{flex:1;background:transparent;border:0;color:var(--text);outline:0}
.tabs{display:flex;gap:8px;overflow-x:auto;padding-bottom:4px;scrollbar-width:none}
.tabs::-webkit-scrollbar{display:none}
.tab{padding:8px 12px;border-radius:999px;border:1px solid rgba(255,255,255,.08);
  background:rgba(255,255,255,.05);color:#e5e7eb;white-space:nowrap;cursor:pointer}
.tab.active{background:linear-gradient(135deg,#2563eb,#7c3aed);border-color:transparent;box-shadow:0 6px 18px rgba(124,58,237,.25)}

/* ===== Chips ===== */
.chips{display:flex;gap:10px;flex-wrap:wrap;margin:8px 0 2px}
.chip{padding:8px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.08);
  background:rgba(255,255,255,.06);cursor:pointer}
.chip:hover{border-color:#7c3aed}

/* ===== Hero ===== */
.hero{position:relative;min-height:210px;padding:22px 0 0;margin-bottom:2px}
.hero__card{position:relative;border-radius:18px;overflow:hidden;border:1px solid rgba(255,255,255,.06);background:#0b1224}
.hero__bg{position:absolute;inset:0;background-size:cover;background-position:center;filter:blur(14px) saturate(1.2);transform:scale(1.12);opacity:.45}
.hero__overlay{position:absolute;inset:0;background:linear-gradient(90deg,rgba(8,12,28,.92),rgba(8,12,28,.72),rgba(8,12,28,.2))}
.hero__body{position:relative;display:flex;gap:16px;padding:16px}
.hero__poster{width:140px;border-radius:14px;overflow:hidden;flex:0 0 auto;background:#0e1426;border:1px solid rgba(255,255,255,.06)}
.hero__poster img{width:100%;height:210px;object-fit:cover;display:block}
.badges{display:flex;flex-wrap:wrap;gap:6px;margin:6px 0}
.badge{font-size:12px;padding:4px 8px;border-radius:999px;background:rgba(255,255,255,.09);border:1px solid rgba(255,255,255,.12)}
.hero h1{margin:4px 0 6px;font-size:20px;font-weight:800}
.hero .desc{color:#d0d6e5;max-height:66px;overflow:hidden}

/* ===== Sections & Rows ===== */
.sec{display:flex;align-items:center;justify-content:space-between;margin:16px 2px 10px}
.sec h2{font-size:20px;margin:0;color:#dbeafe;text-shadow:0 2px 14px rgba(59,130,246,.25)}
.row{position:relative}

/* H√†ng ngang */
.movie-row{
  display:flex;gap:14px;overflow-x:auto;scroll-behavior:smooth;
  padding:2px 2px 26px;
  -ms-overflow-style:none;scrollbar-width:none;
  touch-action: pan-y;
}
.movie-row::-webkit-scrollbar{height:0}
.row::before,.row::after{
  content:"";position:absolute;top:0;bottom:22px;width:42px;pointer-events:none;z-index:1
}
.row::before{left:0;background:linear-gradient(90deg, rgba(11,16,32,1), rgba(11,16,32,0))}
.row::after{right:0;background:linear-gradient(270deg, rgba(11,16,32,1), rgba(11,16,32,0))}
.movie-row.grabbing{cursor:grabbing; user-select:none}

/* Scrubber */
.scrubber{position:absolute;left:12px;right:12px;bottom:6px;height:12px;display:flex;align-items:center;opacity:.0;transition:opacity .2s}
.row:hover .scrubber{opacity:.95}
.scrubber .track{position:relative;flex:1;height:6px;border-radius:999px;background:rgba(255,255,255,.10);box-shadow:inset 0 0 0 1px rgba(255,255,255,.08)}
.scrubber .thumb{
  position:absolute;top:-4px;height:14px;border-radius:999px;min-width:28px;
  background:linear-gradient(90deg,#60a5fa,#a78bfa);box-shadow:0 2px 10px rgba(124,58,237,.35);
  cursor:grab;outline:none;border:0;
}
.scrubber .thumb:active{cursor:grabbing}
.scrubber .thumb:focus-visible{box-shadow:0 0 0 3px rgba(96,165,250,.55)}

/* Card */
.movie{width:176px;flex:0 0 auto;cursor:pointer;perspective:700px;outline:none}
.movie:focus-visible{box-shadow:0 0 0 3px rgba(96,165,250,.55);border-radius:16px}
.poster{position:relative;height:0;padding-top:150%;border-radius:16px;overflow:hidden;background:#0e1426;border:1px solid rgba(255,255,255,.06);
  transform:perspective(700px) rotateX(var(--rx,0)) rotateY(var(--ry,0)); will-change:transform}
.poster img{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;display:block}
.shine::after{content:"";position:absolute;inset:-130% -50% auto auto;width:60%;height:220%;transform:rotate(25deg);opacity:0;
  background:linear-gradient(90deg,transparent,rgba(255,255,255,.18),transparent);transition:transform .4s ease,opacity .4s ease}
.movie:hover .shine::after{transform:translateX(-40%) rotate(25deg);opacity:.9}
.movie:hover .poster{transform:perspective(700px) rotateX(calc(var(--rx,0)*1.15)) rotateY(calc(var(--ry,0)*1.15)) translateZ(6px)}
.meta{position:absolute;left:8px;right:8px;bottom:8px;background:linear-gradient(180deg,transparent,rgba(0,0,0,.85));border-radius:12px;padding:46% 8px 8px}
.tl{font-size:13px;font-weight:800;line-height:1.3;margin-bottom:6px}
.pills{display:flex;gap:6px;flex-wrap:wrap}
.pill{font-size:11px;padding:3px 6px;border-radius:999px;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.1)}

/* Rankings */
.rank-wrap{display:grid;grid-template-columns:1fr;gap:12px}
@media(min-width:900px){.rank-wrap{grid-template-columns:1fr 1fr}}
.rank{border:1px solid rgba(255,255,255,.08);background:rgba(255,255,255,.03);border-radius:16px;padding:14px}
.rank h3{margin:0 0 10px;font-size:18px}
.rank ul{list-style:none;margin:0;padding:0;display:grid;gap:10px}
.rank li{display:grid;grid-template-columns:auto auto 1fr;gap:10px;align-items:center;padding:6px;border-radius:10px;cursor:pointer}
.rank li:hover{background:rgba(255,255,255,.04)}
.rank .no{width:28px;height:28px;border-radius:8px;background:#1b233d;display:grid;place-items:center;font-weight:800;color:#9fb3ff}
.rank img{width:38px;height:54px;border-radius:8px;object-fit:cover;border:1px solid rgba(255,255,255,.06)}

/* Grid Explore/Search */
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:14px}
#explore{padding-bottom:22px}

/* Skeleton & toast */
.skeleton{position:relative;overflow:hidden;background:#0f162b;border-radius:16px;height:0;padding-top:150%}
.skeleton::after{content:"";position:absolute;inset:0;background:linear-gradient(90deg,transparent,rgba(255,255,255,.08),transparent);transform:translateX(-100%);animation:sh 1.4s infinite}
@keyframes sh{to{transform:translateX(100%)}}
.toast{position:fixed;left:50%;transform:translateX(-50%);bottom:22px;background:#0b1220;border:1px solid #22304c;color:#fff;padding:10px 14px;border-radius:10px;box-shadow:0 10px 24px rgba(0,0,0,.35);z-index:99999}

/* Popup */
.popup{position:fixed;inset:0;display:none;justify-content:center;align-items:flex-start;background:rgba(0,0,0,.9);z-index:9990;overflow:auto;padding:30px 12px}
.popup-content{width:100%;max-width:1180px;display:flex;flex-direction:column;gap:12px}
.player{position:relative;width:100%;aspect-ratio:16/9;background:#000;border-radius:12px;overflow:hidden;border:1px solid rgba(255,255,255,.06)}
.player video,.player iframe{width:100%;height:100%;border:0;display:block}
.player .loading{
  position:absolute;inset:0;display:none;place-items:center;background:rgba(0,0,0,.18);backdrop-filter:blur(1px)
}
.player .loading::after{
  content:"";width:38px;height:38px;border-radius:50%;
  border:4px solid rgba(255,255,255,.25);border-top-color:#fff;animation:spin 1s linear infinite
}
@keyframes spin{to{transform:rotate(360deg)}}

.pb{display:flex;gap:18px;flex-wrap:wrap;padding:8px}
.pi{flex:1;min-width:260px}
.pi h3{margin:0 0 6px;font-size:24px;font-family:"Cinzel",serif}
.pi .m{color:var(--muted);font-size:14px;line-height:1.5}
.desc{color:#e6e6f0;margin-top:10px;font-size:15px;line-height:1.6;max-height:110px;overflow:hidden;transition:max-height .25s ease}
.desc.exp{max-height:640px}
.toggle{margin-top:10px;padding:8px 12px;background:#1d2542;border-radius:8px;border:1px solid rgba(255,255,255,.08);cursor:pointer}
.eps{margin-top:12px;display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:8px}
.eps button{padding:8px;background:#151c36;border:1px solid rgba(255,255,255,.08);color:white;border-radius:8px;cursor:pointer;font-weight:800}
.eps button.sel{outline:2px solid #60a5fa;background:#0b1430}

/* Close button */
.close{
  position:fixed;right:16px;top:16px;width:42px;height:42px;
  display:grid;place-items:center;border-radius:50%;
  background:rgba(15,23,42,.75);color:#fff;font-size:22px;
  border:1px solid rgba(255,255,255,.2);backdrop-filter:blur(6px);
  cursor:pointer;z-index:10000;user-select:none
}
.close:hover{transform:scale(1.04)}

/* Detail header */
.detail-hero{border:1px solid rgba(255,255,255,.06);border-radius:14px;overflow:hidden;background:#0b1220;position:relative}
.detail-hero .bg{position:absolute;inset:0;background-size:cover;background-position:center;filter:blur(16px) saturate(1.1);opacity:.35;transform:scale(1.08)}
.detail-hero .overlay{position:absolute;inset:0;background:linear-gradient(90deg,rgba(8,12,28,.92),rgba(8,12,28,.72),rgba(8,12,28,.2))}
.detail-hero .inner{position:relative;display:flex;gap:16px;padding:16px;align-items:center}
.detail-hero img{width:140px;height:210px;object-fit:cover;border-radius:12px;border:1px solid rgba(255,255,255,.06)}
.detail-title{margin:0 0 6px;font-size:22px;font-weight:800}
.detail-meta{color:#b7c0d4;font-size:14px;line-height:1.5}
.cta{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}

/* Toolbar for player */
.toolbar{
  display:flex;gap:8px;flex-wrap:wrap;align-items:center;
  background:#0f172a;border:1px solid rgba(255,255,255,.08);
  padding:8px 10px;border-radius:10px
}
.toolbar select,.toolbar label,.toolbar button{font:inherit}
.sel{background:#0b1430}
.toolbar select{
  background:#0b1430;border:1px solid rgba(255,255,255,.12);color:#e5e7eb;border-radius:8px;
  padding:8px 10px;min-width:120px
}
.toolbar .sep{width:1px;height:24px;background:rgba(255,255,255,.1);margin:0 4px}

footer{background:var(--panel);color:var(--muted);padding:24px 12px;border-top:1px solid rgba(255,255,255,.08);margin-top:36px;text-align:center}
footer .footer-content{max-width:900px;margin:0 auto}
footer a{color:#93c5fd}

@media(max-width:640px){
  .movie{width:44.5vw;max-width:200px}
  .hero__poster{display:none}
  .detail-hero img{display:none}
}
</style>
</head>
<body>

<header class="hdr">
  <div class="hdr__row container">
    <div class="brand">
      <div id="homeBtn" class="brand__t" title="V·ªÅ Trang ch·ªß">üè† THANHPHAT</div>
    </div>
    <nav class="tabs" id="tabs" aria-label="ƒêi·ªÅu h∆∞·ªõng">
      <button class="tab active" data-view="home">Trang ch·ªß</button>
      <button class="tab" data-type="phim-le" data-view="explore">Phim l·∫ª</button>
      <button class="tab" data-type="phim-bo" data-view="explore">Phim b·ªô</button>
      <button class="tab" data-type="tv-shows" data-view="explore">TV Shows</button>
      <button class="tab" data-type="hoat-hinh" data-view="explore">Ho·∫°t h√¨nh</button>
      <button class="tab" data-view="fav">Y√™u th√≠ch</button>
      <button class="tab" data-view="his">L·ªãch s·ª≠</button>
    </nav>
    <div class="search" role="search">
      <input id="q" placeholder="T√¨m phim... (·∫•n / ƒë·ªÉ focus)" aria-label="T√¨m phim">
      <button id="btnSearch" class="btn btn-pill">T√¨m</button>
    </div>
  </div>
</header>

<!-- HOME -->
<section id="home" class="container">
  <div class="hero">
    <div class="hero__card">
      <div id="heroBg" class="hero__bg" aria-hidden="true"></div>
      <div class="hero__overlay"></div>
      <div class="hero__body">
        <div class="hero__poster"><img id="heroPoster" src="" alt="" loading="lazy" decoding="async" referrerpolicy="no-referrer"></div>
        <div>
          <h1 id="heroTitle">ƒêang t·∫£i...</h1>
          <div class="badges" id="heroBadges"></div>
          <div id="heroDesc" class="desc"></div>
          <div style="margin-top:10px;display:flex;gap:8px">
            <button id="heroPlay" class="btn btn-pill">Xem ngay</button>
            <button id="heroSave" class="btn btn-pill btn-ghost">+ L∆∞u</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Chips -->
  <div class="chips">
    <button class="chip" data-key="Marvel">Marvel</button>
    <button class="chip" data-key="4K">4K</button>
    <button class="chip" data-key="Sitcom">Sitcom</button>
    <button class="chip" data-key="H√†i">H√†i</button>
    <button class="chip" data-key="Kinh d·ªã">Kinh d·ªã</button>
    <button class="chip" data-key="T√¢m l√Ω">T√¢m l√Ω</button>
  </div>

  <!-- Rows -->
  <div class="sec"><h2>Phim H√†n Qu·ªëc m·ªõi</h2><a class="chip" data-go="quocgia-hq">Xem th√™m ‚Ä∫</a></div>
  <div class="row"><div id="row-hq" class="movie-row"></div></div>

  <div class="sec"><h2>Phim Trung Qu·ªëc m·ªõi</h2><a class="chip" data-go="quocgia-tq">Xem th√™m ‚Ä∫</a></div>
  <div class="row"><div id="row-tq" class="movie-row"></div></div>

  <div class="sec"><h2>Phim US-UK m·ªõi</h2><a class="chip" data-go="quocgia-usuk">Xem th√™m ‚Ä∫</a></div>
  <div class="row"><div id="row-usuk" class="movie-row"></div></div>

  <div class="sec"><h2>üî• Phim Hot</h2></div>
  <div class="row"><div id="row-hot" class="movie-row"></div></div>

  <!-- Rankings -->
  <div class="sec"><h2>B·∫£ng x·∫øp h·∫°ng h√¥m nay</h2></div>
  <div class="rank-wrap">
    <div class="rank">
      <h3>üé¨ S√¥i n·ªïi nh·∫•t</h3>
      <ul id="rank-trend"></ul>
    </div>
    <div class="rank">
      <h3>üíõ Y√™u th√≠ch nh·∫•t</h3>
      <ul id="rank-fav"></ul>
    </div>
  </div>

  <div class="sec"><h2>üéûÔ∏è Phim b·ªô</h2></div>
  <div class="row"><div id="row-bo" class="movie-row"></div></div>

  <div class="sec"><h2>üé¨ Phim l·∫ª</h2></div>
  <div class="row"><div id="row-le" class="movie-row"></div></div>
</section>

<!-- EXPLORE -->
<section id="explore" class="container" style="display:none">
  <div class="sec"><h2 id="exploreTitle">Kh√°m ph√°</h2></div>
  <div id="grid" class="grid"></div>
  <div id="sentinel" style="height:1px"></div>
</section>

<!-- FAV / HISTORY -->
<section id="fav" class="container" style="display:none">
  <div class="sec"><h2>üìå Y√™u th√≠ch</h2></div>
  <div id="favGrid" class="grid"></div>
</section>
<section id="his" class="container" style="display:none">
  <div class="sec"><h2>üïò L·ªãch s·ª≠</h2></div>
  <div id="hisGrid" class="grid"></div>
</section>

<!-- POPUP -->
<div id="popup" class="popup" role="dialog" aria-modal="true">
  <span class="close" id="close" title="ƒê√≥ng (Esc)">‚úï</span>

  <div class="popup-content">
    <!-- header detail + CTA -->
    <div class="detail-hero">
      <div class="bg" id="dBg"></div>
      <div class="overlay"></div>
      <div class="inner">
        <img id="dPoster" src="" alt="Poster" loading="lazy" decoding="async" referrerpolicy="no-referrer">
        <div class="pi">
          <h2 class="detail-title" id="dTitle">...</h2>
          <div class="detail-meta" id="dMeta">...</div>
          <div class="cta">
            <button id="btnPlayNow" class="btn">Xem ngay</button>
            <button id="btnFav" class="btn btn-ghost">+ L∆∞u</button>
            <button id="btnShare" class="btn btn-ghost">Chia s·∫ª</button>
            <button id="btnReport" class="btn btn-ghost">B√°o l·ªói</button>
          </div>
        </div>
      </div>
    </div>

    <!-- toolbar -->
    <div class="toolbar" id="playerToolbar" style="display:none">
      <label>Ch·∫•t l∆∞·ª£ng
        <select id="qualitySelect" aria-label="Ch·ªçn ch·∫•t l∆∞·ª£ng">
          <option value="auto">Auto</option>
        </select>
      </label>
      <div class="sep"></div>
      <label>T·ªëc ƒë·ªô
        <select id="speedSelect" aria-label="T·ªëc ƒë·ªô">
          <option>0.75</option><option selected>1.0</option>
          <option>1.25</option><option>1.5</option><option>1.75</option><option>2.0</option>
        </select>
      </label>
      <div class="sep"></div>
      <label style="display:flex;align-items:center;gap:6px">
        <input type="checkbox" id="autoNext" checked> T·ª± chuy·ªÉn t·∫≠p
      </label>
      <div style="flex:1"></div>
      <button id="btnReload" class="btn btn-ghost" title="T·∫£i l·∫°i ngu·ªìn">‚Üª</button>
      <button id="btnPiP" class="btn btn-ghost" title="Picture-in-Picture">PiP</button>
      <button id="btnFS" class="btn btn-ghost" title="To√†n m√†n h√¨nh">‚§¢</button>
    </div>

    <!-- player -->
    <div id="player" class="player">
      <div class="loading" id="loading"></div>
    </div>

    <!-- m√¥ t·∫£ + eps -->
    <div class="pb">
      <div class="pi">
        <h4>Gi·ªõi thi·ªáu</h4>
        <div id="pDesc" class="desc"></div>
        <button id="pToggle" class="toggle" style="display:none">Xem th√™m ‚ñº</button>

        <h4 style="margin-top:14px">Danh s√°ch t·∫≠p</h4>
        <div id="eps" class="eps"></div>
      </div>
    </div>
  </div>
</div>

<footer>
  <div class="footer-content">
    <p>THANHPHAT t·ªïng h·ª£p d·ªØ li·ªáu phim t·ª´ Internet / phimapi.com. Ch√∫ng t√¥i kh√¥ng l∆∞u tr·ªØ video.</p>
    <p>¬© 2025 THANHPHAT</p>
  </div>
</footer>

<script>
/* =============== Helpers & API =============== */
const API_BASE='https://phimapi.com';
const API_V1=API_BASE+'/v1/api';
const $=s=>document.querySelector(s);const $$=s=>document.querySelectorAll(s);
const toast=(m,t=1800)=>{const d=document.createElement('div');d.className='toast';d.textContent=m;document.body.appendChild(d);setTimeout(()=>d.remove(),t)};

/* ·∫¢nh: chu·∫©n ho√° + chu·ªói d·ª± ph√≤ng */
function absUrl(p,cdn='https://phimimg.com'){
  if(!p) return '';
  if(/^https?:\/\//i.test(p)) return p;
  if(p.startsWith('//')) return (location.protocol||'https:')+p;
  if(p.startsWith('/upload/')) return cdn.replace(/\/+$/,'')+p;
  return cdn.replace(/\/+$/,'')+'/'+p.replace(/^\/+/,'');
}
function weserv(u){try{const x=new URL(u);return 'https://images.weserv.nl/?url='+encodeURIComponent(x.host+x.pathname+(x.search||''))}catch{return''}}
function ph(t){
  const s=(t||'Poster').replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
  return 'data:image/svg+xml;utf8,'+encodeURIComponent(
`<svg xmlns='http://www.w3.org/2000/svg' width='480' height='720'>
  <defs><linearGradient id='g' x1='0' y1='0' x2='1' y2='1'><stop stop-color='#0b1020'/><stop offset='1' stop-color='#111827'/></linearGradient></defs>
  <rect width='100%' height='100%' fill='url(#g)'/>
  <g fill='#9ca3af' transform='translate(240,280)'><circle r='38'/><rect x='-60' y='50' width='120' height='6' rx='3'/></g>
  <text x='50%' y='92%' font-size='26' fill='#9ca3af' text-anchor='middle' font-family='system-ui,Segoe UI,Roboto,sans-serif'>${s}</text>
</svg>`);
}
function imgChain(raw,cdn){
  const a=absUrl(raw,cdn); if(!a) return [ph('Poster')];
  const httpsFix=(location.protocol==='https:'&&/^http:\/\//i.test(a))?a.replace(/^http:/,'https:'):'';
  const ws=weserv(a);
  const list=[ws,httpsFix,a].filter(Boolean);
  list.push(ph('Poster'));
  return [...new Set(list)];
}
function onImgError(img){
  const l=(img.dataset.f||'').split('|').filter(Boolean);
  let i=+img.dataset.i||0;
  if(i<l.length-1){ img.dataset.i=++i; img.src=l[i]; }
  else { img.onerror=null; img.src=l[l.length-1]; }
}
window.onImgError=onImgError;

/* Fetch c√≥ cache nh·∫π */
const memCache=new Map();
async function fetchJSON(u,t=12000){
  if(memCache.has(u)) return memCache.get(u);
  const c=new AbortController(); const k=setTimeout(()=>c.abort(),t);
  try{
    const r=await fetch(u,{signal:c.signal,credentials:'omit',cache:'force-cache'});
    clearTimeout(k); if(!r.ok) throw new Error('HTTP '+r.status);
    const j=await r.json(); memCache.set(u,j); return j;
  }catch(e){ clearTimeout(k); throw e; }
}
function normList(raw){
  let it=[],cp=1,tp=1,cdn='https://phimimg.com';
  if(raw?.data?.items){
    it=raw.data.items; const p=raw.data.params?.pagination||{};
    cp=p.currentPage||p.current_page||1; tp=p.totalPages||p.total_pages||1;
    cdn=raw.data.APP_DOMAIN_CDN_IMAGE||cdn;
  }else{
    it=raw.items||[]; cp=raw.pagination?.currentPage||1; tp=raw.pagination?.totalPages||1;
    cdn=raw.APP_DOMAIN_CDN_IMAGE||cdn;
  }
  return {items:it,cp,tp,cdn};
}

/* =============== UI building =============== */
function card(movie, cdn){
  const t=movie.name||movie.origin_name||'Kh√¥ng t√™n';
  const srcs=imgChain(movie.poster_url||movie.thumb_url||movie.poster||movie.image||'',cdn);
  const div=document.createElement('div');
  div.className='movie';
  div.dataset.slug=movie.slug||'';
  div.setAttribute('tabindex','0');
  div.setAttribute('role','button');
  div.setAttribute('aria-label',`Xem chi ti·∫øt ${t}`);
  div.innerHTML=`<div class="poster shine">
      <img src="${srcs[0]}" alt="${t.replace(/"/g,'&quot;')}" loading="lazy" decoding="async" referrerpolicy="no-referrer"
           data-f="${srcs.join('|')}" data-i="0" onerror="onImgError(this)">
      <div class="meta">
        <div class="tl">${t}</div>
        <div class="pills">
          ${movie.year?`<span class="pill">${movie.year}</span>`:''}
          ${movie.lang?`<span class="pill">${movie.lang}</span>`:''}
          ${movie.quality?`<span class="pill">${movie.quality}</span>`:''}
        </div>
      </div>
    </div>`;

  /* Tilt (throttle b·∫±ng rAF ƒë·ªÉ m∆∞·ª£t) */
  const pEl=()=>div.querySelector('.poster');
  let raf=0, lastX=0, lastY=0;
  div.addEventListener('pointermove',e=>{
    lastX=e.clientX; lastY=e.clientY;
    if(raf) return;
    raf=requestAnimationFrame(()=>{
      const r=pEl().getBoundingClientRect();
      const x=(lastX-r.left)/r.width, y=(lastY-r.top)/r.height;
      pEl().style.setProperty('--rx',((.5-y)*10)+'deg');
      pEl().style.setProperty('--ry',((x-.5)*10)+'deg');
      raf=0;
    });
  },{passive:true});
  div.addEventListener('pointerleave',()=>{const p=pEl();p.style.setProperty('--rx','0deg');p.style.setProperty('--ry','0deg')});

  /* Click m·ªü chi ti·∫øt ‚Äì nh∆∞ng b·ªè qua n·∫øu v·ª´a k√©o h√†ng ngang */
  const go=()=>{ if(div.closest('.movie-row')?.dataset.dragging==='1') return; openDetail(movie.slug); };
  div.addEventListener('click',go);
  div.addEventListener('keydown',(e)=>{if(e.key==='Enter' || e.key===' '){e.preventDefault();go()}});

  return div;
}
function fillRow(containerId, items, cdn){
  const el=document.getElementById(containerId); el.innerHTML='';
  items.forEach(m=>el.appendChild(card(m,cdn)));
}
function skeletonRow(containerId,n=10){
  const el=document.getElementById(containerId); el.innerHTML='';
  for(let i=0;i<n;i++){const d=document.createElement('div');d.className='movie';d.innerHTML='<div class="skeleton"></div>';el.appendChild(d)}
}

/* BXH */
function renderRank(listEl, items, cdn){
  listEl.innerHTML='';
  items.slice(0,5).forEach((m,i)=>{
    const img=imgChain(m.poster_url||m.thumb_url||'',cdn)[0];
    const li=document.createElement('li');
    li.innerHTML=`
      <div class="no">${i+1}</div>
      <img src="${img}" alt="" loading="lazy" decoding="async" referrerpolicy="no-referrer">
      <div>
        <div style="font-weight:800">${m.name||m.origin_name||''}</div>
        <div style="color:#9aa4b5;font-size:13px">${m.origin_name?m.origin_name:''}${m.year?` ‚Ä¢ ${m.year}`:''}</div>
      </div>`;
    li.onclick=()=>openDetail(m.slug);
    listEl.appendChild(li);
  });
}

/* =============== Home data =============== */
async function loadHome(){
  try{
    ['row-hot','row-hq','row-tq','row-usuk','row-bo','row-le'].forEach(id=>skeletonRow(id));
    const urls=[`${API_BASE}/danh-sach/phim-moi-cap-nhat-v3?page=1`,`${API_BASE}/danh-sach/phim-moi-cap-nhat-v2?page=1`,`${API_BASE}/danh-sach/phim-moi-cap-nhat?page=1`];
    let hot=null; for(const u of urls){ try{ hot=normList(await fetchJSON(u)); break; }catch{} }
    if(hot){ fillRow('row-hot', hot.items.slice(0,12), hot.cdn); buildHero(hot.items[0],hot.cdn); }

    // Qu·ªëc gia
    loadBy(`${API_V1}/quoc-gia/han-quoc?page=1&limit=36`,'row-hq');
    loadBy(`${API_V1}/quoc-gia/trung-quoc?page=1&limit=36`,'row-tq');
    loadBy(`${API_V1}/quoc-gia/au-my?page=1&limit=36`,'row-usuk');

    // Danh s√°ch
    loadBy(`${API_V1}/danh-sach/phim-bo?page=1&limit=36`,'row-bo');
    loadBy(`${API_V1}/danh-sach/phim-le?page=1&limit=36`,'row-le');

    // BXH
    (async()=>{
      try{
        const t=normList(await fetchJSON(`${API_V1}/danh-sach/phim-bo?page=1&limit=36`));
        renderRank($('#rank-trend'), t.items, t.cdn);
      }catch{}
      try{
        const f=favList();
        if(f && f.length){
          renderRank($('#rank-fav'), f.map(x=>({slug:x.slug,name:x.name,origin_name:x.name,poster_url:x.poster,year:x.year})), 'https://phimimg.com');
        }else if(hot){ renderRank($('#rank-fav'), hot.items, hot.cdn); }
      }catch{}
    })();

    setupRows();
  }catch(e){ toast('L·ªói t·∫£i trang ch·ªß'); }
}
async function loadBy(url, cid){ try{const d=normList(await fetchJSON(url)); fillRow(cid,d.items,d.cdn);}catch{} }
function buildHero(m,cdn){
  if(!m) return;
  const poster=imgChain(m.poster_url||m.thumb_url||'',cdn)[0];
  $('#heroPoster').src=poster; $('#heroBg').style.backgroundImage=`url('${poster}')`;
  $('#heroTitle').textContent=m.name||m.origin_name||'';
  const b=[]; if(m.year)b.push(`<span class="badge">${m.year}</span>`); if(m.lang)b.push(`<span class="badge">${m.lang}</span>`); if(m.quality)b.push(`<span class="badge">${m.quality}</span>`);
  $('#heroBadges').innerHTML=b.join('');
  $('#heroDesc').textContent=m.content || m.description || '...';
  $('#heroPlay').onclick=()=>openDetail(m.slug);
  $('#heroSave').onclick=()=>toggleFav(m);
}

/* =============== Explore/Search =============== */
let explorePage=1, exploreType='phim-le', exploreKey='', exploreTotal=1, exploreCDN='https://phimimg.com';
function setView(id){
  ['home','explore','fav','his'].forEach(v=>document.getElementById(v).style.display=(v===id)?'block':'none');
  requestAnimationFrame(()=>window.scrollTo({top:0,behavior:'auto'}));
}
function setActiveTabByView(view){
  $$('#tabs .tab').forEach(x=>{
    const is = (x.dataset.view===view) || (view==='explore' && x.dataset.view==='explore' && x.dataset.type===exploreType);
    x.classList.toggle('active',is);
  });
}
$('#tabs').addEventListener('click',e=>{
  const t=e.target.closest('.tab'); if(!t) return;
  $$('#tabs .tab').forEach(x=>x.classList.remove('active')); t.classList.add('active');
  const view=t.dataset.view;
  if(view==='home'){ closePopup(); setView('home'); history.replaceState('',document.title,location.pathname); return; }
  if(view==='explore'){ exploreType=t.dataset.type; startExplore(exploreType,'Kh√°m ph√°: '+t.textContent); return; }
  if(view==='fav'){ renderFav(); setView('fav'); return; }
  if(view==='his'){ renderHistory(); setView('his'); return; }
});
document.getElementById('homeBtn').addEventListener('click',()=>{
  setView('home'); setActiveTabByView('home'); closePopup();
  history.replaceState('',document.title,location.pathname);
});
document.querySelectorAll('.chip[data-go]').forEach(c=>{
  c.onclick=()=>{
    const v=c.dataset.go;
    if(v==='quocgia-hq') startExplore('han-quoc','Kh√°m ph√°: H√†n Qu·ªëc');
    else if(v==='quocgia-tq') startExplore('trung-quoc','Kh√°m ph√°: Trung Qu·ªëc');
    else if(v==='quocgia-usuk') startExplore('au-my','Kh√°m ph√°: US-UK');
  };
});
document.querySelectorAll('.chip[data-key]').forEach(c=>c.onclick=()=>{const k=c.dataset.key;startExplore(k,`K·∫øt qu·∫£: ‚Äú${k}‚Äù`);location.hash='#search='+encodeURIComponent(k)});

function exploreUrl(page){
  if(exploreKey){
    const p=new URLSearchParams({keyword:exploreKey,page,limit:36});
    return `${API_V1}/tim-kiem?${p}`;
  }
  if(['han-quoc','trung-quoc','au-my','nhat-ban','viet-nam'].includes(exploreType)){
    return `${API_V1}/quoc-gia/${exploreType}?page=${page}&limit=36`;
  }
  return `${API_V1}/danh-sach/${exploreType}?page=${page}&limit=36`;
}
async function startExplore(typeOrKey, title){
  setView('explore'); $('#grid').innerHTML=''; $('#exploreTitle').textContent=title||'Kh√°m ph√°';
  explorePage=1; exploreTotal=2; exploreCDN='https://phimimg.com'; exploreKey=''; exploreType='phim-le';
  if(typeof typeOrKey==='string'){
    if(['phim-le','phim-bo','tv-shows','hoat-hinh'].includes(typeOrKey)) exploreType=typeOrKey;
    else if(['han-quoc','trung-quoc','au-my','nhat-ban','viet-nam'].includes(typeOrKey)) exploreType=typeOrKey;
    else exploreKey=typeOrKey;
  }
  setActiveTabByView('explore');
  for(let i=0;i<12;i++){const d=document.createElement('div');d.className='skeleton';$('#grid').appendChild(d)}
  await loadMoreExplore();
}
async function loadMoreExplore(){
  if(explorePage>exploreTotal) return;
  try{
    const d=normList(await fetchJSON(exploreUrl(explorePage)));
    exploreCDN=d.cdn; exploreTotal=d.tp;
    const grid=$('#grid'); if(explorePage===1) grid.innerHTML='';
    d.items.forEach(m=>grid.appendChild(card(m,exploreCDN)));
    explorePage++;
  }catch{}
}
const io=new IntersectionObserver(es=>{es.forEach(e=>{if(e.isIntersecting) loadMoreExplore()})},{rootMargin:'1200px'}); io.observe($('#sentinel'));

/* Search */
const debounce=(fn,ms=350)=>{let t;return(...a)=>{clearTimeout(t);t=setTimeout(()=>fn(...a),ms)}}
const doSearch=()=>{const k=$('#q').value.trim();if(!k)return toast('Nh·∫≠p t·ª´ kho√°');startExplore(k,`K·∫øt qu·∫£: ‚Äú${k}‚Äù`);location.hash='#search='+encodeURIComponent(k)}
$('#btnSearch').addEventListener('click',doSearch);
$('#q').addEventListener('input',debounce(()=>{const v=$('#q').value.trim();if(v.length>2) startExplore(v,`K·∫øt qu·∫£: ‚Äú${v}‚Äù`)},600));
$('#q').addEventListener('keypress',e=>{if(e.key==='Enter') doSearch()});
document.addEventListener('keydown',e=>{if(e.key==='/'&&document.activeElement!==$('#q')){e.preventDefault();$('#q').focus()}},{passive:true});

/* =============== Detail & Player (HLS Pro) =============== */
let hls=null, currentMovie=null, currentEp=null, currentEps=[];
const LS={vol:'tp_vol',rate:'tp_rate',ql:'tp_ql_height',autonext:'tp_autonext'};

function loadHlsLib(cb){
  if(window.Hls){ cb(); return; }
  const s=document.createElement('script');
  s.src='https://cdn.jsdelivr.net/npm/hls.js@latest';
  s.onload=cb; document.head.appendChild(s);
}

async function openDetail(slug){
  if(!slug) return;
  try{
    const d=await fetchJSON(`${API_BASE}/phim/${slug}`);
    if(!d?.status) return toast('Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu');
    const m=d.movie||{}; currentMovie=m; location.hash='#/p/'+slug;
    const cdn=d.APP_DOMAIN_CDN_IMAGE||'https://phimimg.com';
    const poster=imgChain(m.poster_url||m.thumb_url||'',cdn)[0];

    $('#dPoster').src=poster;
    $('#dBg').style.backgroundImage=`url('${poster}')`;
    $('#dTitle').textContent=`${m.name||m.origin_name||''} ${m.year?`(${m.year})`:''}`;
    $('#dMeta').innerHTML=`‚è≥ ${m.time||'N/A'} ‚Ä¢ ${m.quality||'N/A'} ‚Ä¢ ${(m.country||[]).map(x=>x.name).join(', ')||'Kh√¥ng r√µ'}`;

    // desc
    const desc=m.content||'Kh√¥ng c√≥ m√¥ t·∫£'; const el=$('#pDesc'); el.textContent=desc; const tg=$('#pToggle');
    if(desc.length>220){tg.style.display='inline-block';tg.textContent='Xem th√™m ‚ñº';tg.onclick=()=>{const ex=el.classList.toggle('exp');tg.textContent=ex?'Thu g·ªçn':'Xem th√™m ‚ñº'} } else tg.style.display='none';

    // episodes
    currentEps=(d.episodes||[]).flatMap(sv=>(sv.server_data||[]).map((ep,i)=>({name:ep.name||`T·∫≠p ${i+1}`,embed:ep.link_embed,m3u8:ep.link_m3u8})));
    const wrap=$('#eps'); wrap.innerHTML=''; currentEp=null;
    currentEps.forEach((ep,idx)=>{const b=document.createElement('button');b.textContent=ep.name; b.onclick=()=>selectEp(ep,b); if(idx===0){b.classList.add('sel');currentEp=ep;} wrap.appendChild(b)});

    // CTA & toolbar
    $('#btnPlayNow').textContent=currentEp?`Xem ngay (${currentEp.name})`:'Xem ngay';
    $('#btnPlayNow').onclick=()=>{ if(currentEp) play(currentEp); else toast('Ch∆∞a c√≥ t·∫≠p'); };
    $('#btnFav').onclick=()=>toggleFav(m);
    $('#btnShare').onclick=()=>{navigator.clipboard?.writeText(location.href); toast('ƒê√£ sao ch√©p link')};
    $('#btnReport').onclick=()=>{prompt('M√¥ t·∫£ l·ªói ph√°t (copy link n√†y g·ª≠i cho admin):', location.href)};
    $('#playerToolbar').style.display='flex';

    // restore settings
    $('#autoNext').checked = JSON.parse(localStorage.getItem(LS.autonext) || 'true');

    openPopup(); cleanup(); // ch∆∞a ph√°t cho t·ªõi khi b·∫•m
    addHistory(m);
  }catch{toast('L·ªói t·∫£i chi ti·∫øt')}
}
function selectEp(ep, btn){
  currentEp=ep;
  $$('#eps button').forEach(x=>x.classList.remove('sel'));
  btn.classList.add('sel');
  $('#btnPlayNow').textContent=`Xem ngay (${ep.name})`;
}
function openPopup(){ $('#popup').style.display='flex'; window.scrollTo({top:0,behavior:'smooth'}) }
function closePopup(){
  cleanup();
  $('#popup').style.display='none';
  if(location.hash.startsWith('#/p/')) history.pushState('',document.title,window.location.pathname+window.location.search);
}
$('#close').onclick=closePopup;
document.addEventListener('keydown',e=>{ if(e.key==='Escape' && $('#popup').style.display==='flex') closePopup() });
$('#popup').addEventListener('click',e=>{ if(e.target===e.currentTarget) closePopup() });

function cleanup(){ if(hls){try{hls.destroy()}catch{} hls=null} $('#player').innerHTML='<div class="loading" id="loading"></div>'; }

function createVideo(){
  const v=document.createElement('video'); v.controls=true; v.autoplay=true; v.playsInline=true; v.crossOrigin='anonymous';
  const vol=parseFloat(localStorage.getItem(LS.vol)||'0.9'); v.volume=isFinite(vol)?vol:0.9;
  const rate=parseFloat(localStorage.getItem(LS.rate)||'1'); v.playbackRate=isFinite(rate)?rate:1;
  v.addEventListener('volumechange',()=>localStorage.setItem(LS.vol, v.volume));
  v.addEventListener('ratechange',()=>localStorage.setItem(LS.rate, v.playbackRate));
  v.addEventListener('waiting',()=>$('#loading').style.display='grid');
  v.addEventListener('playing',()=>$('#loading').style.display='none');
  v.addEventListener('ended',()=>{ if($('#autoNext').checked){ const idx=currentEps.findIndex(x=>x===currentEp); const n=currentEps[idx+1]; if(n){ selectEp(n,$$('#eps button')[idx+1]); play(n); } } });
  return v;
}
function buildQualityMenu(levels){
  const sel=$('#qualitySelect'); sel.innerHTML='<option value="auto">Auto</option>';
  levels.forEach((lv,i)=>{ const opt=document.createElement('option'); opt.value=String(lv.height||i); opt.text=`${lv.height?lv.height+'p':''}${lv.name?(' '+lv.name):''}${lv.bitrate?(' ‚Ä¢ '+Math.round(lv.bitrate/1000)+'kbps'):''}`.trim()||`Level ${i}`; sel.appendChild(opt); });
}
function applyQualityPreference(levels){
  const pref=localStorage.getItem(LS.ql);
  if(!hls) return;
  if(!pref || pref==='auto'){ hls.currentLevel=-1; $('#qualitySelect').value='auto'; return; }
  const idx=levels.findIndex(l=>String(l.height)===pref);
  if(idx>=0){ hls.currentLevel=idx; $('#qualitySelect').value=String(levels[idx].height); }
  else { hls.currentLevel=-1; $('#qualitySelect').value='auto'; }
}
function attachToolbar(videoEl){
  $('#btnFS').onclick=()=>{ const c=$('#player'); if(document.fullscreenElement){document.exitFullscreen()} else { (c.requestFullscreen||c.webkitRequestFullscreen||(()=>{})).call(c) } };
  $('#btnPiP').onclick=async()=>{ try{ if(document.pictureInPictureElement){document.exitPictureInPicture()} else if(document.pictureInPictureEnabled){ await videoEl.requestPictureInPicture() } }catch{} };
  $('#btnReload').onclick=()=>{ if(currentEp) play(currentEp) };
  $('#speedSelect').onchange=()=>{ videoEl.playbackRate=parseFloat($('#speedSelect').value) };
  $('#autoNext').onchange=()=>localStorage.setItem(LS.autonext, JSON.stringify($('#autoNext').checked));
}

function play(ep){
  cleanup();
  const container=$('#player');
  const video=createVideo(); container.appendChild(video);
  attachToolbar(video);

  if('mediaSession' in navigator){
    try{
      navigator.mediaSession.metadata=new MediaMetadata({title:$('#dTitle').textContent,artist:'THANHPHAT',artwork:[{src:$('#dPoster').src,sizes:'512x728',type:'image/jpeg'}]});
    }catch{}
  }

  if(ep.m3u8 && ep.m3u8.endsWith('.m3u8')){
    loadHlsLib(()=>{
      if(window.Hls && window.Hls.isSupported()){
        hls=new Hls({
          enableWorker:true,lowLatencyMode:false,capLevelToPlayerSize:true,autoStartLoad:true,
          maxBufferLength:25,maxMaxBufferLength:60,backBufferLength:30,
          fragLoadingMaxRetry:2,manifestLoadingMaxRetry:2,levelLoadingMaxRetry:2
        });
        hls.attachMedia(video);
        hls.on(Hls.Events.MEDIA_ATTACHED,()=>{ hls.loadSource(ep.m3u8) });
        hls.on(Hls.Events.MANIFEST_PARSED,()=>{ buildQualityMenu(hls.levels||[]); applyQualityPreference(hls.levels||[]); $('#loading').style.display='none' });
        hls.on(Hls.Events.LEVEL_SWITCHED,(_,d)=>{ const lv=hls.levels?.[d.level]; if(lv?.height) localStorage.setItem(LS.ql,String(lv.height)); });
        hls.on(Hls.Events.ERROR,(_,data)=>{ if(data.fatal){ try{ hls.recoverMediaError() }catch(e){ if(ep.embed) playEmbed(ep.embed); else toast('Ngu·ªìn HLS l·ªói') } } });

        $('#qualitySelect').onchange=()=>{
          if(!hls) return;
          const v=$('#qualitySelect').value;
          if(v==='auto'){ hls.currentLevel=-1; localStorage.setItem(LS.ql,'auto'); }
          else{
            const idx=(hls.levels||[]).findIndex(l=>String(l.height)===v);
            if(idx>=0){ hls.currentLevel=idx; localStorage.setItem(LS.ql,v); }
          }
        };
      } else if(video.canPlayType('application/vnd.apple.mpegurl')){ // Safari
        video.src=ep.m3u8; $('#loading').style.display='none';
      } else { if(ep.embed) playEmbed(ep.embed); else toast('Thi·∫øt b·ªã kh√¥ng h·ªó tr·ª£ HLS'); }
    });
  }else if(ep.embed){ playEmbed(ep.embed) } else { toast('Kh√¥ng c√≥ ngu·ªìn ph√°t') }

  setTimeout(()=>container.scrollIntoView({behavior:'smooth',block:'center'}),80);
}
function playEmbed(u){
  $('#player').innerHTML=`<iframe src="${u}" allow="autoplay; encrypted-media; picture-in-picture" referrerpolicy="no-referrer" allowfullscreen></iframe>`;
}

/* =============== Fav & History =============== */
function lsGet(k,def){try{return JSON.parse(localStorage.getItem(k)||def)}catch{return JSON.parse(def)}}
function lsSet(k,v){localStorage.setItem(k, JSON.stringify(v))}
function favList(){return lsGet('fav','[]')}
function isFav(slug){return favList().some(x=>x.slug===slug)}
function toggleFav(m){
  let f=favList();
  if(isFav(m.slug)){ f=f.filter(x=>x.slug!==m.slug); toast('ƒê√£ xo√° kh·ªèi Y√™u th√≠ch'); }
  else { f.unshift({slug:m.slug,name:m.name||m.origin_name,poster:m.poster_url||m.thumb_url,year:m.year,lang:m.lang}); toast('ƒê√£ l∆∞u Y√™u th√≠ch'); }
  lsSet('fav',f); renderFav();
}
function renderFav(){
  const grid=$('#favGrid'); grid.innerHTML='';
  favList().forEach(x=>grid.appendChild(card(x,'https://phimimg.com')));
  if(!favList().length) grid.innerHTML='<p style="color:#9aa4b5">Ch∆∞a c√≥ m·ª•c y√™u th√≠ch n√†o.</p>';
}
function hisList(){return lsGet('his','[]')}
function addHistory(m){
  let h=hisList().filter(x=>x.slug!==m.slug);
  h.unshift({slug:m.slug,name:m.name||m.origin_name,poster:m.poster_url||m.thumb_url,year:m.year,lang:m.lang});
  h=h.slice(0,60); lsSet('his',h);
}
function renderHistory(){
  const grid=$('#hisGrid'); grid.innerHTML='';
  hisList().forEach(x=>grid.appendChild(card(x,'https://phimimg.com')));
  if(!hisList().length) grid.innerHTML='<p style="color:#9aa4b5">Ch∆∞a c√≥ l·ªãch s·ª≠ xem.</p>';
}

/* =============== Row Enhancer: drag + scrubber (kh√¥ng nu·ªët click) =============== */
function setupRows(){
  $$('.row').forEach(w=>{
    const row=w.querySelector('.movie-row');
    if(!row || w.dataset.enhanced) return; w.dataset.enhanced='1';

    // Drag to scroll: ƒë·∫∑t c·ªù data-dragging ƒë·ªÉ ch·∫∑n click c·ªßa card trong 1 nh·ªãp sau khi k√©o
    let isDown=false,startX=0,sl=0;
    row.addEventListener('pointerdown',e=>{isDown=true;startX=e.clientX;sl=row.scrollLeft;row.classList.add('grabbing'); row.dataset.dragging='0';},{passive:false});
    row.addEventListener('pointermove',e=>{
      if(!isDown) return;
      const dx=e.clientX-startX;
      if(Math.abs(dx)>6) row.dataset.dragging='1';
      row.scrollLeft=sl-dx;
      e.preventDefault();
    },{passive:false});
    const end=()=>{ if(!isDown) return; isDown=false; row.classList.remove('grabbing'); setTimeout(()=>{row.dataset.dragging='0'},80); };
    row.addEventListener('pointerup',end);
    row.addEventListener('pointercancel',end);
    row.addEventListener('pointerleave',end);

    // Wheel d·ªçc => cu·ªôn ngang
    row.addEventListener('wheel',e=>{ if(Math.abs(e.deltaY) > Math.abs(e.deltaX)){ row.scrollBy({left:e.deltaY,behavior:'auto'}); e.preventDefault(); } },{passive:false});

    // Scrubber k√©o ƒë∆∞·ª£c
    const sb=document.createElement('div'); sb.className='scrubber'; sb.innerHTML='<div class="track"></div><button class="thumb" role="slider" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0" aria-label="Cu·ªôn" tabindex="0"></button>';
    w.appendChild(sb); const track=sb.querySelector('.track'); const thumb=sb.querySelector('.thumb');

    const update=()=>{
      const max=row.scrollWidth-row.clientWidth; if(max<=0){ sb.style.display='none'; return; } sb.style.display='';
      const trackW=track.clientWidth; const viewRatio=row.clientWidth/row.scrollWidth;
      const thumbW=Math.max(28, Math.round(trackW*viewRatio)); thumb.style.width=thumbW+'px';
      const leftRatio = max>0 ? row.scrollLeft/max : 0;
      const left = Math.round((trackW-thumbW)*leftRatio);
      thumb.style.left=left+'px';
      thumb.setAttribute('aria-valuenow', Math.round(leftRatio*100));
    };
    const toScroll=(clientX)=>{
      const rect=track.getBoundingClientRect(); const trackW=rect.width; const thumbW=thumb.clientWidth;
      const x=Math.min(Math.max(0, clientX-rect.left - thumbW/2), trackW-thumbW);
      const ratio=(trackW-thumbW)>0 ? (x/(trackW-thumbW)) : 0;
      row.scrollLeft=ratio*(row.scrollWidth-row.clientWidth);
    };
    let dragging=false;
    thumb.addEventListener('pointerdown',e=>{dragging=true;thumb.setPointerCapture(e.pointerId)});
    thumb.addEventListener('pointermove',e=>{if(dragging) toScroll(e.clientX)});
    const endDrag=e=>{if(dragging){thumb.releasePointerCapture?.(e.pointerId)} dragging=false};
    thumb.addEventListener('pointerup',endDrag); thumb.addEventListener('pointercancel',endDrag);
    track.addEventListener('pointerdown',e=>{toScroll(e.clientX)});
    thumb.addEventListener('keydown',e=>{
      const step=row.clientWidth*0.9; if(e.key==='ArrowLeft'){row.scrollBy({left:-step,behavior:'smooth'})}
      if(e.key==='ArrowRight'){row.scrollBy({left:step,behavior:'smooth'})}
    });

    row.addEventListener('scroll',update,{passive:true});
    new ResizeObserver(update).observe(row);
    new ResizeObserver(update).observe(track);
    setTimeout(update,0);
  });
}

/* Routing (hash) */
window.addEventListener('hashchange',()=>{
  const h=location.hash;
  if(h.startsWith('#/p/')) openDetail(h.split('/p/')[1]);
  else if(h.startsWith('#search=')){ const kw=decodeURIComponent(h.split('=')[1]||''); $('#q').value=kw; startExplore(kw,`K·∫øt qu·∫£: ‚Äú${kw}‚Äù`) }
});

/* Kickoff */
loadHome();
</script>
</body>
</html>
