<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>ONFLIX ‚Ä¢ XEM PHIM M·ªöI M·ªñI NG√ÄY</title>
<meta name="description" content="Duy·ªát & xem th√¥ng tin phim m∆∞·ª£t. D·ªØ li·ªáu t·ª´ phimapi.com." />
<meta name="theme-color" content="#0b1020" />
<meta name="google-adsense-account" content="ca-pub-8744156112162890">

<!-- Prefetch/Preconnect -->
<link rel="dns-prefetch" href="https://phimapi.com">
<link rel="dns-prefetch" href="https://phimimg.com">
<link rel="preconnect" href="https://phimapi.com" crossorigin>
<link rel="preconnect" href="https://phimimg.com" crossorigin>
<link rel="preconnect" href="https://images.weserv.nl" crossorigin>

<!-- Fonts -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">

<style>
:root{
  --bg:#0b1020;--panel:#11172c;--panel2:#0e152b;--ring:#2563eb;
  --accent:#e50914;--accent2:#7c3aed;--text:#f5f7fb;--muted:#97a2b3;
  --hdr-h:72px;--container:1280px;
}
@media(min-width:640px){:root{--hdr-h:68px}}
* {box-sizing:border-box}
html,body{height:100%}
html{-webkit-text-size-adjust:100%;scroll-padding-top:calc(var(--hdr-h) + env(safe-area-inset-top,0px)); scroll-behavior: smooth;} /* N√¢ng c·∫•p: Smooth scrolling to√†n trang */
body{
  margin:0;color:var(--text);
  -webkit-tap-highlight-color: transparent;
  font-family:"Plus Jakarta Sans",system-ui,Segoe UI,Roboto,Arial,sans-serif;
  background:
    radial-gradient(900px 600px at 50% -200px, rgba(59,130,246,.25), transparent 60%),
    linear-gradient(180deg, rgba(2,6,23,.85), rgba(2,6,23,0)),
    var(--bg);
  padding-bottom:env(safe-area-inset-bottom,0px);
  overflow-x: hidden; /* N√¢ng c·∫•p: Tr√°nh scroll ngang kh√¥ng mong mu·ªën */
}

/* N√¢ng c·∫•p: Particles - C√°c ch·∫•m tr·∫Øng bay l∆∞·ª£n */
#particles {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  pointer-events: none;
  z-index: -1;
}
.particle {
  position: absolute;
  background: rgba(255, 255, 255, 0.6); /* Ch·∫•m tr·∫Øng trong su·ªët */
  border-radius: 50%;
  will-change: transform; /* T·ªëi ∆∞u animation m∆∞·ª£t h∆°n */
  animation: float linear infinite;
}
@keyframes float {
  0% {
    transform: translateY(100vh) translateX(0) rotate(0deg);
    opacity: 0;
  }
  10% {
    opacity: 0.8;
  }
  90% {
    opacity: 0.8;
  }
  100% {
    transform: translateY(-100px) translateX(100px) rotate(360deg); /* Th√™m chuy·ªÉn ƒë·ªông ngang nh·∫π */
    opacity: 0;
  }
}

a{color:inherit;text-decoration:none}
input,button,select,textarea{font:inherit;-webkit-appearance:none}
.container{max-width:var(--container);margin:0 auto;padding:0 14px}

/* ===== Header ===== */
.hdr{
  position:fixed;inset:0 0 auto 0;z-index:2000;
  backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);
  background:linear-gradient(180deg,rgba(7,11,24,.92),rgba(7,11,24,.6));
  border-bottom:1px solid rgba(255,255,255,.03); /* Gi·∫£m opacity vi·ªÅn */
  padding-top:env(safe-area-inset-top,0px);
  will-change:transform;transform:translateZ(0);
}
.hdr__row{
  display:grid;grid-template-columns:auto 1fr auto;gap:12px;align-items:center;
  padding:10px 12px;
}
@media(max-width:740px){
  .hdr__row{grid-template-columns:auto 1fr;grid-auto-rows:auto}
  .search{grid-column:2/3;grid-row:1}
  .tabs{grid-column:1/-1;grid-row:2;margin-top:6px}
}
.brand{display:flex;align-items:center;gap:10px;cursor:pointer;position:relative}
.brand__logo{
  width:28px;height:28px;border-radius:8px;display:grid;place-items:center;
  background:conic-gradient(from 210deg at 50% 50%,#a78bfa 0 40%,#60a5fa 40% 72%,#34d399 72% 100%);
  color:#0b1020;font-weight:900;box-shadow:0 6px 16px rgba(124,58,237,.35);
  position:relative;overflow:hidden;
}
.brand__logo::after{
  content:"";position:absolute;inset:-2px;border-radius:8px;
  background:conic-gradient(from 0deg,#60a5fa,#a78bfa,#34d399,#60a5fa);
  mix-blend-mode:overlay;animation:spin 8s linear infinite;opacity:.6
}
@keyframes spin{to{transform:rotate(360deg)}}
.brand__t{
  font-family:"Cinzel",serif;font-weight:800;letter-spacing:.6px;
  background:linear-gradient(90deg,#c7d2fe,#f0abfc);
  -webkit-background-clip:text;background-clip:text;color:transparent;
  text-shadow:0 0 16px rgba(124,58,237,.25);user-select:none
}
.btn{background:linear-gradient(135deg,#2563eb,#7c3aed);border:0;color:#fff;
  padding:9px 12px;border-radius:12px;font-weight:800;cursor:pointer;touch-action:manipulation;white-space:nowrap;line-height:1;transition:transform .2s ease}
.btn:hover{transform:translateY(-1px)}
.btn:active{transform:translateY(0)}
.btn-pill{border-radius:999px}
.btn-ghost{background:#0f172a;border:1px solid rgba(255,255,255,.08);color:#e5e7eb} /* Gi·∫£m opacity vi·ªÅn */
.search{
  position:relative;display:flex;gap:8px;background:rgba(255,255,255,.06);
  border:1px solid rgba(255,255,255,.04);border-radius:12px;padding:8px 10px; /* Gi·∫£m opacity vi·ªÅn */
  min-width:220px;
}
.search input{flex:1;min-width:0;background:transparent;border:0;color:var(--text);outline:0;font-size:16px;line-height:1.4}
@media(max-width:740px){
  .search{min-width:0;width:100%}
  .search .btn{padding:8px 10px}
}
.tabs{display:flex;gap:8px;overflow-x:auto;padding-bottom:4px;scrollbar-width:none}
.tabs::-webkit-scrollbar{display:none}
.tab{padding:8px 12px;border-radius:999px;border:1px solid rgba(255,255,255,.04); /* Gi·∫£m opacity vi·ªÅn */
  background:rgba(255,255,255,.05);color:#e5e7eb;white-space:nowrap;cursor:pointer;touch-action:manipulation;flex:0 0 auto;transition:background .2s ease}
.tab.active{background:linear-gradient(135deg,#2563eb,#7c3aed);border-color:transparent;box-shadow:0 6px 18px rgba(124,58,237,.25)}

/* ===== Chips ===== */
.chips{display:flex;gap:10px;flex-wrap:wrap;margin:8px 0 2px}
.chip{padding:8px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.04); /* Gi·∫£m opacity vi·ªÅn */
  background:rgba(255,255,255,.06);cursor:pointer;touch-action:manipulation;transition:border-color .2s ease}
.chip:hover{border-color:#7c3aed}

/* ===== Hero ===== */
.hero{position:relative;min-height:220px;padding:22px 0 0;margin-bottom:2px}
.hero__card{
  position:relative;border-radius:20px;overflow:hidden;border:1px solid rgba(255,255,255,.03); /* Gi·∫£m opacity vi·ªÅn */
  background:#0b1224;isolation:isolate;
  box-shadow:0 10px 30px rgba(124,58,237,.12), inset 0 0 0 1px rgba(255,255,255,.02); /* Gi·∫£m inset vi·ªÅn */
}
.hero__card::before{
  content:"";position:absolute;inset:-2px;border-radius:22px;
  background:conic-gradient(from 0deg,rgba(99,102,241,.6),rgba(168,85,247,.6),rgba(34,197,94,.6),rgba(99,102,241,.6));
  filter:blur(14px);opacity:.18;animation:spin 10s linear infinite;
}
.hero__bg{position:absolute;inset:0;background-size:cover;background-position:center;filter:blur(18px) saturate(1.1);transform:scale(1.12);opacity:.45}
.hero__overlay{position:absolute;inset:0;background:
  radial-gradient(1200px 400px at -5% -20%, rgba(96,165,250,.20), transparent 60%),
  radial-gradient(900px 420px at 110% 100%, rgba(167,139,250,.18), transparent 60%),
  linear-gradient(90deg,rgba(8,12,28,.94),rgba(8,12,28,.72),rgba(8,12,28,.25))}
.hero__card::after{
  content:"";position:absolute;inset:0;pointer-events:none;opacity:.17;
  background:
    radial-gradient(ellipse at 70% -60%, rgba(255,255,255,.08), transparent 35%),
    url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="160" height="160"><filter id="n"><feTurbulence type="fractalNoise" baseFrequency="0.9" numOctaves="2" stitchTiles="stitch"/></filter><rect width="100%" height="100%" filter="url(%23n)" opacity="0.20"/></svg>');
  mix-blend-mode:soft-light
}
.hero__body{position:relative;display:flex;gap:16px;padding:18px}
.hero__poster{width:150px;border-radius:14px;overflow:hidden;flex:0 0 auto;background:#0e1426;border:1px solid rgba(255,255,255,.03)} /* Gi·∫£m vi·ªÅn */
.hero__poster img{width:100%;height:220px;object-fit:cover;display:block}
.badges{display:flex;flex-wrap:wrap;gap:6px;margin:8px 0 6px}
.badge{font-size:12px;padding:4px 8px;border-radius:999px;background:rgba(255,255,255,.09);border:1px solid rgba(255,255,255,.08)} /* Gi·∫£m vi·ªÅn */
.hero h1{margin:4px 0 6px;font-size:22px;font-weight:800}
.hero .desc{color:#d0d6e5;display:-webkit-box;-webkit-line-clamp:3;-webkit-box-orient:vertical;overflow:hidden}

/* CTA (fix icon/heart alignment) */
.hero-actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}
.abtn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:10px 12px;border-radius:12px;
  background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.08);cursor:pointer;font-weight:800;line-height:1;transition:transform .2s ease} /* Gi·∫£m vi·ªÅn */
.abtn svg{width:18px;height:18px;display:block;fill:currentColor}
.abtn.play{background:linear-gradient(135deg,#f59e0b,#fde68a);color:#111827;border:0}
@media(max-width:740px){ .hero__poster{display:none} }

/* d·∫£i thumbnail d∆∞·ªõi hero */
.hero__strip{
  position:relative;display:flex;gap:10px;overflow:auto;
  padding:10px 6px 10px;margin:6px 12px 10px;border-top:1px solid rgba(255,255,255,.03); /* Gi·∫£m vi·ªÅn */
  scrollbar-width:none;-webkit-overflow-scrolling:touch
}
.hero__strip::-webkit-scrollbar{display:none}
.hthumb{flex:0 0 auto;width:72px}
.hthumb .box{position:relative;border-radius:12px;overflow:hidden;background:#0e1426;border:1px solid rgba(255,255,255,.03)} /* Gi·∫£m vi·ªÅn */
.hthumb img{display:block;width:72px;height:100px;object-fit:cover}
.hthumb.active .box{outline:2px solid #93c5fd}

/* ===== Sections & Rows ===== */
.sec{display:flex;align-items:center;justify-content:space-between;margin:16px 2px 10px}
.sec h2{font-size:20px;margin:0;color:#dbeafe;text-shadow:0 2px 14px rgba(59,130,246,.25)}
.row{position:relative}

/* Rows */
.movie-row{
  display:flex;gap:14px;overflow-x:auto;scroll-behavior:smooth;
  padding:2px 2px 26px;
  -ms-overflow-style:none;scrollbar-width:none;
  touch-action: pan-y;-webkit-overflow-scrolling:touch
}
.movie-row::-webkit-scrollbar{height:0}
.row::before,.row::after{
  content:"";position:absolute;top:0;bottom:22px;width:70px;pointer-events:none;z-index:1
}
.row::before{left:0;background:linear-gradient(90deg, rgba(11,16,32,1), rgba(11,16,32,0))}
.row::after{right:0;background:linear-gradient(270deg, rgba(11,16,32,1), rgba(11,16,32,0))}

/* N√∫t m≈©i t√™n */
.row .arrow{
  position:absolute;top:40%;transform:translateY(-50%);z-index:3;
  width:40px;height:40px;border-radius:999px;display:grid;place-items:center;
  background:rgba(15,23,42,.65);border:1px solid rgba(255,255,255,.12);backdrop-filter:blur(6px);-webkit-backdrop-filter:blur(6px);
  cursor:pointer;opacity:0;transition:.25s;touch-action:manipulation
}
.row:hover .arrow{opacity:1}
.row .arrow.left{left:8px}
.row .arrow.right{right:8px}

/* ===== Card ===== */
.movie{width:176px;flex:0 0 auto;cursor:pointer;perspective:700px;outline:none;transition:transform .2s ease; will-change: transform;} /* N√¢ng c·∫•p: will-change cho m∆∞·ª£t h∆°n */
.movie:focus-visible{box-shadow:0 0 0 3px rgba(96,165,250,.55);border-radius:16px}
.poster{
  position:relative;height:0;padding-top:150%;border-radius:16px;overflow:hidden;background:#0e1426;border:1px solid rgba(255,255,255,.03); /* Gi·∫£m vi·ªÅn tr·∫Øng */
  transform:perspective(700px) rotateX(var(--rx,0)) rotateY(var(--ry,0)); will-change:transform
}
/* AURA */
.poster::before{
  content:"";position:absolute;inset:-1px;border-radius:16px;padding:1px;
  background:conic-gradient(from 0deg,#60a5fa,#a78bfa,#34d399,#60a5fa);
  -webkit-mask:linear-gradient(#000 0 0) content-box,linear-gradient(#000 0 0);
  -webkit-mask-composite:xor;mask-composite:exclude;opacity:.0;transition:.25s;pointer-events:none
}
.movie:hover .poster::before{opacity:.8;animation:spin 3.8s linear infinite}
.poster img{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;display:block}
.shine::after{content:"";position:absolute;inset:-130% -50% auto auto;width:60%;height:220%;transform:rotate(25deg);opacity:0;
  background:linear-gradient(90deg,transparent,rgba(255,255,255,.18),transparent);transition:transform .4s ease,opacity .4s ease}
.poster .meta{z-index:1}
.poster .tag{position:absolute;display:inline-flex;align-items:center;gap:6px;font-size:11px;font-weight:900;line-height:1;padding:5px 8px;border-radius:10px;border:1px solid rgba(255,255,255,.14);box-shadow:0 6px 18px rgba(0,0,0,.35);z-index:2;pointer-events:none;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:calc(100% - 16px)}
.tag-ep{top:8px;left:8px;background:linear-gradient(135deg,#22c55e,#16a34a);color:#f0fdf4}
.tag-ep .ic{width:14px;height:14px;display:block;fill:currentColor;opacity:.95}
/* ·∫®N CH·∫§T L∆Ø·ª¢NG */
.tag-q{display:none!important}
/* NG√îN NG·ªÆ ‚Äì ƒë·∫∑t ·ªü bottom right */
.tag-lang{right:8px;bottom:8px;left:auto}
.tag-lang.pd{background:linear-gradient(135deg,#ef4444,#dc2626);color:#fff}
.tag-lang.lt{background:linear-gradient(135deg,#22c55e,#16a34a);color:#f0fdf4}
.tag-lang.tm{background:linear-gradient(135deg,#60a5fa,#3b82f6);color:#fff}
/* L∆Ø·ª¢T XEM ‚Äì ƒë·ªïi ch·ªØ tr·∫Øng */
.tag-views{top:8px;right:8px;background:linear-gradient(135deg,#60a5fa,#34d399);color:#fff;border-color:rgba(255,255,255,.0);font-weight:900;text-shadow:0 1px 2px rgba(0,0,0,.35)}

.movie:hover .shine::after{transform:translateX(-40%) rotate(25deg);opacity:.9}
.movie:hover .poster{transform:perspective(700px) rotateX(calc(var(--rx,0)*1.15)) rotateY(calc(var(--ry,0)*1.15)) translateZ(6px)}
/* Gi·ªØ ch·ªó cho badge ng√¥n ng·ªØ ƒë·ªÉ kh√¥ng ch·ªìng ch·ªØ - tƒÉng padding-bottom ƒë·ªÉ tr√°nh ch·ªìng ch√©o */
/* Gi·∫£m padding-bottom v√¨ ƒë√£ b·ªè lang tag ƒë·ªÉ tr√°nh m·∫•t ch·ªØ title */
.meta{position:absolute;left:8px;right:8px;bottom:8px;background:transparent;border-radius:12px;padding:40% 8px 8px;text-shadow:0 2px 4px rgba(0,0,0,.8)}
.tl{font-size:13px;font-weight:800;line-height:1.3;margin-bottom:6px;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;text-shadow:0 2px 4px rgba(0,0,0,.8)}
.pills{display:flex;gap:6px;flex-wrap:wrap;max-height:32px;overflow:hidden}
.pill{font-size:11px;padding:3px 6px;border-radius:999px;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.08);text-shadow:0 1px 2px rgba(0,0,0,.6)} /* Gi·∫£m vi·ªÅn */

/* ===== Anime Vault ===== */
.av-sec .hdrline{display:flex;align-items:center;gap:10px;margin:18px 2px 12px}
.av-sec .hdrline h2{font-size:22px;margin:0}
.av-sec .go{display:inline-grid;place-items:center;width:32px;height:32px;border-radius:999px;
  border:1px solid rgba(255,255,255,.08);background:rgba(255,255,255,.06);font-weight:800;transition:background .2s ease} /* Gi·∫£m vi·ªÅn */

.anivault{
  position:relative;border-radius:20px;overflow:hidden;
  border:1px solid rgba(255,255,255,.04); /* Gi·∫£m vi·ªÅn */
  background:#0b1224;min-height:360px;isolation:isolate;
  box-shadow:0 12px 30px rgba(99,102,241,.12)
}
.anivault .bg{position:absolute;inset:0;background-size:cover;background-position:right center;filter:contrast(1.05) saturate(1.1);opacity:.52;transform:scale(1.08)}
.anivault .overlay{position:absolute;inset:0;
  background:
    radial-gradient(1200px 400px at -5% -20%, rgba(96,165,250,.18), transparent 60%),
    radial-gradient(900px 420px at 110% 100%, rgba(167,139,250,.16), transparent 60%),
    linear-gradient(90deg,rgba(8,12,28,.96) 0 44%, rgba(8,12,28,.72) 60%, rgba(8,12,28,.15) 82%)}
.anivault::after{
  content:"";position:absolute;inset:0;pointer-events:none;opacity:.15;
  background:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="160" height="160"><filter id="n"><feTurbulence type="fractalNoise" baseFrequency="0.9" numOctaves="2" stitchTiles="stitch"/></filter><rect width="100%" height="100%" filter="url(%23n)" opacity="0.25"/></svg>');
  mix-blend-mode:soft-light
}
.anivault .inner{position:relative;display:grid;grid-template-columns:1fr;gap:12px;padding:22px}
.av-title{font-size:28px;font-weight:800;margin:0}
.av-sub{color:#cfd6e6;margin-top:-6px}
.av-badges,.av-tags{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
.badge2{font-size:12px;font-weight:800;padding:5px 9px;border-radius:10px;
  background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.08)} /* Gi·∫£m vi·ªÅn */
.tag{font-size:12px;padding:5px 9px;border-radius:999px;background:#121a36;border:1px solid rgba(255,255,255,.04)} /* Gi·∫£m vi·ªÅn */
.av-desc{color:#dde4f7;max-width:720px;line-height:1.65;margin-top:8px;display:-webkit-box;-webkit-line-clamp:4;-webkit-box-orient:vertical;overflow:hidden}
.av-cta{display:flex;gap:14px;margin-top:14px}
.av-cta .cbtn{width:64px;height:64px;border-radius:999px;display:grid;place-items:center;font-size:22px;
  border:1px solid rgba(255,255,255,.08);background:rgba(255,255,255,.06);cursor:pointer;backdrop-filter:blur(8px);transition:transform .2s ease} /* Gi·∫£m vi·ªÅn */
.av-cta .cbtn:hover{transform:scale(1.05)}
.av-cta .play{background:linear-gradient(135deg,#f59e0b,#fde68a);color:#111827;border:0;font-weight:900}
.av-strip{display:flex;gap:10px;overflow:auto;padding:10px 4px 16px;margin:8px -4px 0;scrollbar-width:none;-webkit-overflow-scrolling:touch}
.av-strip::-webkit-scrollbar{display:none}
.av-thumb{flex:0 0 auto;width:82px}
.av-thumb .box{position:relative;border-radius:12px;overflow:hidden;background:#0e1426;border:1px solid rgba(255,255,255,.03)} /* Gi·∫£m vi·ªÅn */
.av-thumb img{display:block;width:82px;height:116px;object-fit:cover}
.av-thumb.active .box{outline:2px solid #93c5fd}
.av-thumb .cap{position:absolute;inset:auto 6px 6px 6px;font-size:11px;background:rgba(0,0,0,.6);padding:2px 6px;border-radius:8px;display:inline-block}
@media(max-width:740px){ .av-title{font-size:22px} .anivault{min-height:320px} }

/* Rankings */
.rank-wrap{display:grid;grid-template-columns:1fr;gap:12px}
@media(min-width:900px){.rank-wrap{grid-template-columns:1fr 1fr}}
.rank{border:1px solid rgba(255,255,255,.04);background:rgba(255,255,255,.03);border-radius:16px;padding:14px} /* Gi·∫£m vi·ªÅn */
.rank h3{margin:0 0 10px;font-size:18px}
.rank ul{list-style:none;margin:0;padding:0;display:grid;gap:10px}
.rank li{display:grid;grid-template-columns:auto auto 1fr;gap:10px;align-items:center;padding:6px;border-radius:10px;cursor:pointer;transition:background .2s ease}
.rank li:hover{background:rgba(255,255,255,.04)}
.rank .no{width:28px;height:28px;border-radius:8px;background:#1b233d;display:grid;place-items:center;font-weight:800;color:#9fb3ff}
.rank img{width:38px;height:54px;border-radius:8px;object-fit:cover;border:1px solid rgba(255,255,255,.03)} /* Gi·∫£m vi·ªÅn */

/* Grid Explore/Search */
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:14px}
#explore{padding-bottom:22px}

/* Explore filter bar */
#filterBar{margin:6px 2px 12px}
#filterBar .label{opacity:.9;margin-right:6px}
#filterBar .btn-clear{margin-left:8px}

/* Skeleton & toast */
.skeleton{position:relative;overflow:hidden;background:#0f162b;border-radius:16px;height:0;padding-top:150%}
.skeleton::after{content:"";position:absolute;inset:0;background:linear-gradient(90deg,transparent,rgba(255,255,255,.08),transparent);transform:translateX(-100%);animation:sh 1.4s infinite}
@keyframes sh{to{transform:translateX(100%)}}
.toast{position:fixed;left:50%;transform:translateX(-50%);bottom:22px;background:#0b1220;border:1px solid #22304c;color:#fff;padding:10px 14px;border-radius:10px;box-shadow:0 10px 24px rgba(0,0,0,.35);z-index:99999;animation:fadeInUp .3s ease}

/* Popup & Player - N√¢ng c·∫•p */
.popup{position:fixed;inset:0;display:none;justify-content:center;align-items:flex-start;background:rgba(0,0,0,.9);z-index:9990;overflow:auto;
  padding:calc(30px + env(safe-area-inset-top,0px)) 12px calc(30px + env(safe-area-inset-bottom,0px));
  backdrop-filter:blur(8px); -webkit-backdrop-filter:blur(8px); /* TƒÉng blur cho n·ªÅn ƒë·∫πp h∆°n */
  animation:fadeIn .3s ease-in-out; /* Animation m·ªü */
}
@keyframes fadeIn{from{opacity:0;transform:translateY(20px);} to{opacity:1;transform:translateY(0);}}
.popup-content{width:100%;max-width:1180px;display:flex;flex-direction:column;gap:12px}
.player{position:relative;width:100%;aspect-ratio:16/9;background:#000;border-radius:20px;overflow:hidden;border:1px solid rgba(255,255,255,.03); /* Gi·∫£m vi·ªÅn, tƒÉng radius */
  box-shadow:0 12px 40px rgba(0,0,0,.5); /* Shadow ƒë·∫πp h∆°n */
}
.player::after { /* Gradient overlay cho player */
  content: ""; position: absolute; inset: 0; pointer-events: none;
  background: radial-gradient(circle at top left, rgba(255,255,255,.05), transparent 50%);
  opacity: 0.8;
}
.player video,.player iframe{width:100%;height:100%;border:0;display:block;object-fit:contain;}
.player .loading{position:absolute;inset:0;display:none;place-items:center;background:rgba(0,0,0,.18);backdrop-filter:blur(1px)}
.player .loading::after{content:"";width:48px;height:48px;border:none; /* L√†m spinner ƒë·∫πp h∆°n */
  border-radius:50%; background:conic-gradient(transparent, #fff); animation:spin 1s linear infinite; opacity:0.8;}

/* Detail header */
.detail-hero{border:1px solid rgba(255,255,255,.03);border-radius:14px;overflow:hidden;background:#0b1220;position:relative} /* Gi·∫£m vi·ªÅn */
.detail-hero .bg{position:absolute;inset:0;background-size:cover;background-position:center;filter:blur(16px) saturate(1.1);opacity:.35;transform:scale(1.08)}
.detail-hero .overlay{position:absolute;inset:0;background:linear-gradient(90deg,rgba(8,12,28,.92),rgba(8,12,28,.72),rgba(8,12,28,.2))}
.detail-hero .inner{position:relative;display:flex;gap:16px;padding:16px;align-items:center}
.detail-hero img{width:140px;height:210px;object-fit:cover;border-radius:12px;border:1px solid rgba(255,255,255,.03)} /* Gi·∫£m vi·ªÅn */
.detail-title{margin:0 0 6px;font-size:22px;font-weight:800}
.detail-meta{color:#b7c0d4;font-size:14px;line-height:1.5}
.cta{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}

/* VOTE UI - N√¢ng c·∫•p */
.vote{display:inline-flex;align-items:center;gap:8px;border:1px solid rgba(255,255,255,.08);background:rgba(255,255,255,.06);line-height:1;transition:box-shadow .2s ease, transform .2s ease} /* Gi·∫£m vi·ªÅn */
.vote b{font-variant-numeric:tabular-nums}
.vote.done{box-shadow:0 8px 24px rgba(34,197,94,.18), inset 0 0 0 1px rgba(34,197,94,.3)}
.vote.like:hover{transform:scale(1.05); background:linear-gradient(135deg,#22c55e,#16a34a);}
.vote.dislike:hover{transform:scale(1.05); background:linear-gradient(135deg,#ef4444,#dc2626);}
.burst{position:absolute;pointer-events:none;width:10px;height:10px;border-radius:50%;
  background:radial-gradient(circle at center, rgba(255,255,255,.95), rgba(255,255,255,0));
  animation:burst 600ms ease-out forwards}
@keyframes burst{0%{opacity:.9;transform:scale(.6)}100%{opacity:0;transform:scale(12)}}

/* Toolbar - N√¢ng c·∫•p */
.toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center;background:#0f172a;border:1px solid rgba(255,255,255,.04);padding:8px 10px;border-radius:10px} /* Gi·∫£m vi·ªÅn */
.toolbar select,.toolbar label,.toolbar button{font:inherit;transition:transform .2s ease, background .2s ease;} /* Hover effect */
.toolbar button:hover{transform:scale(1.05); background:linear-gradient(135deg,#2563eb,#7c3aed); color:#fff;}
.toolbar select{background:#0b1430;border:1px solid rgba(255,255,255,.08);color:#e5e7eb;border-radius:8px;padding:8px 10px;min-width:120px} /* Gi·∫£m vi·ªÅn */
.toolbar .sep{width:1px;height:24px;background:rgba(255,255,255,.1);margin:0 4px}
/* Toggle switch cho autoNext */
.toolbar .switch-label {display:flex;align-items:center;gap:6px;}
.toolbar .switch {position:relative;display:inline-block;width:40px;height:20px;}
.toolbar .switch input {opacity:0;width:0;height:0;}
.toolbar .slider {position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background-color:#ccc;-webkit-transition:.4s;transition:.4s;border-radius:34px;}
.toolbar .slider:before {position:absolute;content:"";height:16px;width:16px;left:2px;bottom:2px;background-color:white;-webkit-transition:.4s;transition:.4s;border-radius:50%;}
.toolbar input:checked + .slider {background-color:#2196F3;}
.toolbar input:checked + .slider:before {-webkit-transform:translateX(20px); -ms-transform:translateX(20px); transform:translateX(20px);}
@media(max-width:740px){.toolbar{flex-direction:column;gap:12px;}} /* Stack cho mobile */

/* Footer */
footer{background:var(--panel);color:var(--muted);padding:24px 12px calc(24px + env(safe-area-inset-bottom,0px));border-top:1px solid rgba(255,255,255,.04);margin-top:36px;text-align:center} /* Gi·∫£m vi·ªÅn */
footer .footer-content{max-width:900px;margin:0 auto}
footer a{color:#93c5fd}

/* Footer badge */
.footer-badge{display:inline-flex;align-items:center;gap:10px;margin-top:12px;padding:8px 14px;border-radius:999px;background:linear-gradient(180deg,#b91c1c,#7f1d1d);color:#fff;border:1px solid rgba(255,255,255,.12);box-shadow:0 6px 18px rgba(239,68,68,.28);font-weight:800}
.footer-badge .star{width:20px;height:20px;border-radius:50%;display:grid;place-items:center;flex:0 0 auto;background:#facc15;color:#7c2d12;font-size:12px;line-height:1}

/* Reduce motion */
@media (prefers-reduced-motion: reduce){
  .movie:hover .poster{transform:none}
  .shine::after{display:none}
  .particle {animation: none !important;} /* T·∫Øt particles n·∫øu gi·∫£m motion */
}

/* N√¢ng c·∫•p: Fade in animation cho toast */
@keyframes fadeInUp{from{opacity:0;transform:translate(-50%,20px)}to{opacity:1;transform:translate(-50%,0)}}

/* N√¢ng c·∫•p: Smooth scroll cho rows */
.movie-row{scroll-behavior:smooth}

/* N√¢ng c·∫•p: C·∫£i thi·ªán hover cho movie */
.movie:hover{transform:scale(1.02)}

/* N√¢ng c·∫•p m·ªõi: Th√™m animation fade-in cho cards */
.movie {opacity: 0; animation: fadeInCard 0.5s ease forwards;}
@keyframes fadeInCard {from {opacity: 0; transform: translateY(20px);} to {opacity: 1; transform: translateY(0);}}
.movie:nth-child(1) {animation-delay: 0.1s;}
.movie:nth-child(2) {animation-delay: 0.2s;}
.movie:nth-child(3) {animation-delay: 0.3s;}
.movie:nth-child(4) {animation-delay: 0.4s;}
.movie:nth-child(5) {animation-delay: 0.5s;}
.movie:nth-child(6) {animation-delay: 0.6s;}
.movie:nth-child(7) {animation-delay: 0.7s;}
.movie:nth-child(8) {animation-delay: 0.8s;}
.movie:nth-child(9) {animation-delay: 0.9s;}
.movie:nth-child(10) {animation-delay: 1s;}

/* N√¢ng c·∫•p m·ªõi: Th√™m rating stars v√†o card */
.pills .rating {display: inline-flex; align-items: center; gap: 2px; color: #facc15;}
.pills .rating svg {width: 10px; height: 10px; fill: currentColor;}

/* N√¢ng c·∫•p m·ªõi: C·∫£i thi·ªán toast v·ªõi icon */
.toast.success {background: #22c55e; border-color: #16a34a;}
.toast.error {background: #ef4444; border-color: #dc2626;}

/* N√¢ng c·∫•p m·ªõi: Th√™m button toggle subtitles trong toolbar (n·∫øu h·ªó tr·ª£) */
.toolbar .sub-btn {background: rgba(255,255,255,.08); border: 1px solid rgba(255,255,255,.08); color: #fff; padding: 6px 10px; border-radius: 8px; cursor: pointer;}
.toolbar .sub-btn:hover {background: linear-gradient(135deg,#2563eb,#7c3aed);}
.toolbar .sub-btn.active {background: linear-gradient(135deg,#22c55e,#16a34a);}

/* N√¢ng c·∫•p m·ªõi: Responsive c·∫£i thi·ªán cho mobile - l·ªõn h∆°n poster */
@media(max-width:740px){
  .hero__body {flex-direction: column; text-align: center;}
  .hero-actions {justify-content: center;}
  .hero__poster {width: 100%; height: auto; max-width: 200px; margin: 0 auto;}
  .hero__poster img {height: auto;}
  .grid {grid-template-columns: repeat(auto-fill, minmax(120px,1fr)); gap: 10px;}
  .movie {width: 120px;}
  .poster {padding-top: 150%;}
  /* FIX: Gi·∫£m k√≠ch th∆∞·ªõc tag ƒë·ªÉ tr√°nh overlap T·∫≠p v√† Ng∆∞·ªùi xem tr√™n mobile */
  .poster .tag {
    font-size: 9px;
    padding: 3px 5px;
    gap: 3px;
    max-width: calc(100% - 12px);
  }
  .tag-ep .ic,
  .tag-views .ic {
    width: 10px;
    height: 10px;
  }
  .tag-lang {
    font-size: 9px;
    padding: 3px 5px;
  }
}

/* N√¢ng c·∫•p m·ªõi: Th√™m shadow cho tabs khi active */
.tab.active {box-shadow: 0 4px 12px rgba(124,58,237,.3);}

/* N√¢ng c·∫•p m·ªõi: C·∫£i thi·ªán footer v·ªõi social icons */
.footer-content .social {display: flex; justify-content: center; gap: 16px; margin-top: 12px;}
.footer-content .social a {font-size: 20px; color: #93c5fd; transition: color 0.2s;}
.footer-content .social a:hover {color: #7c3aed;}

/* N√¢ng c·∫•p: T·ªëi ∆∞u performance - Gi·∫£m animation n·∫øu c·∫ßn */
@media (prefers-reduced-motion: reduce) {
  * { animation-duration: 0.01ms !important; animation-iteration-count: 1 !important; transition-duration: 0.01ms !important; }
}
</style>
</head>
<body>

<!-- N√¢ng c·∫•p: Th√™m layer particles -->
<div id="particles"></div>

<header class="hdr">
  <div class="hdr__row container">
    <div class="brand" id="homeBtn" title="V·ªÅ Trang ch·ªß" aria-label="V·ªÅ Trang ch·ªß">
      <div class="brand__logo">‚òÖ</div>
      <div class="brand__t">ONFLIX</div>
    </div>
    <nav class="tabs" id="tabs" aria-label="ƒêi·ªÅu hÔøΩÔøΩ·ªõng">
      <button class="tab active" data-view="home">Trang ch·ªß</button>
      <button class="tab" data-type="phim-le" data-view="explore">Phim l·∫ª</button>
      <button class="tab" data-type="phim-bo" data-view="explore">Phim b·ªô</button>
      <button class="tab" data-type="tv-shows" data-view="explore">TV Shows</button>
      <button class="tab" data-type="hoat-hinh" data-view="explore">Ho·∫°t h√¨nh</button>
      <button class="tab" data-view="fav">Y√™u th√≠ch</button>
      <button class="tab" data-view="his">L·ªãch s·ª≠</button>
    </nav>
    <div class="search" role="search">
      <input id="q" placeholder="T√¨m phim..." aria-label="T√¨m phim">
      <button id="btnSearch" class="btn btn-pill">T√¨m</button>
    </div>
  </div>
</header>

<!-- N·ªôi dung trang gi·ªØ nguy√™n nh∆∞ c≈© -->
<section id="home" class="container">
  <div class="hero">
    <div class="hero__card">
      <div id="heroBg" class="hero__bg" aria-hidden="true"></div>
      <div class="hero__overlay" aria-hidden="true"></div>
      <div class="hero__body">
        <div class="hero__poster"><img id="heroPoster" src="" alt="" loading="lazy" decoding="async" referrerpolicy="no-referrer" fetchpriority="high"></div>
        <div>
          <h1 id="heroTitle">ƒêang t·∫£i...</h1>
          <div class="badges" id="heroBadges"></div>
          <div id="heroDesc" class="desc"></div>
          <div class="hero-actions">
            <button id="heroPlay" class="abtn play" title="Xem ngay" aria-label="Xem ngay">
              <svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg> Xem ngay
            </button>
            <button id="heroSave" class="abtn" title="L∆∞u" aria-label="L∆∞u">
              <svg viewBox="0 0 24 24"><path d="M12.1 21.35l-1.1-.99C5.14 15.24 2 12.36 2 8.99 2 6.42 4.42 4 7 4c1.66 0 3.14.79 4 2.02C11.86 4.79 13.34 4 15 4c2.58 0 5 2.42 5 4.99 0 3.37-3.14 6.25-8.9 11.37z"/></svg> L∆∞u
            </button>
            <button id="heroInfo" class="abtn" title="Th√¥ng tin" aria-label="Th√¥ng tin">
              <svg viewBox="0 0 24 24"><path d="M12 2a10 10 0 100 20 10 10 0 000-20zm.75 7.5a.75.75 0 11-1.5 0 .75.75 0 011.5 0zM11 11h2v6h-2z"/></svg> Th√¥ng tin
            </button>
          </div>
        </div>
      </div>
      <div id="heroStrip" class="hero__strip" aria-label="ƒê·ªÅ xu·∫•t nhanh"></div>
    </div>
  </div>

  <div class="chips">
    <button class="chip" data-key="Marvel">Marvel</button>
    <button class="chip" data-key="4K">4K</button>
    <button class="chip" data-key="Sitcom">Sitcom</button>
    <button class="chip" data-key="H√†i">H√†i</button>
    <button class="chip" data-key="Kinh d·ªã">Kinh d·ªã</button>
    <button class="chip" data-key="T√¢m l√Ω">T√¢m l√Ω</button>
  </div>

  <section id="animeVaultSec" class="av-sec">
    <div class="hdrline">
      <h2>Kho T√†ng Anime M·ªõi Nh·∫•t</h2>
      <button class="go" id="goMoreAnime" title="Xem th√™m">‚Ä∫</button>
    </div>
    <div class="anivault" id="animeVault" role="region" aria-label="Kho T√†ng Anime">
      <div class="bg" id="avBg"></div>
      <div class="overlay" aria-hidden="true"></div>
      <div class="inner">
        <h3 class="av-title" id="avTitle">ƒêang t·∫£i‚Ä¶</h3>
        <div class="av-sub" id="avSub"></div>
        <div class="av-badges" id="avBadges"></div>
        <div class="av-tags" id="avTags"></div>
        <div class="av-desc" id="avDesc"></div>
        <div class="av-cta">
          <button class="cbtn play" id="avPlay" title="Xem ngay" aria-label="Xem ngay"><svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg></button>
          <button class="cbtn" id="avFav" title="L∆∞u" aria-label="L∆∞u"><svg viewBox="0 0 24 24"><path d="M12.1 21.35l-1.1-.99C5.14 15.24 2 12.36 2 8.99 2 6.42 4.42 4 7 4c1.66 0 3.14.79 4 2.02C11.86 4.79 13.34 4 15 4c2.58 0 5 2.42 5 4.99 0 3.37-3.14 6.25-8.9 11.37z"/></svg></button>
          <button class="cbtn" id="avInfo" title="Th√¥ng tin" aria-label="Th√¥ng tin"><svg viewBox="0 0 24 24"><path d="M12 2a10 10 0 100 20 10 10 0 000-20zm.75 7.5a.75.75 0 11-1.5 0 .75.75 0 011.5 0zM11 11h2v6h-2z"/></svg></button>
        </div>
        <div class="av-strip" id="avStrip"></div>
      </div>
    </div>
  </section>

  <div class="sec"><h2>| Phim H√†n Qu·ªëc M·ªõi</h2><a class="chip" data-go="quocgia-hq">Xem th√™m ‚Ä∫</a></div>
  <div class="row"><div id="row-hq" class="movie-row"></div></div>

  <div class="sec"><h2>| Phim Trung Qu·ªëc M·ªõi</h2><a class="chip" data-go="quocgia-tq">Xem th√™m ‚Ä∫</a></div>
  <div class="row"><div id="row-tq" class="movie-row"></div></div>

  <div class="sec"><h2>| Phim US‚ÄìUK M·ªõi</h2><a class="chip" data-go="quocgia-usuk">Xem th√™m ‚Ä∫</a></div>
  <div class="row"><div id="row-usuk" class="movie-row"></div></div>

  <div class="sec"><h2>| Anime & Ho·∫°t H√¨nh M·ªõi</h2><a class="chip" data-go="cat-hoat-hinh">Xem th√™m ‚Ä∫</a></div>
  <div class="row"><div id="row-anime" class="movie-row"></div></div>

  <div class="sec"><h2>| Phim Hot</h2></div>
  <div class="row"><div id="row-hot" class="movie-row"></div></div>

  <div class="sec"><h2>| Phim ƒê·ªÅ Xu·∫•t Cho B·∫°n</h2></div>
  <div class="row"><div id="row-foru" class="movie-row"></div></div>

  <div class="sec"><h2>| Phim Top IMDB</h2></div>
  <div class="row"><div id="row-upcoming" class="movie-row"></div></div>

  <div class="sec"><h2>| Phim S√¥i N·ªïi Trong Tu·∫ßn</h2></div>
  <div class="row"><div id="row-imdb" class="movie-row"></div></div>

  <div class="sec"><h2>B·∫£ng x·∫øp h·∫°ng h√¥m nay</h2></div>
  <div class="rank-wrap">
    <div class="rank">
      <h3>üé¨ S√¥i n·ªïi nh·∫•t</h3>
      <ul id="rank-trend"></ul>
    </div>
    <div class="rank">
      <h3>üíõ Y√™u th√≠ch nh·∫•t</h3>
      <ul id="rank-fav"></ul>
    </div>
  </div>

  <div class="sec"><h2>üéûÔ∏è Phim b·ªô</h2></div>
  <div class="row"><div id="row-bo" class="movie-row"></div></div>

  <div class="sec"><h2>üé¨ Phim l·∫ª</h2></div>
  <div class="row"><div id="row-le" class="movie-row"></div></div>
</section>

<!-- EXPLORE -->
<section id="explore" class="container" style="display:none">
  <div class="sec"><h2 id="exploreTitle">Kh√°m ph√°</h2></div>

  <div id="filterBar" class="toolbar">
    <span class="label">L·ªçc nhanh:</span>
    <label>Th·ªÉ lo·∫°i
      <select id="fCat"><option value="">T·∫•t c·∫£</option></select>
    </label>
    <label>Qu·ªëc gia
      <select id="fCountry"><option value="">T·∫•t c·∫£</option></select>
    </label>
    <label>NƒÉm
      <select id="fYear"><option value="">T·∫•t c·∫£</option></select>
    </label>
    <div class="sep"></div>
    <label>S·∫Øp x·∫øp
      <select id="fSort">
        <option value="new" selected>M·ªõi nh·∫•t</option>
        <option value="year">NƒÉm ‚Üì</option>
        <option value="imdb">IMDb ‚Üì</option>
        <option value="az">A ‚Üí Z</option>
      </select>
    </label>
    <button id="fReset" class="btn btn-ghost btn-clear">ƒê·∫∑t l·∫°i</button>
  </div>

  <div id="grid" class="grid"></div>
  <div id="sentinel" style="height:1px"></div>
</section>

<!-- FAV / HISTORY -->
<section id="fav" class="container" style="display:none">
  <div class="sec"><h2>üìå Y√™u th√≠ch</h2></div>
  <div id="favGrid" class="grid"></div>
</section>
<section id="his" class="container" style="display:none">
  <div class="sec"><h2>üïò L·ªãch s·ª≠</h2></div>
  <div id="hisGrid" class="grid"></div>
</section>

<!-- POPUP -->
<div id="popup" class="popup" role="dialog" aria-modal="true">
  <span class="close" id="close" title="ƒê√≥ng (Esc)">‚úï</span>

  <div class="popup-content">
    <div class="detail-hero">
      <div class="bg" id="dBg"></div>
      <div class="overlay"></div>
      <div class="inner">
        <img id="dPoster" src="" alt="Poster" loading="lazy" decoding="async" referrerpolicy="no-referrer">
        <div class="pi">
          <h2 class="detail-title" id="dTitle">...</h2>
          <div class="detail-meta" id="dMeta">...</div>
          <div class="cta">
            <button id="btnPlayNow" class="btn">Xem ngay</button>
            <button id="btnFav" class="btn btn-ghost">+ L∆∞u</button>
            <button id="btnShare" class="btn btn-ghost">Chia s·∫ª</button>
            <button id="btnReport" class="btn btn-ghost">B√°o l·ªói</button>

            <!-- Vote -->
            <button id="btnLike" class="btn btn-ghost vote like" title="Th√≠ch (1 l·∫ßn/ng√†y)">
              üëç <b id="likeCount">0</b>
            </button>
            <button id="btnDislike" class="btn btn-ghost vote dislike" title="Kh√¥ng th√≠ch (1 l·∫ßn/ng√†y)">
              üëé <b id="dislikeCount">0</b>
            </button>
          </div>
        </div>
      </div>
    </div>

    <div class="toolbar" id="playerToolbar" style="display:none">
      <label>Ch·∫•t l∆∞·ª£ng
        <select id="qualitySelect" aria-label="Ch·ªçn ch·∫•t l∆∞·ª£ng">
          <option value="auto">Auto</option>
        </select>
      </label>
      <div class="sep"></div>
      <label>T·ªëc ƒë·ªô
        <select id="speedSelect" aria-label="T·ªëc ƒë·ªô">
          <option>0.75</option><option selected>1.0</option>
          <option>1.25</option><option>1.5</option><option>1.75</option><option>2.0</option>
        </select>
      </label>
      <div class="sep"></div>
      <label class="switch-label">T·ª± chuy·ªÉn t·∫≠p
        <label class="switch">
          <input type="checkbox" id="autoNext" checked>
          <span class="slider"></span>
        </label>
      </label>
      <button class="sub-btn" id="subToggle">Ph·ª• ƒë·ªÅ</button>
      <div style="flex:1"></div>
      <button id="btnReload" class="btn btn-ghost" title="T·∫£i l·∫°i ngu·ªìn">‚Üª</button>
      <button id="btnPiP" class="btn btn-ghost" title="Picture-in-Picture">PiP</button>
      <button id="btnFS" class="btn btn-ghost" title="To√†n m√†n h√¨nh">‚§¢</button>
    </div>

    <div id="player" class="player">
      <div class="loading" id="loading"></div>
    </div>

    <div class="pb">
      <div class="pi">
        <h4>Gi·ªõi thi·ªáu</h4>
        <div id="pDesc" class="desc"></div>
        <button id="pToggle" class="toggle" style="display:none">Xem th√™m ‚ñº</button>

        <h4 style="margin-top:14px">Danh s√°ch t·∫≠p</h4>
        <div id="eps" class="eps"></div>

        <h4 style="margin-top:14px">Di·ªÖn vi√™n</h4>
        <div id="cast" class="cast"></div>

        <h4 style="margin-top:14px">ƒê·ªÅ xu·∫•t t∆∞∆°ng t·ª±</h4>
        <div class="row"><div id="row-similar" class="movie-row"></div></div>
      </div>
    </div>
  </div>
</div>

<footer>
  <div class="footer-content">
    <p> PHIM HAY - PHIM M·ªöI - CH·∫§T L∆Ø·ª¢NG C·∫¨P NH·∫¨T M·ªñI NG√ÄY !</p>
    <p>¬© 2025 THANHPHAT</p>

    <div class="footer-badge" role="note" aria-label="Ho√†ng Sa &amp; Tr∆∞·ªùng Sa l√† c·ªßa Vi·ªát Nam!">
      <span class="star" aria-hidden="true">‚òÖ</span>
      <span>Ho√†ng Sa &amp; Tr∆∞·ªùng Sa l√† c·ªßa Vi·ªát Nam!</span>
    </div>
  </div>
</footer>

<script>
/* =============== Header height sync (FIX iPhone) =============== */
function syncHeaderPadding(){
  const hdr=document.querySelector('.hdr');
  if(!hdr) return;
  const h=hdr.offsetHeight||72;
  document.body.style.paddingTop = h+'px';
}
window.addEventListener('load',()=>{ syncHeaderPadding(); setTimeout(syncHeaderPadding, 200); createParticles(); }, {once:true}); /* N√¢ng c·∫•p: T·∫°o particles khi load */
window.addEventListener('resize', ()=>{ requestAnimationFrame(syncHeaderPadding); },{passive:true});
window.addEventListener('orientationchange', ()=>{ setTimeout(syncHeaderPadding, 100); });
new ResizeObserver(syncHeaderPadding).observe(document.querySelector('.hdr'));

/* =============== N√¢ng c·∫•p: T·∫°o particles ch·∫•m tr·∫Øng bay =============== */
function createParticles() {
  const particlesContainer = document.getElementById('particles');
  if (!particlesContainer) return;
  
  // S·ªë l∆∞·ª£ng particles (tƒÉng/gi·∫£m ƒë·ªÉ ƒëi·ªÅu ch·ªânh m·∫≠t ƒë·ªô)
  const numParticles = 200; // C√≥ th·ªÉ tƒÉng l√™n 100 cho nhi·ªÅu h∆°n, nh∆∞ng gi·ªØ m∆∞·ª£t
  
  for (let i = 0; i < numParticles; i++) {
    const particle = document.createElement('div');
    particle.className = 'particle';
    
    // V·ªã tr√≠ ng·∫´u nhi√™n t·ª´ d∆∞·ªõi l√™n
    particle.style.left = Math.random() * 100 + '%';
    particle.style.top = '100%'; // B·∫Øt ƒë·∫ßu t·ª´ d∆∞·ªõi m√†n h√¨nh
    
    // K√≠ch th∆∞·ªõc ng·∫´u nhi√™n nh·ªè
    const size = Math.random() * 3 + 1;
    particle.style.width = size + 'px';
    particle.style.height = size + 'px';
    
    // Delay v√† duration ng·∫´u nhi√™n ƒë·ªÉ t·∫°o hi·ªáu ·ª©ng bay li√™n t·ª•c
    particle.style.animationDelay = Math.random() * 30 + 's';
    particle.style.animationDuration = (Math.random() * 10 + 15) + 's'; // 15-25s ƒë·ªÉ ch·∫≠m v√† m∆∞·ª£t
    
    // Chuy·ªÉn ƒë·ªông ngang nh·∫π ng·∫´u nhi√™n
    const translateXEnd = (Math.random() - 0.5) * 200; // -100px ƒë·∫øn +100px
    particle.style.setProperty('--translateX-end', translateXEnd + 'px');
    
    particlesContainer.appendChild(particle);
  }
}

// C·∫≠p nh·∫≠t keyframes trong CSS ƒë·ªÉ s·ª≠ d·ª•ng bi·∫øn (n·∫øu c·∫ßn, nh∆∞ng ·ªü ƒë√¢y d√πng inline style cho ƒë∆°n gi·∫£n)

/* =============== Helpers & API =============== */
const API_BASE='https://phimapi.com';
const API_V1=API_BASE+'/v1/api';
const $=s=>document.querySelector(s);const $$=s=>document.querySelectorAll(s);
const toast=(m,t=1800,cls='')=>{const d=document.createElement('div');d.className=`toast ${cls}`;d.textContent=m;document.body.appendChild(d);setTimeout(()=>d.remove(),t)};

/* ·∫¢nh + fallback chu·ªói */
function absUrl(p,cdn='https://phimimg.com'){
  if(!p) return '';
  if(/^https?:\/\//i.test(p)) return p;
  if(p.startsWith('//')) return (location.protocol||'https:')+p;
  if(p.startsWith('/upload/')) return cdn.replace(/\/+$/,'')+p;
  return cdn.replace(/\/+$/,'')+'/'+p.replace(/^\/+/,'' );
}
function weserv(u){try{const x=new URL(u);return 'https://images.weserv.nl/?url='+encodeURIComponent(x.host+x.pathname+(x.search||''))}catch{return''}}
function ph(t){
  const s=(t||'Poster').replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
  return 'data:image/svg+xml;utf8,'+encodeURIComponent(
`<svg xmlns='http://www.w3.org/2000/svg' width='480' height='720'>
  <defs><linearGradient id='g' x1='0' y1='0' x2='1' y2='1'><stop stop-color='#0b1020'/><stop offset='1' stop-color='#111827'/></linearGradient></defs>
  <rect width='100%' height='100%' fill='url(#g)'/>
  <g fill='#9ca3af' transform='translate(240,280)'><circle r='38'/><rect x='-60' y='50' width='120' height='6' rx='3'/></g>
  <text x='50%' y='92%' font-size='26' fill='#9ca3af' text-anchor='middle' font-family='system-ui,Segoe UI,Roboto,sans-serif'>${s}</text>
</svg>`)}
function imgChain(raw,cdn){
  const a=absUrl(raw,cdn); if(!a) return [ph('Poster')];
  const httpsFix=(location.protocol==='https:'&&/^http:\/\//i.test(a))?a.replace(/^http:/,'https:'):''; const ws=weserv(a);
  const list=[ws,httpsFix,a].filter(Boolean); list.push(ph('Poster')); return [...new Set(list)];
}
function onImgError(img){
  const l=(img.dataset.f||'').split('|').filter(Boolean);
  let i=+img.dataset.i||0;
  if(i<l.length-1){ img.dataset.i=++i; img.src=l[i]; }
  else { img.onerror=null; img.src=l[l.length-1]; }
}
window.onImgError=onImgError;

/* Fetch + cache nh·∫π */
const memCache=new Map();
async function fetchJSON(u,t=12000){
  if(memCache.has(u)) return memCache.get(u);
  const c=new AbortController(); const k=setTimeout(()=>c.abort(),t);
  try{
    const r=await fetch(u,{signal:c.signal,credentials:'omit',cache:'force-cache'});
    clearTimeout(k); if(!r.ok) throw new Error('HTTP '+r.status);
    const j=await r.json(); memCache.set(u,j); return j;
  }catch(e){ clearTimeout(k); throw e; }
}
function normList(raw){
  let it=[],cp=1,tp=1,cdn='https://phimimg.com';
  if(raw?.data?.items){
    it=raw.data.items; const p=raw.data.params?.pagination||{};
    cp=p.currentPage||p.current_page||1; tp=p.totalPages||p.total_pages||1;
    cdn=raw.data.APP_DOMAIN_CDN_IMAGE||cdn;
  }else{
    it=raw.items||[]; cp=raw.pagination?.currentPage||1; tp=raw.pagination?.totalPages||1;
    cdn=raw.APP_DOMAIN_CDN_IMAGE||cdn;
  }
  return {items:it,cp,tp,cdn};
}

/* ===== Helpers ===== */
const nfmt=n=>{try{return new Intl.NumberFormat('vi-VN').format(n)}catch{return String(n)}}
const cfmt=n=>{try{return new Intl.NumberFormat('vi-VN',{notation:'compact',compactDisplay:'short'}).format(n)}catch{
  if(n>=1e6) return (Math.round(n/1e5)/10)+'M';
  if(n>=1e3) return (Math.round(n/1e2)/10)+'K';
  return String(n);
}};
const todayStr=()=>{const d=new Date();return d.toISOString().slice(0,10)}
function daysBetween(a,b){
  const d1=new Date(a+'T00:00:00'); const d2=new Date(b+'T00:00:00');
  return Math.max(0,Math.round((d2-d1)/(1000*60*60*24)));
}
function hashSlug(s=''){let h=2166136261>>>0; for(let i=0;i<s.length;i++){h^=s.charCodeAt(i);h=(h*16777619)>>>0} return h>>>0}

/* ===== Views ·∫£o (m·ªói ng√†y +555..2222) ===== */
const LS_VIEWS='pf_views_v1';
function getViews(slug){
  if(!slug) return 0;
  let store={}; try{store=JSON.parse(localStorage.getItem(LS_VIEWS)||'{}')}catch{}
  let v=store[slug]; const today=todayStr();
  if(!v){
    const h=hashSlug(slug);
    const base = 30000 + (h % 500000);
    v={count:base,last:today};
  }else{
    const diff=daysBetween(v.last||today,today);
    if(diff>0){
      for(let i=0;i<diff;i++){
        const inc = 555 + Math.floor(Math.random()*(2222-555+1));
        v.count += inc;
      }
      v.last=today;
    }
  }
  store[slug]=v; localStorage.setItem(LS_VIEWS, JSON.stringify(store));
  return v.count;
}

/* ===== Vote Like/Dislike ===== */
const LS_VOTE='pf_votes_v1';
function seedVotes(slug){
  const h=hashSlug(slug);
  const likes = 200 + (h % 3500);
  const dislikes = 20 + ((h>>3) % 700);
  return {likes,dislikes,last:''};
}
function getVotes(slug){
  let store={}; try{store=JSON.parse(localStorage.getItem(LS_VOTE)||'{}')}catch{}
  if(!store[slug]) store[slug]=seedVotes(slug);
  localStorage.setItem(LS_VOTE, JSON.stringify(store));
  return store[slug];
}
function setVotes(slug,data){
  let store={}; try{store=JSON.parse(localStorage.getItem(LS_VOTE)||'{}')}catch{}
  store[slug]=data; localStorage.setItem(LS_VOTE, JSON.stringify(store));
}
function canVoteToday(v){ return (v.last||'')!==todayStr(); }
function doVote(slug,type){
  const v=getVotes(slug);
  if(!canVoteToday(v)){ toast('B·∫°n ƒë√£ b√¨nh ch·ªçn h√¥m nay. Quay l·∫°i v√†o ng√†y mai nha!'); return v; }
  if(type==='like') v.likes++;
  else v.dislikes++;
  v.last=todayStr(); setVotes(slug,v);
  return v;
}
function makeBurst(x,y){
  const s=document.createElement('span'); s.className='burst';
  s.style.left=x+'px'; s.style.top=y+'px';
  s.style.position='fixed'; document.body.appendChild(s);
  setTimeout(()=>s.remove(),600);
}

/* ===== Tag helpers ===== */
function epText(m){
  const cur = (m.episode_current||'').trim();
  if(!cur) return '';
  if(/full|ho√†n|hoan/i.test(cur)) return 'Tr·ªçn B·ªô';
  const mm = cur.match(/(\d+)\s*\/\s*(\d+)/);
  if(mm) return `T·∫≠p ${mm[1]} / ${mm[2]}`;
  const n = cur.match(/\d+/);
  if(n) return `T·∫≠p ${n[0]}`;
  return cur;
}
function langInfo(raw){
  const s=(raw||'').toLowerCase().trim();
  if(s.includes('ph·ª•') || s.includes('phu') || s.includes('sub') || s.includes('viet')) return {text:'Ph·ª• ƒë·ªÅ', cls:'pd'};
  if(s.includes('thuy·∫øt minh') || s.includes('thuyet minh') || s.includes('tm')) return {text:'Thuy·∫øt minh', cls:'tm'};
  if(s.includes('l·ªìng ti·∫øng') || s.includes('long tieng') || s.includes('dub') || s.includes('l·ªìng') || s.includes('long')) return {text:'L·ªìng ti·∫øng', cls:'lt'};
  return null;
}
function qShort(){ return ''; }

/* =============== UI building =============== */
function card(movie, cdn){
  const t=movie.name||movie.origin_name||'Kh√¥ng t√™n';
  const srcs=imgChain(movie.poster_url||movie.thumb_url||movie.poster||movie.image||'',cdn);

  const ep = epText(movie);
  const langInfoObj = langInfo(movie.lang||movie.sub||movie.audio||movie.lang_vi||'');
  const views = getViews(movie.slug||t);
  const viewsTag = `<span class="tag tag-views">üëÅ ${cfmt(views)}</span>`;

  const epTag = ep ? `<span class="tag tag-ep"><svg class="ic" viewBox="0 0 24 24"><path d="M3 5h18v4H3V5zm0 6h18v8a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-8zm4-9l3 5H6L3 2h4zm8 0l3 5h-4l-3-5h4z"/></svg>${ep}</span>` : '';
  const langTag = langInfoObj ? `<span class="tag tag-lang ${langInfoObj.cls}">${langInfoObj.text}</span>` : '';

  const div=document.createElement('div');
  div.className='movie';
  div.dataset.slug=movie.slug||'';
  div.setAttribute('tabindex','0'); div.setAttribute('role','button');
  div.setAttribute('aria-label',`Xem chi ti·∫øt ${t}`);

  const ratingStars = movie.imdb ? '<span class="rating">' + '‚òÖ'.repeat(Math.floor(movie.imdb / 2)) + '</span>' : '';

  div.innerHTML=`<div class="poster shine">
      ${epTag}${viewsTag}${langTag}
      <img src="${srcs[0]}" alt="${t.replace(/"/g,'&quot;')}" loading="lazy" decoding="async" referrerpolicy="no-referrer"
           data-f="${srcs.join('|')}" data-i="0" onerror="onImgError(this)">
      <div class="meta">
        <div class="tl">${t}</div>
        <div class="pills">
          ${movie.year?`<span class="pill">${movie.year}</span>`:''}
          ${ratingStars}
        </div>
      </div>
    </div>`;

  // Tilt
  const pEl=()=>div.querySelector('.poster'); let raf=0, lastX=0, lastY=0;
  div.addEventListener('pointermove',e=>{
    lastX=e.clientX; lastY=e.clientY; if(raf) return;
    raf=requestAnimationFrame(()=>{
      const r=pEl().getBoundingClientRect(), x=(lastX-r.left)/r.width, y=(lastY-r.top)/r.height;
      pEl().style.setProperty('--rx',((.5-y)*10)+'deg');
      pEl().style.setProperty('--ry',((x-.5)*10)+'deg'); raf=0;
    });
  },{passive:true});
  div.addEventListener('pointerleave',()=>{const p=pEl();p.style.setProperty('--rx','0deg');p.style.setProperty('--ry','0deg')});

  const go=()=>{ if(div.closest('.movie-row')?.dataset.dragging==='1') return; openDetail(movie.slug); };
  div.addEventListener('click',go);
  div.addEventListener('keydown',(e)=>{if(e.key==='Enter' || e.key===' '){e.preventDefault();go()}});

  return div;
}
function fillRow(containerId, items, cdn){
  const el=document.getElementById(containerId); if(!el) return;
  el.innerHTML=''; items.forEach(m=>el.appendChild(card(m,cdn)));
}
function skeletonRow(containerId,n=10){
  const el=document.getElementById(containerId); if(!el) return;
  el.innerHTML=''; for(let i=0;i<n;i++){const d=document.createElement('div');d.className='movie';d.innerHTML='<div class="skeleton"></div>';el.appendChild(d)}
}

/* BXH */
function renderRank(listEl, items, cdn){
  listEl.innerHTML='';
  items.slice(0,5).forEach((m,i)=>{
    const img=imgChain(m.poster_url||m.thumb_url||'',cdn)[0];
    const li=document.createElement('li');
    li.innerHTML=`
      <div class="no">${i+1}</div>
      <img src="${img}" alt="" loading="lazy" decoding="async" referrerpolicy="no-referrer">
      <div>
        <div style="font-weight:800">${m.name||m.origin_name||''}</div>
        <div style="color:#9aa4b5;font-size:13px">${m.origin_name?m.origin_name:''}${m.year?` ‚Ä¢ ${m.year}`:''}</div>
      </div>`;
    li.onclick=()=>openDetail(m.slug);
    listEl.appendChild(li);
  });
}

/* ===== Hero logic ===== */
const heroState={list:[],cdn:'https://phimimg.com',current:null};
function buildHero(m,cdn){
  if(!m) return;
  heroState.current=m;
  const poster=imgChain(m.poster_url||m.thumb_url||'',cdn)[0];
  $('#heroPoster').src=poster; $('#heroBg').style.backgroundImage=`url('${poster}')`;
  $('#heroTitle').textContent=m.name||m.origin_name||'';
  const b=[];
  if(m.year)b.push(`<span class="badge">${m.year}</span>`);
  $('#heroBadges').innerHTML=b.join('');
  $('#heroDesc').textContent=m.content || m.description || '...';
  $('#heroPlay').onclick=()=>openDetail(m.slug);
  $('#heroInfo').onclick=()=>openDetail(m.slug);
  $('#heroSave').onclick=()=>toggleFav(m);
}
function renderHeroStrip(){
  const s=$('#heroStrip'); s.innerHTML='';
  heroState.list.slice(0,20).forEach((it,idx)=>{
    const im=imgChain(it.poster_url||it.thumb_url||'',heroState.cdn)[0];
    const d=document.createElement('div'); d.className='hthumb'+(idx===0?' active':'');
    d.innerHTML=`<div class="box"><img src="${im}" alt="${(it.name||'').replace(/"/g,'&quot;')}" loading="lazy" decoding="async" referrerpolicy="no-referrer"></div>`;
    d.addEventListener('mouseenter',()=>{ $$('.hthumb').forEach(x=>x.classList.remove('active')); d.classList.add('active'); buildHero(it,heroState.cdn); });
    d.addEventListener('click',()=>openDetail(it.slug));
    s.appendChild(d);
  });
}

/* =============== Anime Vault =============== */
const animeState={list:[],cdn:'https://phimimg.com',current:null};
async function loadAnimeVault(){
  const urls=[
    `${API_V1}/the-loai/anime?page=1&limit=36`,
    `${API_V1}/the-loai/hoat-hinh?page=1&limit=36`,
    `${API_V1}/danh-sach/hoat-hinh?page=1&limit=36`
  ];
  for(const u of urls){
    try{
      const d=normList(await fetchJSON(u));
      if(d.items?.length){ animeState.list=d.items; animeState.cdn=d.cdn; break; }
    }catch{}
  }
  renderAnimeVault(animeState.list[0]);
}
$('#goMoreAnime').onclick=()=>startExplore('cat:hoat-hinh','Th·ªÉ lo·∫°i: Ho·∫°t h√¨nh');

function badgeEl(t){const s=document.createElement('span');s.className='badge2';s.textContent=t;return s}
function renderAnimeVault(movie){
  const m=movie||{};
  animeState.current=m;
  const poster=imgChain(m.poster_url||m.thumb_url||'',animeState.cdn)[0];
  $('#avBg').style.backgroundImage=`url('${poster||''}')`;
  $('#avTitle').textContent=m.name||m.origin_name||'ƒêang t·∫£i‚Ä¶';
  $('#avSub').textContent=m.origin_name||'';
  const bag=$('#avBadges'); bag.innerHTML='';
  if(typeof m.imdb==='number') bag.appendChild(badgeEl('IMDb '+m.imdb.toFixed(1)));
  if(m.year) bag.appendChild(badgeEl(m.year));
  if(m.episode_current){
    const num=(m.episode_current.match(/\d+/)||[])[0];
    if(num) bag.appendChild(badgeEl('T·∫≠p '+num));
  }
  if(m.quality) bag.appendChild(badgeEl(m.quality));
  const tg=$('#avTags'); tg.innerHTML='';
  (m.category||[]).slice(0,4).forEach(c=>{const t=document.createElement('span');t.className='tag';t.textContent=c.name; tg.appendChild(t);});
  $('#avDesc').textContent=(m.content||'').trim()||'...';

  $('#avPlay').onclick=()=>openDetail(m.slug);
  $('#avFav').onclick=()=>toggleFav({slug:m.slug,name:m.name||m.origin_name,poster_url:m.poster_url||m.thumb_url,year:m.year});
  $('#avInfo').onclick=()=>openDetail(m.slug);

  const strip=$('#avStrip'); strip.innerHTML='';
  animeState.list.slice(0,20).forEach((it)=>{
    const im=imgChain(it.poster_url||it.thumb_url||'',animeState.cdn)[0];
    const d=document.createElement('div'); d.className='av-thumb'+(it.slug===m.slug?' active':'');
    d.innerHTML=`<div class="box"><img src="${im}" alt="${(it.name||'').replace(/"/g,'&quot;')}" loading="lazy" decoding="async" referrerpolicy="no-referrer"><span class="cap">${(it.year||'')}</span></div>`;
    d.addEventListener('mouseenter',()=>{renderAnimeVault(it)});
    d.addEventListener('focus',()=>{renderAnimeVault(it)});
    d.addEventListener('click',()=>openDetail(it.slug));
    strip.appendChild(d);
  });
}

/* =============== Home data =============== */
async function loadHome(){
  try{
    ['row-hot','row-hq','row-tq','row-usuk','row-bo','row-le','row-anime','row-foru','row-upcoming','row-imdb'].forEach(id=>skeletonRow(id));
    loadAnimeVault();

    const urls=[`${API_BASE}/danh-sach/phim-moi-cap-nhat-v3?page=1`,`${API_BASE}/danh-sach/phim-moi-cap-nhat-v2?page=1`,`${API_BASE}/danh-sach/phim-moi-cap-nhat?page=1`];
    let hot=null; for(const u of urls){ try{ hot=normList(await fetchJSON(u)); break; }catch{} }
    if(hot){
      fillRow('row-hot', hot.items.slice(0,12), hot.cdn);
      heroState.list = hot.items.slice(0,18);
      heroState.cdn  = hot.cdn;
      buildHero(heroState.list[0],hot.cdn);
      renderHeroStrip();
    }

    loadBy(`${API_V1}/quoc-gia/han-quoc?page=1&limit=36`,'row-hq');
    loadBy(`${API_V1}/quoc-gia/trung-quoc?page=1&limit=36`,'row-tq');
    loadBy(`${API_V1}/quoc-gia/au-my?page=1&limit=36`,'row-usuk');

    loadByTry([
      `${API_V1}/the-loai/anime?page=1&limit=36`,
      `${API_V1}/the-loai/hoat-hinh?page=1&limit=36`,
      `${API_V1}/danh-sach/hoat-hinh?page=1&limit=36`
    ],'row-anime');

    loadBy(`${API_V1}/danh-sach/phim-bo?page=1&limit=36`,'row-bo');
    loadBy(`${API_V1}/danh-sach/phim-le?page=1&limit=36`,'row-le');

    loadRecommendations(hot);
    loadUpcoming(hot);
    loadTopIMDb(hot);

    (async()=>{
      try{
        const t=normList(await fetchJSON(`${API_V1}/danh-sach/phim-bo?page=1&limit=36`));
        renderRank($('#rank-trend'), t.items, t.cdn);
      }catch{}
      try{
        const f=favList();
        if(f && f.length){
          renderRank($('#rank-fav'), f.map(x=>({slug:x.slug,name:x.name,origin_name:x.name,poster_url:x.poster,year:x.year})), 'https://phimimg.com');
        }else if(hot){ renderRank($('#rank-fav'), hot.items, hot.cdn); }
      }catch{}
    })();

    setupRows();
  }catch(e){ toast('L·ªói t·∫£i trang ch·ªß', 3000, 'error'); }
}
async function loadBy(url, cid){ try{const d=normList(await fetchJSON(url)); fillRow(cid,d.items,d.cdn);}catch{} }
async function loadByTry(urls,cid){
  for(const u of urls){ try{ const d=normList(await fetchJSON(u)); if(d.items?.length){ fillRow(cid,d.items,d.cdn); return; } }catch{} }
}

/* ---- D·∫£i: ƒê·ªÅ xu·∫•t cho b·∫°n ---- */
async function loadRecommendations(hotData){
  skeletonRow('row-foru');
  let items=[], cdn='https://phimimg.com';
  const h=hisList();
  if(h && h.length){
    const slugs=h.slice(0,3).map(x=>x.slug);
    const catSet=new Set();
    for(const s of slugs){
      try{
        const d=await fetchJSON(`${API_BASE}/phim/${s}`);
        (d.movie?.category||[]).forEach(c=>catSet.add(c.slug||c.name));
      }catch{}
    }
    for(const cat of Array.from(catSet).slice(0,3)){
      try{
        const d=normList(await fetchJSON(`${API_V1}/the-loai/${cat}?page=1&limit=36`));
        cdn=d.cdn; items=items.concat(d.items.slice(0,12));
      }catch{}
    }
  }
  if(!items.length && hotData){ items=hotData.items.slice(0,12); cdn=hotData.cdn; }
  const seen=new Set(), uniq=[];
  items.forEach(m=>{ if(!seen.has(m.slug)){ seen.add(m.slug); uniq.push(m); }});
  fillRow('row-foru', uniq.slice(0,12), cdn);
}

/* ---- D·∫£i: S·∫Øp chi·∫øu ---- */
async function loadUpcoming(hotData){
  skeletonRow('row-upcoming');
  const sources=[
    `${API_V1}/danh-sach/phim-le?page=1&limit=36`,
    `${API_V1}/danh-sach/phim-le?page=2&limit=36`,
    `${API_V1}/danh-sach/phim-bo?page=1&limit=36`
  ];
  let list=[], cdn='https://phimimg.com';
  for(const u of sources){ try{ const d=normList(await fetchJSON(u)); cdn=d.cdn; list=list.concat(d.items); }catch{} }
  const nowY=new Date().getFullYear();
  const up=list.filter(m=>{
    const q=(m.quality||'').toLowerCase(), ec=(m.episode_current||'').toLowerCase(), st=(m.status||'').toLowerCase();
    return q.includes('trailer') || ec.includes('trailer') || st.includes('trailer') || (m.year && m.year>=nowY);
  }).sort((a,b)=>{
    const at=(''+a.quality).toLowerCase().includes('trailer')?1:0;
    const bt=(''+b.quality).toLowerCase().includes('trailer')?1:0;
    if(bt-at) return bt-at;
    return (b.year||0)-(a.year||0);
  });
  if(!up.length && hotData){ fillRow('row-upcoming', hotData.items.slice(12,24), hotData.cdn); }
  else fillRow('row-upcoming', up.slice(0,12), cdn);
}

/* ---- D·∫£i: Top IMDb ---- */
async function loadTopIMDb(hotData){
  skeletonRow('row-imdb');
  const sources=[
    `${API_V1}/danh-sach/phim-le?page=1&limit=36`,
    `${API_V1}/danh-sach/phim-bo?page=1&limit=36`,
    `${API_BASE}/danh-sach/phim-moi-cap-nhat-v3?page=1`
  ];
  let list=[], cdn='https://phimimg.com';
  for(const u of sources){ try{ const d=normList(await fetchJSON(u)); cdn=d.cdn; list=list.concat(d.items); }catch{} }
  list=list.filter(m=>typeof m.imdb==='number').sort((a,b)=>(b.imdb||0)-(a.imdb||0));
  if(!list.length && hotData){ fillRow('row-imdb', hotData.items.slice(0,12), hotData.cdn); }
  else fillRow('row-imdb', list.slice(0,12), cdn);
}

/* =============== Explore/Search =============== */
let explorePage=1, exploreType='phim-le', exploreKey='', exploreTotal=1, exploreCDN='https://phimimg.com';
const exploreFilters={cat:'',country:'',year:'',sort:'new'};
const TAX={cats:[],countries:[]};

function setView(id){
  ['home','explore','fav','his'].forEach(v=>document.getElementById(v).style.display=(v===id)?'block':'none');
  requestAnimationFrame(()=>window.scrollTo({top:0,behavior:'auto'}));
}
function setActiveTabByView(view){
  $$('#tabs .tab').forEach(x=>{
    const is = (x.dataset.view===view) || (view==='explore' && x.dataset.view==='explore' && x.dataset.type===exploreType);
    x.classList.toggle('active',is);
  });
}
$('#tabs').addEventListener('click',e=>{
  const t=e.target.closest('.tab'); if(!t) return;
  $$('#tabs .tab').forEach(x=>x.classList.remove('active')); t.classList.add('active');
  const view=t.dataset.view;
  if(view==='home'){ closePopup(); setView('home'); history.replaceState('',document.title,location.pathname); return; }
  if(view==='explore'){ exploreType=t.dataset.type; startExplore(exploreType,'Kh√°m ph√°: '+t.textContent); return; }
  if(view==='fav'){ renderFav(); setView('fav'); return; }
  if(view==='his'){ renderHistory(); setView('his'); return; }
});
document.getElementById('homeBtn').addEventListener('click',()=>{
  setView('home'); setActiveTabByView('home'); closePopup();
  history.replaceState('',document.title,location.pathname);
});
document.querySelectorAll('.chip[data-go]').forEach(c=>{
  c.onclick=()=>{
    const v=c.dataset.go;
    if(v==='quocgia-hq') startExplore('han-quoc','Kh√°m ph√°: H√†n Qu·ªëc');
    else if(v==='quocgia-tq') startExplore('trung-quoc','Kh√°m ph√°: Trung Qu·ªëc');
    else if(v==='quocgia-usuk') startExplore('au-my','Kh√°m ph√°: US-UK');
    else if(v==='cat-hoat-hinh') startExplore('cat:hoat-hinh','Th·ªÉ lo·∫°i: Ho·∫°t h√¨nh');
  };
});
document.querySelectorAll('.chip[data-key]').forEach(c=>c.onclick=()=>{const k=c.dataset.key;startExplore(k,`K·∫øt qu·∫£: ‚Äú${k}‚Äù`);location.hash='#search='+encodeURIComponent(k)});

/* Taxonomy */
async function fetchTaxonomies(){
  try{
    const catsRaw=await fetchJSON(`${API_V1}/the-loai`);
    const c=(catsRaw?.data?.items)||catsRaw?.items||catsRaw||[];
    let cats=c.map(x=>({slug:x.slug||x.key||x.name?.toLowerCase()?.replace(/\s+/g,'-')||'', name:x.name||x.title||x.key||''}))
              .filter(x=>x.slug&&x.name);
    cats=cats.filter(x=>x.slug!=='hoat-hinh');
    if(!cats.some(x=>x.slug==='anime')) cats.push({slug:'anime',name:'Anime'});
    TAX.cats=cats;
  }catch{
    TAX.cats=[
      {slug:'hanh-dong',name:'H√†nh ƒë·ªông'},{slug:'vien-tuong',name:'Vi·ªÖn t∆∞·ªüng'},
      {slug:'hai-huoc',name:'H√†i h∆∞·ªõc'},{slug:'kinh-di',name:'Kinh d·ªã'},
      {slug:'tam-ly',name:'T√¢m l√Ω'},{slug:'tinh-cam',name:'T√¨nh c·∫£m'},
      {slug:'anime',name:'Anime'}
    ];
  }
  try{
    const qgRaw=await fetchJSON(`${API_V1}/quoc-gia`);
    const q=(qgRaw?.data?.items)||qgRaw?.items||qgRaw||[];
    TAX.countries=q.map(x=>({slug:x.slug||x.key||x.name?.toLowerCase()?.replace(/\s+/g,'-')||'', name:x.name||x.title||x.key||''})).filter(x=>x.slug&&x.name);
  }catch{
    TAX.countries=[{slug:'au-my',name:'√Çu M·ªπ'},{slug:'han-quoc',name:'H√†n Qu·ªëc'},{slug:'trung-quoc',name:'Trung Qu·ªëc'},{slug:'nhat-ban',name:'Nh·∫≠t B·∫£n'},{slug:'thai-lan',name:'Th√°i Lan'},{slug:'viet-nam',name:'Vi·ªát Nam'}];
  }
}
function buildFilterOptions(){
  const fCat=$('#fCat'), fCountry=$('#fCountry'), fYear=$('#fYear');
  if(!TAX.cats.length || !TAX.countries.length) return;
  fCat.innerHTML='<option value="">T·∫•t c·∫£</option>'+TAX.cats.map(c=>`<option value="${c.slug}">${c.name}</option>`).join('');
  fCountry.innerHTML='<option value="">T·∫•t c·∫£</option>'+TAX.countries.map(c=>`<option value="${c.slug}">${c.name}</option>`).join('');
  const yNow=new Date().getFullYear();
  const ys=['<option value="">T·∫•t c·∫£</option>'];
  for(let y=yNow;y>=1990;y--) ys.push(`<option value="${y}">${y}</option>`);
  fYear.innerHTML=ys.join('');
  fCat.value=exploreFilters.cat||''; fCountry.value=exploreFilters.country||''; fYear.value=exploreFilters.year||''; $('#fSort').value=exploreFilters.sort||'new';
}
async function ensureFilterUI(){
  if($('#filterBar').dataset.ready==='1') return;
  await fetchTaxonomies(); buildFilterOptions(); $('#filterBar').dataset.ready='1';
  $('#fCat').onchange=()=>{ exploreFilters.cat=$('#fCat').value; startExplore('filters','K·∫øt qu·∫£ l·ªçc'); };
  $('#fCountry').onchange=()=>{ exploreFilters.country=$('#fCountry').value; startExplore('filters','K·∫øt qu·∫£ l·ªçc'); };
  $('#fYear').onchange=()=>{ exploreFilters.year=$('#fYear').value; startExplore('filters','K·∫øt qu·∫£ l·ªçc'); };
  $('#fSort').onchange=()=>{ exploreFilters.sort=$('#fSort').value; startExplore('filters','K·∫øt qu·∫£ l·ªçc'); };
  $('#fReset').onclick=()=>{ exploreFilters.cat=''; exploreFilters.country=''; exploreFilters.year=''; exploreFilters.sort='new'; buildFilterOptions(); startExplore('filters','Kh√°m ph√°'); };
}

function exploreCandidates(page){
  const urls=[];
  if(exploreKey){
    const p=new URLSearchParams({keyword:exploreKey,page,limit:36});
    urls.push(`${API_V1}/tim-kiem?${p}`); return urls;
  }
  if(exploreFilters.cat){
    urls.push(`${API_V1}/the-loai/${exploreFilters.cat}?page=${page}&limit=36`);
    if(exploreFilters.cat==='anime'){
      urls.push(`${API_V1}/the-loai/hoat-hinh?page=${page}&limit=36`);
      urls.push(`${API_V1}/danh-sach/hoat-hinh?page=${page}&limit=36`);
    } return urls;
  }
  if(exploreFilters.country){ urls.push(`${API_V1}/quoc-gia/${exploreFilters.country}?page=${page}&limit=36`); return urls; }
  if(exploreType.startsWith('cat:')){
    const slug=exploreType.split(':')[1];
    urls.push(`${API_V1}/the-loai/${slug}?page=${page}&limit=36`);
    if(['anime','hoat-hinh'].includes(slug)){
      urls.push(`${API_V1}/the-loai/hoat-hinh?page=${page}&limit=36`);
      urls.push(`${API_V1}/the-loai/anime?page=${page}&limit=36`);
      urls.push(`${API_V1}/danh-sach/hoat-hinh?page=${page}&limit=36`);
    } return urls;
  }
  if(['han-quoc','trung-quoc','au-my','nhat-ban','viet-nam'].includes(exploreType)){
    urls.push(`${API_V1}/quoc-gia/${exploreType}?page=${page}&limit=36`); return urls;
  }
  urls.push(`${API_V1}/danh-sach/${exploreType}?page=${page}&limit=36`); return urls;
}
function applyFilters(items){
  let arr=[...(items||[])];
  if(exploreFilters.country){
    arr=arr.filter(m=>{
      const c=(m.country||[]).map(x=>(x.slug||'').toLowerCase());
      return c.includes(exploreFilters.country.toLowerCase());
    });
  }
  if(exploreFilters.year){ arr=arr.filter(m=>String(m.year||'')===String(exploreFilters.year)); }
  switch(exploreFilters.sort){
    case 'year': arr.sort((a,b)=>(b.year||0)-(a.year||0)); break;
    case 'imdb': arr.sort((a,b)=>(b.imdb||0)-(a.imdb||0)); break;
    case 'az': arr.sort((a,b)=>( (a.name||a.origin_name||'').localeCompare(b.name||b.origin_name||'') )); break;
    default: break;
  }
  return arr;
}
async function startExplore(typeOrKey, title){
  setView('explore'); $('#grid').innerHTML=''; $('#exploreTitle').textContent=title||'Kh√°m ph√°';
  await ensureFilterUI();
  explorePage=1; exploreTotal=2; exploreCDN='https://phimimg.com'; exploreKey=''; exploreType='phim-le';
  if(typeof typeOrKey==='string'){
    if(typeOrKey==='filters'){ /* gi·ªØ filters */ }
    else if(typeOrKey.startsWith('cat:')) exploreType=typeOrKey;
    else if(['phim-le','phim-bo','tv-shows','hoat-hinh'].includes(typeOrKey)) exploreType=typeOrKey;
    else if(['han-quoc','trung-quoc','au-my','nhat-ban','viet-nam'].includes(typeOrKey)) exploreType=typeOrKey;
    else exploreKey=typeOrKey;
  }
  setActiveTabByView('explore');
  for(let i=0;i<12;i++){const d=document.createElement('div');d.className='skeleton';$('#grid').appendChild(d)}
  await loadMoreExplore();
}
async function loadMoreExplore(){
  if(explorePage>exploreTotal) return;
  try{
    const candidates = exploreCandidates(explorePage);
    let d=null;
    for(const u of candidates){
      try{
        const tmp=normList(await fetchJSON(u));
        if((tmp.items||[]).length){ d=tmp; break; }
      }catch{}
    }
    const grid=$('#grid');
    if(!d){
      if(explorePage===1){ grid.innerHTML='<p style="color:#9aa4b5">Kh√¥ng t√¨m th·∫•y n·ªôi dung cho m·ª•c n√†y.</p>'; }
      exploreTotal=0; return;
    }
    exploreCDN=d.cdn; exploreTotal=d.tp||exploreTotal||explorePage;
    let items=applyFilters(d.items||[]);
    if(explorePage===1) grid.innerHTML='';
    items.forEach(m=>grid.appendChild(card(m,exploreCDN)));
    explorePage++;
  }catch{
    if(explorePage===1) $('#grid').innerHTML='<p style="color:#9aa4b5">Kh√¥ng th·ªÉ t·∫£i danh s√°ch. Th·ª≠ l·∫°i sau.</p>';
    exploreTotal=0;
  }
}
const io=new IntersectionObserver(es=>{es.forEach(e=>{if(e.isIntersecting) loadMoreExplore()})},{rootMargin:'1200px'}); io.observe($('#sentinel'));

/* Search */
const debounce=(fn,ms=350)=>{let t;return(...a)=>{clearTimeout(t);t=setTimeout(()=>fn(...a),ms)}}
const doSearch=()=>{const k=$('#q').value.trim();if(!k)return toast('Nh·∫≠p t·ª´ kho√°', 2000, 'error');startExplore(k,`K·∫øt qu·∫£: ‚Äú${k}‚Äù`);location.hash='#search='+encodeURIComponent(k)}
$('#btnSearch').addEventListener('click',doSearch);
$('#q').addEventListener('input',debounce(()=>{const v=$('#q').value.trim();if(v.length>2) startExplore(v,`K·∫øt qu·∫£: ‚Äú${v}‚Äù`)},600));
$('#q').addEventListener('keypress',e=>{if(e.key==='Enter') doSearch()});
document.addEventListener('keydown',e=>{if(e.key==='/'&&document.activeElement!==$('#q')){e.preventDefault();$('#q').focus()}},{passive:true});

/* =============== Detail & Player (HLS) =============== */
let hls=null, currentMovie=null, currentEp=null, currentEps=[];
const LS_PLAYER={vol:'tp_vol',rate:'tp_rate',ql:'tp_ql_height',autonext:'tp_autonext'};

function loadHlsLib(cb){
  if(window.Hls){ cb(); return; }
  const s=document.createElement('script');
  s.src='https://cdn.jsdelivr.net/npm/hls.js@latest';
  s.onload=cb; document.head.appendChild(s);
}

async function openDetail(slug){
  if(!slug) return;
  try{
    const d=await fetchJSON(`${API_BASE}/phim/${slug}`);
    if(!d?.status) return toast('Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu', 3000, 'error');
    const m=d.movie||{}; currentMovie=m; location.hash='#/p/'+slug;
    const cdn=d.APP_DOMAIN_CDN_IMAGE||'https://phimimg.com';
    const poster=imgChain(m.poster_url||m.thumb_url||'',cdn)[0];

    $('#dPoster').src=poster;
    $('#dBg').style.backgroundImage=`url('${poster}')`;
    const views=getViews(m.slug||m.name||'');
    $('#dTitle').textContent=`${m.name||m.origin_name||''} ${m.year?`(${m.year})`:''}`;
    $('#dMeta').innerHTML=`‚è≥ ${m.time||'N/A'} ‚Ä¢ ${(m.country||[]).map(x=>x.name).join(', ')||'Kh√¥ng r√µ'} ‚Ä¢ üëÅ ${nfmt(views)} l∆∞·ª£t xem`;

    const desc=m.content||'Kh√¥ng c√≥ m√¥ t·∫£'; const el=$('#pDesc'); el.textContent=desc; const tg=$('#pToggle');
    if(desc.length>220){tg.style.display='inline-block';tg.textContent='Xem th√™m ‚ñº';tg.onclick=()=>{const ex=el.classList.toggle('exp');tg.textContent=ex?'Thu g·ªçn':'Xem th√™m ‚ñº'} } else tg.style.display='none';

    currentEps=(d.episodes||[]).flatMap(sv=>(sv.server_data||[]).map((ep,i)=>({name:ep.name||`T·∫≠p ${i+1}`,embed:ep.link_embed,m3u8:ep.link_m3u8})));
    const wrap=$('#eps'); wrap.innerHTML=''; currentEp=null;
    currentEps.forEach((ep,idx)=>{const b=document.createElement('button');b.textContent=ep.name; b.onclick=()=>selectEp(ep,b); if(idx===0){b.classList.add('sel');currentEp=ep;} wrap.appendChild(b)});

    renderCast(m.actor);
    loadSimilar(m);

    $('#btnPlayNow').textContent=currentEp?`Xem ngay (${currentEp.name})`:'Xem ngay';
    $('#btnPlayNow').onclick=()=>{ if(currentEp) play(currentEp); else toast('Ch∆∞a c√≥ t·∫≠p', 2000, 'error'); };
    $('#btnFav').onclick=()=>toggleFav(m);
    $('#btnShare').onclick=()=>{navigator.clipboard?.writeText(location.href); toast('ƒê√£ sao ch√©p link', 2000, 'success')};
    $('#btnReport').onclick=()=>{prompt('M√¥ t·∫£ l·ªói ph√°t (copy link n√†y g·ª≠i cho admin):', location.href)};
    $('#playerToolbar').style.display='flex';

    $('#autoNext').checked = JSON.parse(localStorage.getItem(LS_PLAYER.autonext) || 'true');

    // VOTES UI
    updateVotesUI(m.slug);
    $('#btnLike').onclick=(ev)=>{ doVote(m.slug,'like'); updateVotesUI(m.slug); makeBurst(ev.clientX,ev.clientY); };
    $('#btnDislike').onclick=()=>{ doVote(m.slug,'dislike'); updateVotesUI(m.slug); };

    openPopup(); cleanup();
    addHistory(m);
  }catch{toast('L·ªói t·∫£i chi ti·∫øt', 3000, 'error')}
}
function updateVotesUI(slug){
  const v=getVotes(slug);
  $('#likeCount').textContent=nfmt(v.likes);
  $('#dislikeCount').textContent=nfmt(Math.max(0,v.dislikes)); // ƒê·∫£m b·∫£o kh√¥ng √¢m
  const can=canVoteToday(v);
  $('#btnLike').classList.toggle('done',!can);
  $('#btnDislike').classList.toggle('done',!can);
}
function selectEp(ep, btn){
  currentEp=ep; $$('#eps button').forEach(x=>x.classList.remove('sel')); btn.classList.add('sel');
  $('#btnPlayNow').textContent=`Xem ngay (${ep.name})`;
}
function openPopup(){ $('#popup').style.display='flex'; window.scrollTo({top:0,behavior:'smooth'}) }
function closePopup(){
  cleanup(); $('#popup').style.display='none';
  if(location.hash.startsWith('#/p/')) history.pushState('',document.title,window.location.pathname+window.location.search);
}
$('#close').onclick=closePopup;
document.addEventListener('keydown',e=>{ if(e.key==='Escape' && $('#popup').style.display==='flex') closePopup() });
$('#popup').addEventListener('click',e=>{ if(e.target===e.currentTarget) closePopup() });

function cleanup(){ if(hls){try{hls.destroy()}catch{} hls=null} $('#player').innerHTML='<div class="loading" id="loading"></div>'; }

function createVideo(){
  const v=document.createElement('video'); v.controls=true; v.autoplay=true; v.playsInline=true; v.crossOrigin='anonymous'; v.preload='metadata';
  const vol=parseFloat(localStorage.getItem(LS_PLAYER.vol)||'0.9'); v.volume=isFinite(vol)?vol:0.9;
  const rate=parseFloat(localStorage.getItem(LS_PLAYER.rate)||'1'); v.playbackRate=isFinite(rate)?rate:1;
  v.addEventListener('volumechange',()=>localStorage.setItem(LS_PLAYER.vol, v.volume));
  v.addEventListener('ratechange',()=>localStorage.setItem(LS_PLAYER.rate, v.playbackRate));
  v.addEventListener('waiting',()=>$('#loading').style.display='grid');
  v.addEventListener('playing',()=>$('#loading').style.display='none');
  v.addEventListener('ended',()=>{ if($('#autoNext').checked){ const idx=currentEps.findIndex(x=>x===currentEp); const n=currentEps[idx+1]; if(n){ selectEp(n,$$('#eps button')[idx+1]); play(n); } } });
  // N√¢ng c·∫•p: L∆∞u ti·∫øn ƒë·ªô xem (m·ªói 10 gi√¢y)
  let progressTimer;
  v.addEventListener('timeupdate', () => {
    if (v.duration && v.currentTime > 0) {
      clearTimeout(progressTimer);
      progressTimer = setTimeout(() => {
        const progressKey = `pf_progress_${currentMovie.slug}_${currentEp.name}`;
        localStorage.setItem(progressKey, v.currentTime.toString());
      }, 10000); // L∆∞u m·ªói 10s ƒë·ªÉ tr√°nh spam
    }
  });
  // N√¢ng c·∫•p: T·∫£i ti·∫øn ƒë·ªô khi loadedmetadata
  v.addEventListener('loadedmetadata', () => {
    const progressKey = `pf_progress_${currentMovie.slug}_${currentEp.name}`;
    const saved = localStorage.getItem(progressKey);
    if (saved && parseFloat(saved) < v.duration - 5) { // Kh√¥ng resume n·∫øu g·∫ßn k·∫øt th√∫c
      v.currentTime = parseFloat(saved);
      toast('Ti·∫øp t·ª•c t·ª´ v·ªã tr√≠ ƒë√£ l∆∞u', 2000, 'success');
    }
  });
  // N√¢ng c·∫•p: X√≥a ti·∫øn ƒë·ªô khi xem h·∫øt
  v.addEventListener('ended', () => {
    const progressKey = `pf_progress_${currentMovie.slug}_${currentEp.name}`;
    localStorage.removeItem(progressKey);
  });
  // N√¢ng c·∫•p: Keyboard controls cho player (space pause/play, arrows seek)
  document.addEventListener('keydown', (e) => {
    if ($('#popup').style.display !== 'flex') return;
    if (e.key === ' ') { e.preventDefault(); if (v.paused) v.play(); else v.pause(); }
    if (e.key === 'ArrowRight') { v.currentTime += 10; }
    if (e.key === 'ArrowLeft') { v.currentTime -= 10; }
  }, { passive: false });
  return v;
}
function buildQualityMenu(levels){
  const sel=$('#qualitySelect'); sel.innerHTML='<option value="auto">Auto</option>';
  (levels||[]).forEach((lv,i)=>{ const opt=document.createElement('option'); opt.value=String(lv.height||i); opt.text=`${lv.height?lv.height+'p':''}${lv.name?(' '+lv.name):''}${lv.bitrate?(' ‚Ä¢ '+Math.round(lv.bitrate/1000)+'kbps'):''}`.trim()||`Level ${i}`; sel.appendChild(opt); });
}
function applyQualityPreference(levels){
  const pref=localStorage.getItem(LS_PLAYER.ql);
  if(!hls) return;
  if(!pref || pref==='auto'){ hls.currentLevel=-1; $('#qualitySelect').value='auto'; return; }
  const idx=(levels||[]).findIndex(l=>String(l.height)===pref);
  if(idx>=0){ hls.currentLevel=idx; $('#qualitySelect').value=String(levels[idx].height); }
  else { hls.currentLevel=-1; $('#qualitySelect').value='auto'; }
}
function attachToolbar(videoEl){
  $('#btnFS').onclick=()=>{ const c=$('#player'); if(document.fullscreenElement){document.exitFullscreen()} else { (c.requestFullscreen||c.webkitRequestFullscreen||(()=>{})).call(c) } };
  $('#btnPiP').onclick=async()=>{ try{ if(document.pictureInPictureElement){document.exitPictureInPicture()} else if(document.pictureInPictureEnabled){ await videoEl.requestPictureInPicture() } }catch{} };
  $('#btnReload').onclick=()=>{ if(currentEp) play(currentEp) };
  $('#speedSelect').onchange=()=>{ videoEl.playbackRate=parseFloat($('#speedSelect').value) };
  $('#autoNext').onchange=()=>localStorage.setItem(LS_PLAYER.autonext, JSON.stringify($('#autoNext').checked));
  // N√¢ng c·∫•p m·ªõi: Toggle subtitles (gi·∫£ ƒë·ªãnh c√≥ track, c·∫ßn c·∫•u h√¨nh th√™m n·∫øu c√≥ sub)
  $('#subToggle').onclick=()=>{ $('#subToggle').classList.toggle('active'); /* Logic toggle sub ·ªü ƒë√¢y n·∫øu c√≥ */ toast('Ph·ª• ƒë·ªÅ ƒë√£ toggle', 2000, 'success'); };
}
function play(ep){
  cleanup();
  const container=$('#player');
  const video=createVideo(); container.appendChild(video);
  attachToolbar(video);

  if('mediaSession' in navigator){
    try{
      navigator.mediaSession.metadata=new MediaMetadata({title:$('#dTitle').textContent,artist:'THANHPHAT',artwork:[{src:$('#dPoster').src,sizes:'512x728',type:'image/jpeg'}]});
    }catch{}
  }

  if(ep.m3u8 && ep.m3u8.endsWith('.m3u8')){
    loadHlsLib(()=>{
      if(window.Hls && window.Hls.isSupported()){
        // N√¢ng c·∫•p: C·∫•u h√¨nh HLS m∆∞·ª£t h∆°n - tƒÉng buffer, retry t·ªët h∆°n, low latency n·∫øu h·ªó tr·ª£
        hls=new Hls({
          enableWorker:true,
          lowLatencyMode:true, // B·∫≠t low latency cho m∆∞·ª£t h∆°n n·∫øu server h·ªó tr·ª£
          capLevelToPlayerSize:true,
          autoStartLoad:true,
          startLevel:-1, // B·∫Øt ƒë·∫ßu auto
          maxBufferLength:30, // TƒÉng buffer cho smooth
          maxMaxBufferLength:120,
          backBufferLength:90,
          fragLoadingMaxRetry:5, // TƒÉng retry cho ·ªïn ƒë·ªãnh
          manifestLoadingMaxRetry:3,
          levelLoadingMaxRetry:5,
          fragLoadingRetryDelay:1000,
          fragLoadingMaxRetryTimeout:5000
        });
        hls.attachMedia(video);
        hls.on(Hls.Events.MEDIA_ATTACHED,()=>{ hls.loadSource(ep.m3u8) });
        hls.on(Hls.Events.MANIFEST_PARSED,()=>{ buildQualityMenu(hls.levels||[]); applyQualityPreference(hls.levels||[]); $('#loading').style.display='none' });
        hls.on(Hls.Events.LEVEL_SWITCHED,(_,d)=>{ const lv=hls.levels?.[d.level]; if(lv?.height) localStorage.setItem(LS_PLAYER.ql,String(lv.height)); });
        // N√¢ng c·∫•p: X·ª≠ l√Ω l·ªói t·ªët h∆°n - retry ho·∫∑c fallback embed
        hls.on(Hls.Events.ERROR,(_,data)=>{
          console.warn('HLS Error:', data); // Log ƒë·ªÉ debug
          if(data.fatal){
            try{ hls.recoverMediaError(); }catch(e){
              toast('Ngu·ªìn HLS l·ªói, th·ª≠ embed...', 3000, 'error');
              if(ep.embed) playEmbed(ep.embed);
              else toast('Kh√¥ng c√≥ ngu·ªìn thay th·∫ø', 3000, 'error');
            }
          }
        });

        $('#qualitySelect').onchange=()=>{
          if(!hls) return;
          const v=$('#qualitySelect').value;
          if(v==='auto'){ hls.currentLevel=-1; localStorage.setItem(LS_PLAYER.ql,'auto'); }
          else{
            const idx=(hls.levels||[]).findIndex(l=>String(l.height)===v);
            if(idx>=0){ hls.currentLevel=idx; localStorage.setItem(LS_PLAYER.ql,v); }
          }
        };
      } else if(video.canPlayType('application/vnd.apple.mpegurl')){ 
        video.src=ep.m3u8; 
        $('#loading').style.display='none'; 
      }
      else { 
        if(ep.embed) playEmbed(ep.embed); 
        else toast('Thi·∫øt b·ªã kh√¥ng h·ªó tr·ª£ HLS', 3000, 'error'); 
      }
    });
  }else if(ep.embed){ playEmbed(ep.embed) } else { toast('Kh√¥ng c√≥ ngu·ªìn ph√°t', 3000, 'error') }

  setTimeout(()=>container.scrollIntoView({behavior:'smooth',block:'center'}),80);
}
function playEmbed(u){
  try {
    $('#player').innerHTML=`<iframe src="${u}" allow="autoplay; encrypted-media; picture-in-picture" referrerpolicy="no-referrer" allowfullscreen></iframe>`;
  } catch (e) {
    toast('L·ªói t·∫£i embed: ' + e.message, 3000, 'error');
  }
}

/* Di·ªÖn vi√™n & G·ª£i √Ω t∆∞∆°ng t·ª± */
function renderCast(actorField){
  const castEl=$('#cast'); castEl.innerHTML='';
  let names=[];
  if(Array.isArray(actorField)) names=actorField;
  else if(typeof actorField==='string') names=actorField.split(',').map(s=>s.trim());
  names=names.filter(Boolean);
  if(!names.length){ castEl.innerHTML='<span style="color:#9aa4b5">ƒêang c·∫≠p nh·∫≠t‚Ä¶</span>'; return; }
  names.slice(0,20).forEach(n=>{
    const sp=document.createElement('span'); sp.className='person'; sp.textContent=n; castEl.appendChild(sp);
  });
}
async function loadSimilar(movie){
  const cat=(movie?.category||[])[0]?.slug || (movie?.category||[])[0]?.name || '';
  const y=movie.year||'';
  const rowId='row-similar'; skeletonRow(rowId);
  let items=[], cdn='https://phimimg.com';
  if(cat){
    try{
      const d=normList(await fetchJSON(`${API_V1}/the-loai/${cat}?page=1&limit=36`));
      cdn=d.cdn; items=d.items||[];
    }catch{}
  }
  if(items.length && y){ items=items.filter(x=>Math.abs((x.year||0)-y)<=1); }
  items=items.filter(x=>x.slug!==movie.slug);
  if(!items.length){
    const q=movie?.country?.[0]?.slug; 
    if(q){ try{ const d=normList(await fetchJSON(`${API_V1}/quoc-gia/${q}?page=1&limit=36`)); cdn=d.cdn; items=(d.items||[]).filter(x=>x.slug!==movie.slug); }catch{} }
  }
  fillRow(rowId, items.slice(0,12), cdn);
  setupRows();
}

/* =============== Fav & History =============== */
function lsGet(k,def){try{return JSON.parse(localStorage.getItem(k)||def)}catch{return JSON.parse(def)}}
function lsSet(k,v){localStorage.setItem(k, JSON.stringify(v))}
function favList(){return lsGet('fav','[]')}
function isFav(slug){return favList().some(x=>x.slug===slug)}
function toggleFav(m){
  let f=favList();
  if(isFav(m.slug)){ f=f.filter(x=>x.slug!==m.slug); toast('ƒê√£ xo√° kh·ªèi Y√™u th√≠ch', 2000, 'success'); }
  else { 
    f.unshift({slug:m.slug,name:m.name||m.origin_name,poster:m.poster_url||m.thumb_url,year:m.year}); 
    toast('ƒê√£ l∆∞u Y√™u th√≠ch', 2000, 'success'); 
  }
  lsSet('fav',f); renderFav();
}
function renderFav(){
  const grid=$('#favGrid'); grid.innerHTML='';
  favList().forEach(x=>grid.appendChild(card(x,'https://phimimg.com')));
  if(!favList().length) grid.innerHTML='<p style="color:#9aa4b5">Ch∆∞a c√≥ m·ª•c y√™u th√≠ch n√†o.</p>';
}
function hisList(){return lsGet('his','[]')}
function addHistory(m){
  let h=hisList().filter(x=>x.slug!==m.slug);
  h.unshift({slug:m.slug,name:m.name||m.origin_name,poster:m.poster_url||m.thumb_url,year:m.year});
  h=h.slice(0,60); lsSet('his',h);
}
function renderHistory(){
  const grid=$('#hisGrid'); grid.innerHTML='';
  hisList().forEach(x=>grid.appendChild(card(x,'https://phimimg.com')));
  if(!hisList().length) grid.innerHTML='<p style="color:#9aa4b5">Ch∆∞a c√≥ l·ªãch s·ª≠ xem.</p>';
}

/* =============== Row Enhancer =============== */
function setupRows(){
  $$('.row').forEach(w=>{
    const row=w.querySelector('.movie-row');
    if(!row || w.dataset.enhanced) return; w.dataset.enhanced='1';

    // Drag to scroll
    let isDown=false,startX=0,sl=0;
    row.addEventListener('pointerdown',e=>{isDown=true;startX=e.clientX;sl=row.scrollLeft;row.classList.add('grabbing'); row.dataset.dragging='0';},{passive:false});
    row.addEventListener('pointermove',e=>{
      if(!isDown) return;
      const dx=e.clientX-startX;
      if(Math.abs(dx)>6) row.dataset.dragging='1';
      row.scrollLeft=sl-dx;
      e.preventDefault();
    },{passive:false});
    const end=()=>{ if(!isDown) return; isDown=false; row.classList.remove('grabbing'); setTimeout(()=>{row.dataset.dragging='0'},80); };
    row.addEventListener('pointerup',end);
    row.addEventListener('pointercancel',end);
    row.addEventListener('pointerleave',end);

    // Wheel d·ªçc => cu·ªôn ngang
    row.addEventListener('wheel',e=>{ if(Math.abs(e.deltaY) > Math.abs(e.deltaX)){ row.scrollBy({left:e.deltaY,behavior:'auto'}); e.preventDefault(); } },{passive:false});

    // Arrow buttons
    const left=document.createElement('button'); left.className='arrow left'; left.innerHTML='‚Äπ';
    const right=document.createElement('button'); right.className='arrow right'; right.innerHTML='‚Ä∫';
    left.onclick=()=>row.scrollBy({left:-row.clientWidth*0.9,behavior:'smooth'});
    right.onclick=()=>row.scrollBy({left: row.clientWidth*0.9,behavior:'smooth'});
    w.appendChild(left); w.appendChild(right);
  });
}

/* Routing */
window.addEventListener('hashchange',()=>{
  const h=location.hash;
  if(h.startsWith('#/p/')) openDetail(h.split('/p/')[1]);
  else if(h.startsWith('#search=')){ const kw=decodeURIComponent(h.split('=')[1]||''); $('#q').value=kw; startExplore(kw,`K·∫øt qu·∫£: ‚Äú${kw}‚Äù`) }
});

/* Kickoff */
loadHome();
</script>
</body>
</html>
