<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>ONFLIX PRO ‚Äì M·ªôc Edition</title>
  <meta name="description" content="ONFLIX PRO ‚Äì Kho phim chu·∫©n M·ªôc xanh ‚Äì tr·∫£i nghi·ªám m∆∞·ª£t, ph√°t HLS, ch·∫•t l∆∞·ª£ng tu·ª≥ ch·ªçn, ti·∫øp t·ª•c xem & y√™u th√≠ch.">
  <meta name="theme-color" content="#0B2A20" />
  <link rel="icon" href="https://cdn-icons-png.flaticon.com/512/5977/5977590.png">

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

  <!-- HLS -->
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>

  <style>
    /* =========================
       1) THEME M·ªòC (Green-Blue) ‚Äì Tinh ch·ªânh gradient m∆∞·ª£t h∆°n
       ========================= */
    :root{
      /* N·ªÅn */
      --bg-main: #020617;
      --bg-elev: rgba(13, 19, 33, .85);
      --bg-footer: #01040f;

      /* M·ªôc & Thu·ª∑ */
      --primary: #22c55e;        /* xanh l√° */
      --primary-600: #16a34a;
      --secondary: #3b82f6;      /* xanh d∆∞∆°ng */
      --secondary-500: #2563eb;

      /* Gradient b·∫£n m·ªánh ‚Äì Th√™m bi·∫øn m·ªõi cho hero */
      --moc-grad: linear-gradient(135deg, #22c55e 0%, #3b82f6 100%);
      --moc-grad-hero: linear-gradient(135deg, #16a34a 0%, #2563eb 50%, #22c55e 100%);
      --moc-grad-soft: linear-gradient(135deg, rgba(34,197,94,.16), rgba(59,130,246,.16));

      /* T·∫øt/Noel (gi·ªØ s·∫Øc ƒë·ªè nh·∫•n nh·∫π) */
      --xmas-red: #ef4444;

      /* VƒÉn b·∫£n ‚Äì Th√™m text-3 cho subtle */
      --text-1:#ffffff;
      --text-2:#94a3b8;
      --text-3:#64748b;

      /* K√≠ch th∆∞·ªõc ‚Äì T·ªëi ∆∞u mobile */
      --radius: 14px;
      --radius-lg: 20px;
      --header-h: 70px;
      --card-w: 180px;

      /* Shadow ‚Äì Th√™m shadow-hero cho hero */
      --shadow-1: 0 6px 22px rgba(0,0,0,.35);
      --shadow-2: 0 10px 30px rgba(0,0,0,.5);
      --shadow-hero: 0 20px 60px rgba(0,0,0,.6);
      --glow: 0 0 28px rgba(59,130,246,.28), 0 0 22px rgba(34,197,94,.22);
    }
    @media (max-width: 768px){ 
      :root{ 
        --card-w: 140px; 
        --header-h: 60px;
      } 
    }

    /* =========================
       2) RESET & GLOBAL ‚Äì Th√™m smooth-scroll
       ========================= */
    *{ box-sizing:border-box; outline:none; -webkit-tap-highlight-color:transparent; }
    html{ scroll-behavior:smooth; }
    html:focus-within{ scroll-behavior:smooth; }
    body{
      margin:0; background:radial-gradient(1200px 800px at 10% -10%, rgba(34,197,94,.08), transparent),
                 radial-gradient(1000px 700px at 110% 10%, rgba(59,130,246,.08), transparent),
                 var(--bg-main);
      color:var(--text-1);
      font-family:'Be Vietnam Pro', system-ui, sans-serif;
      padding-top:var(--header-h);
      overflow-x:hidden;
      line-height:1.6;
    }
    a{ color:inherit; text-decoration:none; }
    button{ cursor:pointer; font-family:inherit; border:none; }
    .container{ max-width:1500px; margin:0 auto; padding:0 4%; }
    .hidden{ display:none !important; }

    /* Scrollbar ‚Äì Tinh ch·ªânh cho mobile */
    ::-webkit-scrollbar{ width:8px; height:8px; }
    ::-webkit-scrollbar-track{ background:transparent; }
    ::-webkit-scrollbar-thumb{
      background: linear-gradient(to bottom, var(--primary), var(--secondary));
      border-radius: 999px;
    }
    @media (max-width: 768px) {
      ::-webkit-scrollbar { width: 6px; height: 6px; }
    }

    /* Focus ‚Äì C·∫£i thi·ªán accessibility */
    :focus-visible{ 
      outline:2px solid var(--secondary); 
      outline-offset:2px; 
      border-radius:8px; 
      box-shadow: var(--glow);
    }

    /* =========================
       3) HEADER ‚Äì Th√™m sticky m∆∞·ª£t
       ========================= */
    .header{
      position:fixed; inset:0 0 auto 0; height:var(--header-h);
      background:rgba(2,6,23,.78); backdrop-filter:saturate(140%) blur(10px);
      border-bottom:1px solid rgba(255,255,255,.06);
      z-index:1000; display:flex; align-items:center;
      transition: background .3s ease;
    }
    .header.scrolled { background: rgba(2,6,23,.95); }
    .nav{ display:flex; justify-content:space-between; align-items:center; width:100%; gap:16px; }
    .logo-wrap{ display:flex; align-items:center; gap:10px; cursor:pointer; }
    .logo{
      font-size:26px; font-weight:900; letter-spacing:-.5px;
      background:var(--moc-grad); -webkit-background-clip:text; background-clip:text; color:transparent;
      text-shadow: 0 6px 20px rgba(59,130,246,.25);
    }
    .logo span{ color:#fff; -webkit-text-stroke: .6px rgba(255,255,255,.25); }

    .search-box{ display:none; width:420px; position:relative; }
    @media(min-width:900px){ .search-box{ display:block; } }
    .search-input{
      width:100%; padding:12px 46px 12px 16px; border-radius:999px;
      background:rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.12);
      color:#fff; transition:.25s; font-weight:500;
    }
    .search-input:focus{ 
      border-color:var(--secondary); 
      background:rgba(255,255,255,.14); 
      box-shadow: 0 0 0 3px rgba(59,130,246,.2);
    }
    .search-input::placeholder { color: var(--text-2); opacity: 0.8; }
    .search-icon{
      position:absolute; right:12px; top:50%; transform:translateY(-50%); opacity:.8;
    }

    .menu{ display:none; gap:26px; font-weight:700; font-size:15px; }
    @media(min-width:900px){ .menu{ display:flex; } }
    .menu a{ color:var(--text-2); transition:.2s; position:relative; padding: 8px 0; }
    .menu a:hover, .menu a.active{ color:#fff; }
    .menu a.active::after{
      content:''; position:absolute; left:50%; bottom:-8px; transform:translateX(-50%);
      width:20px; height:3px; border-radius:999px; background:var(--moc-grad);
      box-shadow:var(--glow);
    }

    /* =========================
       4) HERO ‚Äì Th√™m parallax nh·∫π
       ========================= */
    .hero{
      position:relative; height:78vh; min-height:540px; margin-top:-70px;
      display:flex; align-items:center; overflow:hidden;
      border-bottom:1px solid rgba(255,255,255,.06);
    }
    #snow-canvas{ position:absolute; inset:0; pointer-events:none; z-index:5; opacity:.8; }
    .hero-bg{
      position:absolute; inset:0; background-size:cover; background-position:center top;
      filter: brightness(.62) saturate(1.05);
      mask-image: linear-gradient(to bottom, black 60%, transparent 100%);
      -webkit-mask-image: linear-gradient(to bottom, black 60%, transparent 100%);
      will-change: transform; transition:.5s;
    }
    .hero-bg::before { /* Parallax overlay */
      content: ''; position: absolute; inset: 0;
      background: var(--moc-grad-hero); opacity: 0.1;
    }
    .hero-overlay{
      position:absolute; inset:0;
      background: radial-gradient(60% 80% at 0% 50%, rgba(2,6,23,.9), transparent 70%),
                  linear-gradient(to right, rgba(2,6,23,.85) 10%, rgba(2,6,23,.35) 45%, transparent 100%);
    }
    .hero-content{ 
      position:relative; z-index:10; max-width:920px; padding-left:10px; 
      animation:slideUp .8s ease-out; text-shadow:0 2px 10px rgba(0,0,0,.8); 
    }
    .hero-badge{
      display:inline-flex; align-items:center; gap:8px; padding:6px 14px; border-radius:999px;
      background:linear-gradient(90deg, var(--primary), var(--secondary));
      color:#001b12; font-size:11px; font-weight:900; margin-bottom:14px;
      box-shadow:0 8px 26px rgba(59,130,246,.28), 0 6px 22px rgba(34,197,94,.26);
      animation: pulseGlow 2s infinite alternate;
    }
    @keyframes pulseGlow {
      from { box-shadow: 0 8px 26px rgba(59,130,246,.28), 0 6px 22px rgba(34,197,94,.26); }
      to { box-shadow: 0 8px 32px rgba(59,130,246,.35), 0 6px 28px rgba(34,197,94,.32); }
    }
    .hero-title{
      font-size: clamp(30px, 4.4vw, 52px);
      line-height:1.08; font-weight:900; margin:0 0 14px; text-transform:uppercase;
      color:#fff; display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden;
      background: linear-gradient(to right, var(--text-1), var(--secondary)); -webkit-background-clip: text; background-clip: text;
    }
    .hero-meta{ 
      color:#e2e8f0; font-size:14px; margin-bottom:24px; 
      display:flex; gap:18px; font-weight:600; 
    }
    .btn-play{
      padding:12px 42px; border-radius:999px; font-weight:800; font-size:15px; border:none;
      background:var(--moc-grad-hero); color:#012b1e; display:inline-flex; align-items:center; gap:10px; transition:.25s;
      box-shadow:0 0 25px rgba(59,130,246,.25), 0 0 25px rgba(34,197,94,.25);
    }
    .btn-play:hover{ 
      transform:translateY(-1px) scale(1.02); 
      box-shadow:0 0 35px rgba(59,130,246,.35), 0 0 35px rgba(34,197,94,.35);
    }

    /* =========================
       5) RANKING / ROWS / CARD ‚Äì Th√™m hover m∆∞·ª£t
       ========================= */
    .ranking-section{
      margin:-60px auto 40px; position:relative; z-index:10;
      display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:20px;
    }
    .rank-box{
      background:var(--bg-elev); padding:20px; border-radius:18px;
      border:1px solid rgba(148,163,184,.25); box-shadow:var(--shadow-1);
      transition: transform .2s ease, box-shadow .2s ease;
    }
    .rank-box:hover { transform: translateY(-2px); box-shadow: var(--shadow-2); }
    .rank-head{ 
      font-size:18px; font-weight:800; margin-bottom:14px; 
      display:flex; align-items:center; gap:10px; 
      background:var(--moc-grad); -webkit-background-clip:text; color:transparent; 
    }
    .rank-list{ display:flex; flex-direction:column; gap:10px; }
    .rank-item{ 
      display:flex; align-items:center; gap:14px; cursor:pointer; 
      padding:10px; border-radius:12px; transition:.18s; 
      position: relative; overflow: hidden;
    }
    .rank-item::before {
      content: ''; position: absolute; inset: 0; background: var(--moc-grad-soft); opacity: 0; transition: .18s;
    }
    .rank-item:hover{ 
      background:rgba(255,255,255,.06); 
      transform: translateX(4px);
    }
    .rank-item:hover::before { opacity: 1; }
    .rank-num{ font-size:24px; font-weight:900; color:rgba(255,255,255,.16); width:30px; text-align:center; z-index: 1; position: relative; }
    .rank-item:nth-child(1) .rank-num{ color:var(--secondary); text-shadow:var(--glow); }
    .rank-img{ 
      width:50px; height:70px; border-radius:8px; object-fit:cover; background:#0b1222; 
      transition: transform .2s; z-index: 1; position: relative;
    }
    .rank-item:hover .rank-img { transform: scale(1.05); }
    .rank-info h4{ margin:0 0 4px; font-size:13px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; max-width:220px; z-index: 1; position: relative; }
    .rank-info p{ margin:0; font-size:11px; color:var(--text-2); z-index: 1; position: relative; }

    .sec-header{ 
      display:flex; justify-content:space-between; align-items:flex-end; 
      margin:40px 0 14px; padding-bottom:10px; 
      border-bottom:1px solid rgba(255,255,255,.06); 
    }
    .sec-title{ 
      font-size:22px; font-weight:900; color:#fff; 
      display:flex; align-items:center; gap:10px; 
    }
    .sec-title::before{ 
      content:''; width:4px; height:20px; background:var(--moc-grad); 
      border-radius:4px; box-shadow:var(--glow); 
    }
    .sec-link{ 
      font-size:13px; color:var(--text-2); transition:.2s; cursor:pointer; 
      padding: 4px 8px; border-radius: 6px;
    }
    .sec-link:hover{ 
      color:#fff; background: rgba(255,255,255,.06);
    }

    .row-wrapper{ position:relative; }
    .row-wrapper:hover .nav-btn{ opacity:1; transform: translateY(0); }
    .row{ 
      display:flex; gap:16px; overflow-x:auto; padding:10px 4px 30px; 
      scroll-behavior:smooth; scroll-snap-type:x mandatory; 
    }
    .row::-webkit-scrollbar{ height:0; display:none; }
    .nav-btn{
      position:absolute; top:40%; transform:translateY(-50%) translateX(10px);
      width:44px; height:44px; border-radius:999px;
      background:rgba(0,0,0,.75); border:1px solid rgba(255,255,255,.24);
      color:#fff; display:grid; place-items:center; font-size:20px;
      cursor:pointer; z-index:10; opacity:0; transition:.18s; backdrop-filter:blur(4px);
    }
    .nav-btn:hover{ 
      background:var(--moc-grad); color:#001b12; border-color:transparent; 
      transform: translateY(-50%) scale(1.1);
    }
    .prev-btn{ left:-22px; } .next-btn{ right:-22px; }
    @media(max-width:768px){ .nav-btn{ display:none; } }

    .card{ 
      flex:0 0 var(--card-w); width:var(--card-w); scroll-snap-align:start; 
      cursor:pointer; position:relative; transition:.25s ease; 
    }
    .card:hover{ transform:translateY(-6px) scale(1.02); }
    .poster-frame{
      width:100%; aspect-ratio:2/3; border-radius:var(--radius);
      overflow:hidden; position:relative; background:#0b1222;
      box-shadow:var(--shadow-2); border:1px solid rgba(255,255,255,.06);
      transition: border-color .25s, box-shadow .25s;
    }
    .poster-img{ 
      position:absolute; inset:0; width:100%; height:100%; object-fit:cover; 
      transition:transform .45s ease, filter .45s ease; 
    }
    .card:hover .poster-img{ transform:scale(1.06); filter:brightness(.88) contrast(1.05); }
    .card:hover .poster-frame{ 
      border-color:rgba(59,130,246,.45); box-shadow:var(--glow); 
    }
    .ep-badge{
      position:absolute; top:8px; left:8px;
      background:rgba(2,6,23,.9); color:#e5e7eb;
      font-size:10px; font-weight:800; padding:3px 7px; border-radius:999px;
      border:1px solid rgba(255,255,255,.22);
    }
    .play-icon{
      position:absolute; top:50%; left:50%; transform:translate(-50%,-50%) scale(0);
      width:42px; height:42px; border-radius:999px;
      background:var(--moc-grad); color:#001b12; display:grid; place-items:center;
      transition:.24s ease; z-index:3; box-shadow:var(--glow);
    }
    .card:hover .play-icon{ transform:translate(-50%,-50%) scale(1); }
    .card-info{ padding:10px 2px 0; }
    .card-title{ 
      font-size:14px; font-weight:700; margin-bottom:4px; 
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis; color:#e2e8f0; 
      transition: color .2s;
    }
    .card:hover .card-title{ color:#fff; }
    .card-meta{ 
      font-size:11px; color:var(--text-2); display:flex; justify-content:space-between; 
    }

    /* =========================
       6) ANIME VAULT ‚Äì N√¢ng c·∫•p layout grid responsive
       ========================= */
    .anime-vault{
      margin-top:30px; padding:24px 22px; border-radius:24px;
      background: var(--moc-grad-soft), rgba(15,23,42,.96);
      border:1px solid rgba(148,163,184,.35);
      display:grid; grid-template-columns:minmax(0,2.3fr) minmax(0,3fr); gap:26px; position:relative; overflow:hidden;
      box-shadow: var(--shadow-hero);
    }
    .anime-vault::after{
      content:""; position:absolute; inset:0;
      background:linear-gradient(to right, rgba(148,163,184,.1), transparent 35%, transparent);
      pointer-events:none; opacity:.7;
    }
    @media(max-width:992px){ 
      .anime-vault{ 
        grid-template-columns:1fr; padding:20px 16px 18px; gap:20px; 
      } 
    }
    .anime-main{ display:flex; gap:18px; }
    @media(max-width:576px){ .anime-main{ gap:14px; flex-direction: column; } }
    .anime-main-poster{
      flex:0 0 140px; max-width:140px; aspect-ratio:2/3; border-radius:20px; overflow:hidden; position:relative;
      box-shadow:0 12px 30px rgba(0,0,0,.6); border:1px solid rgba(148,163,184,.45); cursor:pointer; background:#020617;
      transition: transform .3s ease;
    }
    .anime-main-poster:hover { transform: scale(1.02); }
    .anime-main-poster img{ width:100%; height:100%; object-fit:cover; transition:transform .35s, filter .35s; }
    .anime-main-poster:hover img{ transform:scale(1.06); filter:brightness(.9); }
    .anime-main-ep{
      position:absolute; bottom:8px; left:10px; padding:4px 10px; border-radius:999px; font-size:11px; font-weight:800;
      background:rgba(15,23,42,.9); color:#fefce8; border:1px solid rgba(250,250,250,.25);
    }
    .anime-main-body .av-actions .av-btn{ background:var(--moc-grad); color:#022c22; }
    .av-circle-btn:hover{ border-color:var(--secondary); color:var(--secondary); }

    .av-slider.row{ padding:10px 0 12px; gap:12px; }
    .av-card{ flex:0 0 120px; max-width:120px; cursor:pointer; scroll-snap-align:start; transition: transform .2s; }
    .av-card:hover { transform: translateY(-4px); }
    .av-card-poster{
      width:100%; aspect-ratio:2/3; border-radius:16px; overflow:hidden; position:relative; background:#020617;
      border:1px solid rgba(148,163,184,.35); box-shadow:0 8px 20px rgba(0,0,0,.55);
    }
    .av-card-ep{ 
      position:absolute; top:8px; left:8px; font-size:10px; padding:3px 7px; border-radius:999px; 
      background:rgba(15,23,42,.9); color:#e5e7eb; border:1px solid rgba(148,163,184,.6); 
    }
    .av-card-poster img{ width:100%; height:100%; object-fit:cover; transition:transform .35s, filter .35s; }
    .av-card:hover .av-card-poster img{ transform:scale(1.06); filter:brightness(.9); }

    /* =========================
       7) FOOTER ‚Äì Th√™m animation fade-in
       ========================= */
    .footer{
      background: linear-gradient(to bottom, var(--bg-footer), #000);
      padding:60px 0 40px; margin-top:80px; border-top:1px solid rgba(255,255,255,.06);
      animation: fadeInUp 1s ease-out 0.5s both;
    }
    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(30px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .foot-grid{ display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); gap:40px; margin-bottom:50px; }
    .foot-col h4{ color:#fff; font-size:16px; margin-bottom:22px; font-weight:800; text-transform:uppercase; letter-spacing:.6px; }
    .foot-col a{ 
      display:block; color:var(--text-2); margin-bottom:12px; transition:.2s; 
      font-size:14px; font-weight:600; padding: 4px 0;
    }
    .foot-col a:hover{ color:#fff; transform:translateX(5px); }
    .foot-bottom{ 
      border-top:1px solid rgba(255,255,255,.06); padding-top:38px; 
      display:flex; flex-direction:column; align-items:center; gap:16px; text-align:center; 
    }
    .vn-badge{
      display:inline-flex; align-items:center; gap:12px; padding:10px 22px;
      background:var(--moc-grad); color:#012b1e; font-size:14px; font-weight:900; text-transform:uppercase; letter-spacing:.5px;
      border-radius:999px; border: 2px solid rgba(255,255,255,.14); box-shadow:var(--glow); transition:.25s;
    }
    .vn-badge:hover{ transform:translateY(-1px) scale(1.02); }

    /* =========================
       8) PLAYER POPUP & CONTROLS (PRO) ‚Äì Th√™m smooth transitions
       ========================= */
    .popup{ 
      position:fixed; inset:0; background:rgba(0,0,0,.98); z-index:2000; 
      display:flex; opacity:0; pointer-events:none; transition:.3s ease; 
      justify-content:center; align-items:center; 
    }
    .popup.active{ opacity:1; pointer-events:all; }
    .popup-content{ 
      width:95%; max-width:1100px; max-height:95vh; overflow-y:auto; 
      padding:0; position:relative; animation: slideUp .3s ease-out; 
    }

    .btn-close-pop-fixed{
      position:absolute; top:10px; right:10px; width:36px; height:36px; border-radius:50%;
      background:rgba(0,0,0,.6); color:#fff; border:1px solid rgba(255,255,255,.2);
      font-size:22px; line-height:34px; text-align:center; transition:.2s; z-index:2010; 
      display:flex; align-items:center; justify-content:center; backdrop-filter:blur(6px);
    }
    .btn-close-pop-fixed:hover{ 
      background:var(--xmas-red); border-color:var(--xmas-red); transform:rotate(90deg) scale(1.1); 
    }

    .player-wrapper{ 
      position:relative; border-radius:18px; overflow:hidden; background:#000; 
      box-shadow:0 0 50px rgba(16,185,129,.1); cursor:pointer; transition: box-shadow .3s; 
    }
    .player-wrapper:hover { box-shadow: 0 0 60px rgba(16,185,129,.2); }
    .player-box{ position:relative; padding-top:56.25%; }
    .player-box video, .player-box iframe{ position:absolute; inset:0; width:100%; height:100%; }

    .controls-overlay{ 
      position:absolute; inset:0; 
      background:linear-gradient(to top, rgba(0,0,0,.9), transparent 42%); 
      display:flex; flex-direction:column; justify-content:flex-end; padding:18px; 
      opacity:0; transition:.25s ease; pointer-events:none; 
    }
    .player-wrapper:hover .controls-overlay, .player-wrapper.paused .controls-overlay{ 
      opacity:1; pointer-events:all; 
    }
    .controls-bar{ 
      display:flex; align-items:center; gap:14px; margin-top:10px; flex-wrap:wrap; 
    }

    .c-btn{
      background:none; border:1px solid rgba(255,255,255,.22); color:#fff; font-size:14px; 
      padding:8px 12px; border-radius:999px;
      transition:.2s ease; display:flex; align-items:center; gap:8px; opacity:.95; pointer-events:all;
      backdrop-filter: blur(4px); background:rgba(0,0,0,.45);
    }
    .c-btn:hover{ 
      border-color:var(--secondary); color:#fff; transform:translateY(-1px) scale(1.05); 
      background: rgba(59,130,246,.1);
    }
    .c-btn.strong{ 
      background:var(--moc-grad); color:#012b1e; border-color:transparent; 
    }
    .c-btn.strong:hover { background: var(--moc-grad-hero); transform: translateY(-1px); }

    .progress-container{ 
      width:100%; height:6px; background:rgba(255,255,255,.25); border-radius:999px; 
      cursor:pointer; position:relative; transition:.18s; pointer-events:all; 
    }
    .progress-container:hover{ height:8px; background: rgba(255,255,255,.35); }
    .progress-bar{ 
      height:100%; background:var(--moc-grad); border-radius:999px; width:0%; position:relative; 
      transition: width .1s ease;
    }

    .pill{ 
      border-radius:999px; background:rgba(0,0,0,.45); border:1px solid rgba(255,255,255,.22); 
      padding:6px 10px; display:flex; align-items:center; gap:8px; 
    }
    select.c-select{
      background:transparent; color:#fff; border:none; font-weight:700; outline:none; appearance:none; cursor:pointer;
    }
    select.c-select option { background: var(--bg-main); color: var(--text-1); }

    .resume-banner{
      position:absolute; left:18px; bottom:72px; padding:8px 12px; border-radius:12px;
      background:rgba(2,6,23,.7); border:1px solid rgba(255,255,255,.18); color:#fff; 
      display:none; gap:10px; align-items:center;
      animation: slideUp .2s ease-out;
    }
    .resume-banner.show{ display:flex; }

    .eps-list{ 
      display:flex; flex-wrap:wrap; gap:10px; padding:18px; 
      background:#0f172a; border-radius:0 0 18px 18px; 
      border-top: 1px solid rgba(255,255,255,.06);
    }
    .ep-btn{ 
      padding:8px 18px; background:rgba(255,255,255,.06); border-radius:999px; 
      color:#cbd5e1; border:1px solid rgba(255,255,255,.1); font-weight:700; transition:.18s; font-size:12px; 
    }
    .ep-btn:hover{ 
      background:rgba(255,255,255,.12); color:#fff; transform: scale(1.05);
    }
    .ep-btn.active{ 
      background:var(--moc-grad); color:#012b1e; border-color:transparent; 
      box-shadow: 0 0 10px rgba(34,197,94,.3);
    }

    /* =========================
       9) LAYOUT KH√ÅC ‚Äì Th√™m loading states m∆∞·ª£t
       ========================= */
    .grid-layout{ 
      display:grid; grid-template-columns: repeat(auto-fill, var(--card-w)); gap:20px; padding-bottom:50px; justify-content:center; 
    }
    .loader{ 
      text-align:center; padding:50px; color:var(--text-2); 
      display: flex; flex-direction: column; align-items: center; gap: 10px;
    }
    .loader::after {
      content: ''; width: 24px; height: 24px; border: 2px solid var(--text-2); border-top: 2px solid transparent; border-radius: 50%; animation: spin 1s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .skel-card{ 
      width:var(--card-w); height:260px; background:#0f172a; border-radius:12px; 
      animation:pulse 1.5s infinite; position: relative; overflow: hidden;
    }
    .skel-card::before {
      content: ''; position: absolute; inset: 0; background: linear-gradient(90deg, transparent, rgba(255,255,255,.1), transparent); transform: translateX(-100%); animation: shimmer 1.5s infinite;
    }
    @keyframes shimmer { to { transform: translateX(100%); } }
    @keyframes pulse{ 0%{opacity:.6;} 50%{opacity:1;} 100%{opacity:.6;} }
    @keyframes slideUp{ from{opacity:0; transform:translateY(26px);} to{opacity:1; transform:translateY(0);} }

    /* Mobile bar ‚Äì Th√™m ripple effect */
    .mobile-bar{
      position:fixed; bottom:0; left:0; right:0; height:60px; background:rgba(2,6,23,.98);
      display:flex; justify-content:space-around; align-items:center; border-top:1px solid rgba(255,255,255,.06); z-index:999;
      padding-bottom: env(safe-area-inset-bottom);
      backdrop-filter: blur(10px);
    }
    @media(min-width:768px){ .mobile-bar{ display:none; } body{ padding-bottom:0; } }
    .m-item{ 
      color:var(--text-2); display:flex; flex-direction:column; align-items:center; 
      font-size:10px; gap:4px; font-weight:800; transition: .2s ease;
      position: relative; overflow: hidden;
    }
    .m-item::before {
      content: ''; position: absolute; inset: 0; background: var(--moc-grad); opacity: 0; transition: .2s; transform: scale(0);
    }
    .m-item.active, .m-item:hover { color:#fff; }
    .m-item.active::before, .m-item:hover::before { opacity: .2; transform: scale(1); }
    .m-item:active::before { transform: scale(0.95); }

    /* Toast ‚Äì Th√™m slide-in */
    .toast{
      position:fixed; left:50%; bottom:80px; transform:translateX(-50%) translateY(20px);
      background:rgba(2,6,23,.92); color:#fff; border:1px solid rgba(255,255,255,.14);
      border-radius:12px; padding:10px 14px; z-index:3000; opacity:0; transition:.25s ease; pointer-events:none;
    }
    .toast.show{ opacity:1; transform:translateX(-50%) translateY(0); }

    /* Y√™u th√≠ch & Ti·∫øp t·ª•c xem ‚Äì Th√™m heart animation */
    .badge-fav{ 
      position:absolute; top:8px; right:8px; width:30px; height:30px; border-radius:999px; 
      display:grid; place-items:center; background:rgba(0,0,0,.55); border:1px solid rgba(255,255,255,.18); 
      transition: .2s ease;
    }
    .badge-fav.active{ 
      background:var(--moc-grad); color:#012b1e; border-color:transparent; 
      animation: heartBeat .6s ease-out;
    }
    @keyframes heartBeat {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.2); }
    }

  </style>
</head>
<body>

  <!-- Skip link -->
  <a href="#main" style="position:absolute;left:-9999px;top:-9999px;">B·ªè qua t·ªõi n·ªôi dung ch√≠nh</a>

  <!-- HEADER -->
  <header class="header" role="banner">
    <div class="container nav">
      <div class="logo-wrap" onclick="app.goHome()" aria-label="V·ªÅ Trang ch·ªß">
        <div class="logo">ONFLIX <span>PRO</span></div>
      </div>
      <div class="search-box" role="search">
        <input type="text" class="search-input" id="search" placeholder="T√¨m ki·∫øm phim, di·ªÖn vi√™n..." aria-label="T√¨m ki·∫øm">
        <div class="search-icon" aria-hidden="true">
          üîç
        </div>
      </div>
      <nav class="menu" aria-label="ƒêi·ªÅu h∆∞·ªõng ch√≠nh">
        <a class="active" onclick="app.goHome()">Trang Ch·ªß</a>
        <a onclick="app.goCat('phim-le', 'Phim L·∫ª')">Phim L·∫ª</a>
        <a onclick="app.goCat('phim-bo', 'Phim B·ªô')">Phim B·ªô</a>
        <a onclick="app.goCat('hoat-hinh', 'Anime')">Anime</a>
      </nav>
    </div>
  </header>

  <!-- MAIN -->
  <main id="main" tabindex="-1">
    <!-- HERO -->
    <section class="hero" aria-label="N·ªïi b·∫≠t">
      <canvas id="snow-canvas"></canvas>
      <div class="hero-bg" id="hero-bg" aria-hidden="true"></div>
      <div class="hero-overlay" aria-hidden="true"></div>
      <div class="container hero-content">
        <div class="hero-badge">‚Ä¢ MERRY CHRISTMAS ‚Ä¢</div>
        <h1 class="hero-title" id="hero-title">ƒêang t·∫£i...</h1>
        <div class="hero-meta" id="hero-meta"><span>...</span></div>
        <button class="btn-play" id="hero-play" aria-label="Xem ngay">
          ‚ñ∂ XEM NGAY
        </button>
      </div>
    </section>

    <div class="container">

      <!-- H√†ng c√° nh√¢n ho√° -->
      <section id="personal-rows"></section>

      <!-- Ranking -->
      <section class="ranking-section" aria-label="B·∫£ng x·∫øp h·∫°ng">
        <div class="rank-box">
          <div class="rank-head">TOP TH·ªäNH H√ÄNH</div>
          <div class="rank-list" id="rank-trending"><div class="loader">ƒêang t·∫£i...</div></div>
        </div>
        <div class="rank-box">
          <div class="rank-head">TOP Y√äU TH√çCH</div>
          <div class="rank-list" id="rank-favorite"><div class="loader">ƒêang t·∫£i...</div></div>
        </div>
      </section>

      <!-- KHO T√ÄNG ANIME -->
      <section class="anime-vault" id="anime-vault" aria-label="Kho t√†ng anime">
        <div class="anime-vault-left" id="anime-left">
          <div class="loader" style="padding:20px 0;">ƒêang t·∫£i kho t√†ng anime...</div>
        </div>
        <div class="anime-vault-right">
          <div>
            <p class="av-header-sub">Kho t√†ng anime</p>
            <h3 class="av-header-title">Kho T√†ng Anime M·ªõi Nh·∫•t</h3>
            <p class="av-header-desc">Th∆∞·ªüng th·ª©c ngay nh·ªØng b·ªô anime n√≥ng nh·∫•t, c·∫≠p nh·∫≠t li√™n t·ª•c v·ªõi ch·∫•t l∆∞·ª£ng cao, ƒë·∫ßy ƒë·ªß Vietsub/Thuy·∫øt minh.</p>
          </div>
          <div class="av-slider-wrapper">
            <button class="nav-btn prev-btn" onclick="app.scrollRow('anime-row',-1)" aria-label="L√πi">‚ùÆ</button>
            <div class="av-slider row" id="anime-row" aria-label="Danh s√°ch anime"></div>
            <button class="nav-btn next-btn" onclick="app.scrollRow('anime-row',1)" aria-label="Ti·∫øn">‚ùØ</button>
          </div>
        </div>
      </section>

      <!-- C√°c d·∫£i n·ªôi dung ch√≠nh -->
      <div id="main-lists"></div>
    </div>
  </main>

  <!-- CAT VIEW -->
  <div id="cat-view" class="container hidden" style="padding-top:100px; min-height:80vh;">
    <div class="sec-header" style="margin-top:0;">
      <div class="sec-title" id="cat-title">Danh s√°ch</div>
      <button onclick="app.goHome()" class="c-btn">‚Üê Quay l·∫°i</button>
    </div>
    <div class="grid-layout" id="cat-grid"></div>
  </div>

  <!-- FOOTER -->
  <footer class="footer">
    <div class="container">
      <div class="foot-grid">
        <div class="foot-col">
          <div class="logo" style="margin-bottom: 20px; font-size: 32px;">ONFLIX <span>PRO</span></div>
          <p style="color:var(--text-2); line-height:1.8; font-size:14px;">Tr·∫£i nghi·ªám ƒëi·ªán ·∫£nh b·∫£n m·ªánh M·ªôc ‚Äì xanh l√° & xanh d∆∞∆°ng, m∆∞·ª£t m√† v√† m·∫°nh m·∫Ω.</p>
        </div>
        <div class="foot-col">
          <h4>Kh√°m Ph√°</h4>
          <a onclick="app.goCat('phim-le', 'Phim L·∫ª')">Phim Chi·∫øu R·∫°p</a>
          <a onclick="app.goCat('phim-bo', 'Phim B·ªô')">Phim B·ªô ƒê·ªôc Quy·ªÅn</a>
          <a onclick="app.goCat('hoat-hinh', 'Anime')">Anime M√πa M·ªõi</a>
          <a onclick="app.goHome()">B·∫£ng X·∫øp H·∫°ng</a>
        </div>
        <div class="foot-col">
          <h4>Tr·ª£ Gi√∫p & Th√¥ng Tin</h4>
          <a href="#">V·ªÅ Ch√∫ng T√¥i</a>
          <a href="#">ƒêi·ªÅu Kho·∫£n S·ª≠ D·ª•ng</a>
          <a href="#">Ch√≠nh S√°ch B·∫£o M·∫≠t</a>
          <a href="#">Li√™n H·ªá Qu·∫£ng C√°o</a>
        </div>
      </div>
      <div class="foot-bottom">
        <div class="vn-badge"> Ho√†ng Sa & Tr∆∞·ªùng Sa l√† c·ªßa Vi·ªát Nam</div>
        <p id="copyright" style="color:var(--text-2); font-size:13px; margin-top: 10px; opacity:.85;"></p>
      </div>
    </div>
  </footer>

  <!-- PLAYER POPUP -->
  <div class="popup" id="player-pop" role="dialog" aria-modal="true" aria-label="Tr√¨nh ph√°t video">
    <div class="popup-content">
      <button class="btn-close-pop-fixed" onclick="player.close()" aria-label="ƒê√≥ng">‚úï</button>
      <div class="player-wrapper" id="p-wrapper">
        <div class="player-box" id="vid-wrap"></div>

        <!-- Resume banner -->
        <div class="resume-banner" id="resume-banner">
          <span>‚èØ Ti·∫øp t·ª•c t·ª´ <b id="resume-time">00:00</b>?</span>
          <button class="c-btn strong" id="resume-yes">Ti·∫øp t·ª•c</button>
          <button class="c-btn" id="resume-no">Xem t·ª´ ƒë·∫ßu</button>
        </div>

        <!-- Controls -->
        <div class="controls-overlay hidden" id="custom-controls">
          <div class="progress-container" id="prog-cont" aria-label="Thanh ti·∫øn tr√¨nh">
            <div class="progress-bar" id="prog-bar"></div>
          </div>
          <div class="controls-bar">
            <button class="c-btn" id="play-toggle" title="Space">‚ñ∂ / ‚è∏</button>
            <button class="c-btn" id="rewind-btn" title="‚Üê 10s">‚è™ 10s</button>
            <button class="c-btn" id="forward-btn" title="‚Üí 10s">‚è© 10s</button>
            <button class="c-btn" id="mute-toggle" title="M">üîá/üîä</button>

            <div class="pill">
              üîß
              <select id="quality-select" class="c-select" title="Ch·∫•t l∆∞·ª£ng">
                <option value="auto">Ch·∫•t l∆∞·ª£ng: Auto</option>
              </select>
            </div>
            <div class="pill">
              ‚è±
              <select id="speed-select" class="c-select" title="T·ªëc ƒë·ªô">
                <option value="0.5">0.5x</option>
                <option value="0.75">0.75x</option>
                <option value="1" selected>1x</option>
                <option value="1.25">1.25x</option>
                <option value="1.5">1.5x</option>
                <option value="2">2x</option>
              </select>
            </div>

            <button class="c-btn" id="pip-btn" title="Picture-in-Picture">PiP</button>
            <button class="c-btn" id="fs-btn" title="F">‚õ∂ To√†n m√†n h√¨nh</button>
          </div>
        </div>
      </div>

      <div style="margin-top:24px; padding:0 10px;">
        <h2 id="p-title" style="margin:0 0 14px; color:#fff; font-size:22px; font-weight:900;"></h2>
        <div class="eps-list" id="p-eps"></div>
      </div>
    </div>
  </div>

  <!-- MOBILE BAR -->
  <div class="mobile-bar" role="navigation" aria-label="Thanh ƒëi·ªÅu h∆∞·ªõng d∆∞·ªõi">
    <div class="m-item active" onclick="app.goHome()">üè† Home</div>
    <div class="m-item" onclick="app.goCat('phim-le', 'Phim L·∫ª')">üé¨ Phim L·∫ª</div>
    <div class="m-item" onclick="document.getElementById('search').focus()">üîé T√¨m</div>
    <div class="m-item" onclick="app.goCat('hoat-hinh', 'Anime')">üéå Anime</div>
  </div>

  <!-- Toast -->
  <div class="toast" id="toast" role="status" aria-live="polite"></div>

  <script>
    /* =========================
       API & Helpers ‚Äì Th√™m error handling t·ªët h∆°n
       ========================= */
    const API = {
      base: 'https://phimapi.com',
      img: 'https://phimimg.com',
      new: 'https://phimapi.com/danh-sach/phim-moi-cap-nhat?page=1'
    };
    const $ = document.querySelector.bind(document);
    const $$ = document.querySelectorAll.bind(document);

    const Storage = {
      get(k, def){ try{ return JSON.parse(localStorage.getItem(k)) ?? def; }catch{ return def; } },
      set(k, v){ localStorage.setItem(k, JSON.stringify(v)); }
    };
    const StoreKeys = {
      fav: 'onflix_fav',
      history: 'onflix_history',
      settings: 'onflix_settings'
    };
    const Settings = Storage.get(StoreKeys.settings, {
      autoplayNext: true,
      lastVolume: 0.9,
      lastSpeed: 1
    });

    /* =========================
       Snow ‚Äì T·ªëi ∆∞u performance
       ========================= */
    class Snowfall {
      constructor(){
        this.c = $('#snow-canvas');
        if (!this.c) return;
        this.ctx = this.c.getContext('2d');
        this.flakes = [];
        this.resize();
        window.addEventListener('resize', () => this.resize());
        this.loop();
      }
      resize(){ 
        if (!this.c) return;
        this.c.width = window.innerWidth; this.c.height = window.innerHeight; 
      }
      create(){ return { x:Math.random()*this.c.width, y:-10, s:Math.random()*3+1, v:Math.random()+0.5, o:Math.random()*0.5+0.3 }; }
      loop(){
        if (!this.ctx) return;
        this.ctx.clearRect(0,0,this.c.width,this.c.height);
        if(this.flakes.length<80) this.flakes.push(this.create());
        this.flakes.forEach((f,i)=>{
          f.y+=f.v;
          this.ctx.fillStyle=`rgba(255,255,255,${f.o})`;
          this.ctx.beginPath(); this.ctx.arc(f.x,f.y,f.s,0,Math.PI*2); this.ctx.fill();
          if(f.y>this.c.height) this.flakes.splice(i,1);
        });
        requestAnimationFrame(()=>this.loop());
      }
    }

    /* =========================
       Header Scroll Effect
       ========================= */
    let headerScrolled = false;
    window.addEventListener('scroll', () => {
      if (window.scrollY > 50 && !headerScrolled) {
        document.querySelector('.header').classList.add('scrolled');
        headerScrolled = true;
      } else if (window.scrollY <= 50 && headerScrolled) {
        document.querySelector('.header').classList.remove('scrolled');
        headerScrolled = false;
      }
    });

    /* =========================
       APP ‚Äì Th√™m debounce cho search
       ========================= */
    const app = {
      init(){
        new Snowfall();
        app.setupSections();
        app.loadHome();
        app.bindSearch();
        app.setYear();
      },
      setYear(){
        const y = new Date().getFullYear();
        $('#copyright').textContent = `¬© ${y} ONFLIX PRO ‚Äì MERRY CHRISTMAS`;
      },
      toast(msg, ms=2200){
        const t = $('#toast'); if(!t) return;
        t.textContent = msg; t.classList.add('show');
        setTimeout(()=>t.classList.remove('show'), ms);
      },
      debounce(fn, delay) {
        let timeout;
        return (...args) => {
          clearTimeout(timeout);
          timeout = setTimeout(() => fn(...args), delay);
        };
      },
      bindSearch(){
        let t; const input = $('#search');
        if(!input) return;
        const debouncedSearch = app.debounce((v) => {
          if(v.length>2) app.doSearch(v);
        }, 450);
        input.addEventListener('input', (e)=>{
          const v = e.target.value.trim();
          debouncedSearch(v);
        });
        input.addEventListener('keydown', (e)=>{
          if(e.key==='Enter'){
            const v = e.target.value.trim();
            if(v) app.doSearch(v);
          }
        });
      },
      setupSections(){
        const lists = [
          {id:'row-continue', t:'Ti·∫øp T·ª•c Xem (c·ªßa b·∫°n)', custom:true},
          {id:'row-favorite', t:'Y√™u Th√≠ch (c·ªßa b·∫°n)', custom:true},
          {id:'row-hot', t:'Phim M·ªõi C·∫≠p Nh·∫≠t', l:'phim-moi'},
          {id:'row-le', t:'Phim L·∫ª Tuy·ªÉn Ch·ªçn', l:'phim-le'},
          {id:'row-bo', t:'Phim B·ªô G√¢y C·∫•n', l:'phim-bo'},
          {id:'row-ani', t:'Anime / Ho·∫°t H√¨nh', l:'hoat-hinh'}
        ];

        // personal rows
        $('#personal-rows').innerHTML = ['row-continue','row-favorite'].map(id => `
          <div class="sec-header"><div class="sec-title">${id==='row-continue'?'Ti·∫øp T·ª•c Xem':'Y√™u Th√≠ch'}</div></div>
          <div class="row-wrapper">
            <button class="nav-btn prev-btn" onclick="app.scrollRow('${id}',-1)">‚ùÆ</button>
            <div class="row" id="${id}">${Array(5).fill('<div class="card"><div class="skel-card"></div></div>').join('')}</div>
            <button class="nav-btn next-btn" onclick="app.scrollRow('${id}',1)">‚ùØ</button>
          </div>
        `).join('');

        // main lists
        $('#main-lists').innerHTML = lists.filter(l=>!l.custom).map(l => `
          <div class="sec-header">
            <div class="sec-title">${l.t}</div>
            <div class="sec-link" onclick="app.goCat('${l.l}','${l.t}')">Xem t·∫•t c·∫£</div>
          </div>
          <div class="row-wrapper">
            <button class="nav-btn prev-btn" onclick="app.scrollRow('${l.id}',-1)">‚ùÆ</button>
            <div class="row" id="${l.id}">
              ${Array(6).fill('<div class="card"><div class="skel-card"></div></div>').join('')}
            </div>
            <button class="nav-btn next-btn" onclick="app.scrollRow('${l.id}',1)">‚ùØ</button>
          </div>
        `).join('');

        app.renderPersonalRows();
      },
      scrollRow(id, dir){
        const row = document.getElementById(id); if(!row) return;
        row.scrollBy({ left: dir * row.clientWidth * 0.8, behavior: 'smooth' });
      },
      fetch: async (u, retries = 2) => {
        for (let i = 0; i <= retries; i++) {
          try {
            const res = await fetch(u);
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            return await res.json();
          } catch (err) {
            if (i === retries) {
              console.error('Fetch error:', err);
              app.toast('L·ªói k·∫øt n·ªëi, vui l√≤ng th·ª≠ l·∫°i');
              return null;
            }
            await new Promise(resolve => setTimeout(resolve, 1000 * (i + 1)));
          }
        }
      },
      removeDuplicates(items){ const s=new Set(); return items.filter(x => s.has(x.slug) ? false : s.add(x.slug)); },
      getImgUrl(i, cdn){ let u = i.poster_url || i.thumb_url; if(u && u.startsWith('http')) return u; return `${cdn}/${u}`; },

      /* ===== Cards ===== */
      createCard(m, cdn, opts={}){
        const img = app.getImgUrl(m, cdn);
        const isFav = (Storage.get(StoreKeys.fav, []) || []).some(x => x.slug===m.slug);
        const favClass = isFav ? 'badge-fav active' : 'badge-fav';
        return `
          <div class="card" onclick="player.load('${m.slug}')" aria-label="${m.name}">
            <div class="poster-frame">
              <span class="ep-badge">${m.episode_current||'HD'}</span>
              <img class="poster-img" src="${img}" loading="lazy" alt="${m.name}" onerror="this.src='https://placehold.co/300x450/0b1222/FFF?text=No+Image'">
              <div class="play-icon">‚ñ∂</div>
              <button class="${favClass}" title="Y√™u th√≠ch" onclick="event.stopPropagation(); app.toggleFav('${m.slug}','${(m.name||'').replace(/'/g,'\\\'')}', '${img}');">‚ô•</button>
            </div>
            <div class="card-info">
              <div class="card-title">${m.name}</div>
              <div class="card-meta">
                <span>${m.year||new Date().getFullYear()}</span>‚Ä¢<span style="color:#bbf7d0">${m.lang||'Vietsub'}</span>
              </div>
            </div>
          </div>`;
      },
      createRankItem(m,i,cdn){
        const img = app.getImgUrl(m, cdn);
        return `
          <div class="rank-item" onclick="player.load('${m.slug}')">
            <div class="rank-num">${i+1}</div>
            <img class="rank-img" src="${img}" loading="lazy" alt="${m.name}">
            <div class="rank-info">
              <h4>${m.name}</h4>
              <p>${m.year||''} ‚Ä¢ ${m.lang||'Vietsub'}</p>
            </div>
          </div>`;
      },

      /* ===== Anime Vault ===== */
      createAnimeHighlight(m, cdn){
        const img = app.getImgUrl(m, cdn);
        const cats = (m.category || []).map(c => c.name).slice(0,3);
        const tagsHtml = cats.length ? `<div class="anime-main-tags">${cats.map(c=>`<span>${c}</span>`).join('')}</div>` : '';
        return `
          <div class="anime-main">
            <div class="anime-main-poster" onclick="player.load('${m.slug}')">
              <img src="${img}" alt="${m.name}" loading="lazy" onerror="this.src='https://placehold.co/300x450/020617/FFF?text=No+Image'">
              <span class="anime-main-ep">${m.episode_current || 'T·∫≠p m·ªõi'}</span>
            </div>
            <div class="anime-main-body">
              <p class="anime-main-label">Anime n·ªïi b·∫≠t</p>
              <h2 class="anime-main-title">${m.name}</h2>
              ${m.origin_name ? `<p class="anime-main-sub">${m.origin_name}</p>` : ''}
              <div class="anime-main-meta">
                <span>${m.year || new Date().getFullYear()}</span>
                ${m.time ? `<span>${m.time}</span>` : ''}
                <span>${m.lang || 'Vietsub'}</span>
              </div>
              ${tagsHtml}
              <div class="av-actions">
                <button class="c-btn strong" onclick="player.load('${m.slug}')">‚ñ∂ Xem ngay</button>
                <button class="c-btn" title="Th√™m v√†o y√™u th√≠ch" onclick="app.toggleFav('${m.slug}','${(m.name||'').replace(/'/g,'\\\'')}', '${img}')">‚ô•</button>
                <button class="c-btn" title="Xem danh s√°ch anime" onclick="app.goCat('hoat-hinh','Anime')">‚ìò</button>
              </div>
            </div>
          </div>`;
      },
      createAnimeMiniCard(m, cdn){
        const img = app.getImgUrl(m, cdn);
        return `
          <div class="av-card" onclick="player.load('${m.slug}')">
            <div class="av-card-poster">
              <img src="${img}" alt="${m.name}" loading="lazy" onerror="this.src='https://placehold.co/300x450/020617/FFF?text=No+Image'">
              <span class="av-card-ep">${m.episode_current || 'T·∫≠p m·ªõi'}</span>
            </div>
            <div class="av-card-title">${m.name}</div>
            <div class="av-card-meta">${m.year || ''} ‚Ä¢ ${m.lang || 'Vietsub'}</div>
          </div>`;
      },
      async loadAnimeVault(){
        const left = $('#anime-left');
        const row = $('#anime-row');
        if(!left || !row) return;
        row.innerHTML = '<div class="loader" style="padding:10px 0;">ƒêang t·∫£i anime...</div>';
        const d = await app.fetch('https://phimapi.com/v1/api/danh-sach/hoat-hinh?page=1&limit=18');
        if (!d?.data?.items?.length) {
          left.innerHTML = '<p style="color: var(--text-2); font-size: 14px;">Kh√¥ng th·ªÉ t·∫£i kho t√†ng anime.</p>';
          row.innerHTML = '';
          return;
        }
        const cdn = d.data.APP_DOMAIN_CDN_IMAGE;
        const uniq = app.removeDuplicates(d.data.items);
        left.innerHTML = app.createAnimeHighlight(uniq[0], cdn);
        row.innerHTML = uniq.slice(1).map(m => app.createAnimeMiniCard(m, cdn)).join('');
      },

      /* ===== Data ===== */
      async loadHome(){
        // Hero + Hot
        const d = await app.fetch(API.new);
        if(d && d.items){
          const cdn = d.pathImage || API.img;
          const h = d.items[0];
          $('#hero-bg').style.backgroundImage = `url('${app.getImgUrl(h, cdn)}')`;
          $('#hero-title').textContent = h.name;
          $('#hero-meta').innerHTML = `<span>${h.year}</span> ‚Ä¢ <span>${h.lang || 'Vietsub'}</span>`;
          $('#hero-play').onclick = () => player.load(h.slug);

          const uniq = app.removeDuplicates(d.items.slice(1));
          $('#row-hot').innerHTML = uniq.map(m => app.createCard(m, cdn)).join('');
          $('#rank-trending').innerHTML = uniq.slice(0,5).map((m,i) => app.createRankItem(m,i, cdn)).join('');
        }

        // Rows
        const loadRow = async (k, id, isRank=false) => {
          const r = await app.fetch(`https://phimapi.com/v1/api/danh-sach/${k}?page=1&limit=${isRank?10:18}`);
          if(!r?.data?.items) return;
          const u = app.removeDuplicates(r.data.items);
          if(isRank) $(id).innerHTML = u.slice(0,5).map((m,i)=>app.createRankItem(m,i, r.data.APP_DOMAIN_CDN_IMAGE)).join('');
          else $(id).innerHTML = u.map(m => app.createCard(m, r.data.APP_DOMAIN_CDN_IMAGE)).join('');
        };
        loadRow('phim-le', '#row-le');
        loadRow('phim-bo', '#row-bo');
        loadRow('hoat-hinh', '#row-ani');
        loadRow('phim-bo', '#rank-favorite', true);

        // Anime vault
        app.loadAnimeVault();

        // Personal
        app.renderPersonalRows();
      },

      renderPersonalRows(){
        const favs = Storage.get(StoreKeys.fav, []);
        const hist = Storage.get(StoreKeys.history, {}); // slug -> {title, poster, time, duration}

        // Continue row
        const contArr = Object.entries(hist)
          .filter(([,v]) => v && v.duration && v.time && v.time < v.duration - 20)
          .sort((a,b)=>b[1].updated - a[1].updated)
          .slice(0, 18)
          .map(([slug,v]) => ({ slug, name:v.title, year:'', lang:'Vietsub', poster_url:v.poster, episode_current:'Ti·∫øp t·ª•c' }));

        $('#row-continue').innerHTML = contArr.length
          ? contArr.map(m => app.createCard(m, '')).join('')
          : '<div class="loader">Ch∆∞a c√≥ l·ªãch s·ª≠ xem</div>';

        // Favorite row
        $('#row-favorite').innerHTML = favs.length
          ? favs.map(m => app.createCard(m, '')).join('')
          : '<div class="loader">Ch∆∞a c√≥ phim y√™u th√≠ch</div>';
      },

      toggleFav(slug, title, poster){
        let favs = Storage.get(StoreKeys.fav, []);
        const i = favs.findIndex(x => x.slug===slug);
        if(i>-1){
          favs.splice(i,1);
          app.toast('ƒê√£ xo√° kh·ªèi Y√™u th√≠ch');
        }else{
          favs.unshift({ slug, name:title, poster_url:poster, episode_current:'HD' });
          app.toast('ƒê√£ th√™m v√†o Y√™u th√≠ch');
        }
        Storage.set(StoreKeys.fav, favs);
        app.renderPersonalRows();
        // c·∫≠p nh·∫≠t icon ngay
        $$('.badge-fav').forEach(btn=>{
          const onclick = btn.getAttribute('onclick')||'';
          btn.classList.toggle('active', onclick.includes(`'${slug}'`));
        });
      },

      async goCat(t, title){
        app.toggleView(false);
        $('#cat-title').textContent = title;
        $('#cat-grid').innerHTML = '<div class="loader">ƒêang t·∫£i...</div>';
        const d = await app.fetch(`https://phimapi.com/v1/api/danh-sach/${t}?page=1&limit=36`);
        if(d?.data?.items) $('#cat-grid').innerHTML = app.removeDuplicates(d.data.items).map(m => app.createCard(m, d.data.APP_DOMAIN_CDN_IMAGE)).join('');
        else $('#cat-grid').innerHTML = '<div class="loader">Kh√¥ng t·∫£i ƒë∆∞·ª£c d·ªØ li·ªáu</div>';
      },
      async doSearch(kw){
        app.toggleView(false);
        $('#cat-title').textContent = `T√¨m: "${kw}"`;
        $('#cat-grid').innerHTML = '<div class="loader">ƒêang t√¨m...</div>';
        const d = await app.fetch(`https://phimapi.com/v1/api/tim-kiem?keyword=${encodeURIComponent(kw)}&limit=24`);
        if(d?.data?.items?.length) $('#cat-grid').innerHTML = app.removeDuplicates(d.data.items).map(m => app.createCard(m, d.data.APP_DOMAIN_CDN_IMAGE)).join('');
        else $('#cat-grid').innerHTML = '<div class="loader">Kh√¥ng t√¨m th·∫•y phim</div>';
      },
      goHome(){ app.toggleView(true); },
      toggleView(isHome){
        window.scrollTo(0,0);
        $('#home-view')?.classList?.toggle('hidden', !isHome);
        $('main')?.classList?.toggle('hidden', !isHome);
        $('#cat-view')?.classList?.toggle('hidden', isHome);
      }
    };

    /* =========================
       PLAYER (PRO) ‚Äì Th√™m better error handling
       ========================= */
    const player = {
      hls:null,
      videoEl:null,
      currentSlug:null,
      episodes:[],
      load: async(slug)=>{
        const r = await app.fetch(`${API.base}/phim/${slug}`);
        if(!r?.status){ app.toast('L·ªói t·∫£i phim'); return; }
        player.currentSlug = slug;
        const m = r.movie;
        const e = r.episodes?.[0]?.server_data || [];
        player.episodes = e;

        $('#p-title').textContent = m.name;
        $('#p-eps').innerHTML = e.map((x,i)=>`
          <button class="ep-btn ${i===0?'active':''}" onclick="player.play('${x.link_m3u8}','${x.link_embed}', this, ${i})">${x.name}</button>
        `).join('');

        $('#player-pop').classList.add('active');
        player.play(e[0]?.link_m3u8, e[0]?.link_embed, null, 0, {title:m.name, poster: app.getImgUrl(m, r.pathImage || API.img)});
      },

      play: (m3u8, embed, el=null, idx=0, meta=null)=>{
        if(el){ $$('.ep-btn').forEach(x=>x.classList.remove('active')); el.classList.add('active'); }
        $('#vid-wrap').innerHTML = '';
        $('#custom-controls').classList.add('hidden');
        $('#p-wrapper').classList.remove('paused');

        // Clear existing
        if(player.hls){ try{ player.hls.destroy(); }catch{} player.hls=null; }
        player.videoEl=null;

        // Try HLS first
        if(m3u8 && m3u8.includes('.m3u8') && Hls.isSupported()){
          const v=document.createElement('video');
          v.autoplay = true;
          v.playsInline = true;
          v.controls = false; // custom
          v.volume = Settings.lastVolume ?? 0.9;
          $('#vid-wrap').appendChild(v);
          player.videoEl=v;

          const hls = new Hls({ enableWorker:true, capLevelToPlayerSize:true, autoStartLoad:true });
          player.hls = hls;
          hls.loadSource(m3u8);
          hls.attachMedia(v);

          hls.on(Hls.Events.MANIFEST_PARSED, ()=>{
            // Quality options
            const levels = hls.levels || [];
            const qSel = $('#quality-select');
            qSel.innerHTML = `<option value="auto">Ch·∫•t l∆∞·ª£ng: Auto</option>` + levels
              .map((lv,i)=>`<option value="${i}">${(lv.height||'')+'p'}</option>`).join('');
            qSel.onchange = (e)=>{
              const val = e.target.value;
              if(val==='auto') hls.currentLevel = -1;
              else hls.currentLevel = parseInt(val,10);
              app.toast('ƒê√£ ƒë·ªïi ch·∫•t l∆∞·ª£ng');
            };

            // Speed
            const sSel = $('#speed-select');
            sSel.value = (Settings.lastSpeed||1).toString();
            v.playbackRate = Settings.lastSpeed||1;
            sSel.onchange = (e)=>{
              const sp = parseFloat(e.target.value);
              v.playbackRate = sp; Settings.lastSpeed = sp; Storage.set(StoreKeys.settings, Settings);
              app.toast(`T·ªëc ƒë·ªô ${sp}x`);
            };

            $('#custom-controls').classList.remove('hidden');
            player.initControls(v);

            // Resume logic
            const hist = Storage.get(StoreKeys.history, {});
            const key = player.currentSlug;
            const rec = hist[key];
            if(meta && meta.title && meta.poster){
              hist[key] = Object.assign({title:meta.title, poster:meta.poster}, rec||{});
              Storage.set(StoreKeys.history, hist);
            }
            if(rec && rec.time && rec.duration && rec.time < rec.duration - 20){
              const rb = $('#resume-banner'); const rt = $('#resume-time');
              rt.textContent = player.formatTime(rec.time);
              rb.classList.add('show');
              $('#resume-yes').onclick = ()=>{ v.currentTime = rec.time; rb.classList.remove('show'); };
              $('#resume-no').onclick = ()=>{ rb.classList.remove('show'); };
            }
          });

          hls.on(Hls.Events.ERROR, (_e, data)=>{
            if(data?.fatal){
              app.toast('L·ªói ph√°t HLS, chuy·ªÉn ngu·ªìn d·ª± ph√≤ng...');
              player.fallbackToEmbed(embed);
            }
          });

          // click to toggle play/pause except on buttons
          const wrap = $('#p-wrapper');
          wrap.onclick = (ev)=>{
            if(ev.target.closest('.c-btn') || ev.target.closest('.progress-container') || ev.target.closest('select')) return;
            if(!player.videoEl) return;
            v.paused ? v.play() : v.pause();
          };

        }else{
          player.fallbackToEmbed(embed);
        }
      },

      fallbackToEmbed(embed){
        if (!embed) {
          app.toast('Kh√¥ng c√≥ ngu·ªìn ph√°t');
          return;
        }
        $('#vid-wrap').innerHTML = `<iframe src="${embed}" allowfullscreen referrerpolicy="no-referrer" allow="autoplay; encrypted-media"></iframe>`;
        $('#custom-controls').classList.add('hidden');
      },

      initControls(v){
        const togglePlay=()=> v.paused ? v.play() : v.pause();
        const updateBtn=()=>{
          $('#play-toggle').textContent = v.paused ? '‚ñ∂ Ph√°t' : '‚è∏ T·∫°m d·ª´ng';
          $('#p-wrapper').classList.toggle('paused', v.paused);
        };
        $('#play-toggle').onclick=togglePlay;
        v.onplay=updateBtn; v.onpause=updateBtn;
        $('#rewind-btn').onclick=()=> v.currentTime = Math.max(0, v.currentTime - 10);
        $('#forward-btn').onclick=()=> v.currentTime = Math.min(v.duration||v.currentTime+10, v.currentTime + 10);
        $('#mute-toggle').onclick=()=>{ 
          v.muted=!v.muted; 
          $('#mute-toggle').textContent = v.muted ? 'üîá' : 'üîä';
        };
        $('#mute-toggle').textContent = v.muted ? 'üîá' : 'üîä';

        // PiP / Fullscreen
        $('#pip-btn').onclick=async()=>{
          if(document.pictureInPictureElement){ document.exitPictureInPicture(); return; }
          if(v.requestPictureInPicture){ try{ await v.requestPictureInPicture(); }catch{} }
        };
        $('#fs-btn').onclick=()=>{
          const el = $('#p-wrapper');
          if(document.fullscreenElement) document.exitFullscreen();
          else el.requestFullscreen?.();
        };

        // Speed/Quality handled on manifest parsed

        // Progress & save history
        let throttleTimer;
        v.ontimeupdate=()=>{
          const p = (v.currentTime/(v.duration||1))*100;
          $('#prog-bar').style.width = (isNaN(p)?0:p) + '%';

          // Save progress (throttle)
          clearTimeout(throttleTimer);
          throttleTimer = setTimeout(() => {
            if(!player.currentSlug) return;
            const hist = Storage.get(StoreKeys.history, {});
            const rec = hist[player.currentSlug] || {};
            hist[player.currentSlug] = {
              ...rec,
              time: Math.floor(v.currentTime),
              duration: Math.floor(v.duration||0),
              updated: Date.now()
            };
            Storage.set(StoreKeys.history, hist);
          }, 5000); // Save every 5s
        };
        $('#prog-cont').onclick=(e)=>{
          const rect = $('#prog-cont').getBoundingClientRect();
          const pos = (e.clientX - rect.left)/rect.width;
          v.currentTime = pos * (v.duration||0);
        };

        // Keyboard
        const keyHandler = (e)=>{
          if(!$('#player-pop').classList.contains('active')) return;
          if(e.code==='Escape'){ player.close(); return; }
          if(!player.videoEl) return;
          if(e.code==='Space'){ e.preventDefault(); togglePlay(); }
          if(e.code==='ArrowRight') v.currentTime += 10;
          if(e.code==='ArrowLeft') v.currentTime -= 10;
          if(e.key==='f' || e.key==='F') $('#fs-btn').click();
          if(e.key==='m' || e.key==='M') $('#mute-toggle').click();
        };
        document.addEventListener('keydown', keyHandler);
        player.close = () => {
          document.removeEventListener('keydown', keyHandler);
          // ... rest of close logic
          $('#player-pop').classList.remove('active');
          $('#vid-wrap').innerHTML='';
          if(player.hls){ try{ player.hls.destroy(); }catch{} }
          player.hls=null; player.videoEl=null;
          $('#p-wrapper').classList.remove('paused');
          app.renderPersonalRows();
        };

        // Remember volume
        v.onvolumechange = ()=>{
          Settings.lastVolume = v.muted ? 0 : v.volume;
          Storage.set(StoreKeys.settings, Settings);
        };

        // Autoplay next
        v.onended = ()=>{
          if(Settings.autoplayNext){
            const idx = [...$$('.ep-btn')].findIndex(b => b.classList.contains('active'));
            const next = $$('.ep-btn')[idx+1];
            if(next){ next.click(); app.toast('ƒêang ph√°t t·∫≠p k·∫ø ti·∫øp‚Ä¶'); }
          }
        };
      },

      close(){
        $('#player-pop').classList.remove('active');
        $('#vid-wrap').innerHTML='';
        if(player.hls){ try{ player.hls.destroy(); }catch{} }
        player.hls=null; player.videoEl=null;
        $('#p-wrapper').classList.remove('paused');
        document.onkeydown = null;
        app.renderPersonalRows();
      },

      formatTime(s){
        s = Math.floor(s||0);
        const h = Math.floor(s/3600), m = Math.floor((s%3600)/60), sec = s%60;
        return (h>0? (String(h).padStart(2,'0')+':'):'') + String(m).padStart(2,'0') + ':' + String(sec).padStart(2,'0');
      }
    };

    /* =========================
       BOOT
       ========================= */
    const Home = {
      mount(){
        // gi·ªØ id home-view ƒë·ªÉ t∆∞∆°ng th√≠ch toggle c≈©
        const main = document.querySelector('main');
        main.id = 'home-view';
      }
    };
    Home.mount();
    app.init();
  </script>

  <!-- JSON-LD (SEO g·ªçn) -->
  <script type="application/ld+json">
  {
    "@context":"https://schema.org",
    "@type":"WebSite",
    "name":"ONFLIX PRO ‚Äì M·ªôc Edition",
    "url":"https://example.com/",
    "potentialAction":{
      "@type":"SearchAction",
      "target":"https://example.com/?q={search_term_string}",
      "query-input":"required name=search_term_string"
    }
  }
  </script>
</body>
</html>
