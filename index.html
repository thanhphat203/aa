<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>THANHPHAT ‚Ä¢ Phim Tr·ª±c Tuy·∫øn ‚Äì M∆∞·ª£t & ƒêi·ªán ·∫¢nh</title>
<meta name="description" content="THANHPHAT ‚Äì duy·ªát & xem th√¥ng tin phim m∆∞·ª£t." />
<meta name="theme-color" content="#0b1020" />
<meta property="og:type" content="website" />
<meta property="og:title" content="THANHPHAT ‚Ä¢ Phim Tr·ª±c Tuy·∫øn ‚Äì M∆∞·ª£t & ƒêi·ªán ·∫¢nh" />
<meta property="og:description" content="Duy·ªát & xem phim m∆∞·ª£t nh∆∞ app." />
<meta property="og:image" content="https://i.postimg.cc/8P1JNgVV/Black-White-Modern-Grunge-Typographic-Brand-Logo-1-Edited.png" />

<link rel="dns-prefetch" href="https://phimapi.com">
<link rel="dns-prefetch" href="https://phimimg.com">
<link rel="preconnect" href="https://phimapi.com" crossorigin>
<link rel="preconnect" href="https://phimimg.com" crossorigin>

<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@600;700&family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">

<script type="application/ld+json">
{
 "@context":"https://schema.org",
 "@type":"WebSite",
 "name":"THANHPHAT",
 "url":"/",
 "potentialAction":{
   "@type":"SearchAction",
   "target":"/#search={search_term_string}",
   "query-input":"required name=search_term_string"
 }
}
</script>

<style>
:root{
  --bg:#0b1020;--panel:#11172c;--panel2:#0e152b;--ring:#2563eb;
  --accent:#e50914;--accent2:#7c3aed;--text:#f5f7fb;--muted:#97a2b3;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; color:var(--text);
  font-family:"Plus Jakarta Sans",system-ui,Segoe UI,Roboto,Arial,sans-serif;
  background:
    radial-gradient(900px 600px at 50% -200px, rgba(59,130,246,.25), transparent 60%),
    linear-gradient(180deg, rgba(2,6,23,.85), rgba(2,6,23,0)),
    var(--bg);
}
a{color:inherit}
.container{max-width:1160px;margin:0 auto;padding:0 12px}

/* Header */
.hdr{position:sticky;top:0;z-index:60;backdrop-filter:blur(10px);
  background:linear-gradient(180deg,rgba(7,11,24,.85),rgba(7,11,24,.5));border-bottom:1px solid rgba(255,255,255,.06)}
.hdr__row{display:grid;grid-template-columns:auto 1fr auto;gap:12px;align-items:center;padding:10px 12px}
.brand{display:flex;align-items:center;gap:10px}
.brand img{height:42px}
.brand__t{font-family:"Cinzel",serif;font-weight:800;letter-spacing:.5px;
  background:linear-gradient(90deg,#c7d2fe,#f0abfc);-webkit-background-clip:text;background-clip:text;color:transparent;text-shadow:0 0 16px rgba(124,58,237,.25)}
.tabs{display:flex;gap:8px;overflow-x:auto;padding-bottom:4px}
.tab{padding:8px 12px;border-radius:999px;border:1px solid rgba(255,255,255,.08);background:rgba(255,255,255,.05);color:#e5e7eb;white-space:nowrap;cursor:pointer}
.tab.active{background:linear-gradient(135deg,#2563eb,#7c3aed);border-color:transparent;box-shadow:0 6px 18px rgba(124,58,237,.25)}
.search{display:flex;gap:8px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:8px 10px}
.search input{flex:1;background:transparent;border:0;color:var(--text);outline:0}
.btn{background:linear-gradient(135deg,#2563eb,#7c3aed);color:#fff;border:0;padding:9px 12px;border-radius:12px;font-weight:800;cursor:pointer}
.btn-pill{border-radius:999px}

/* Hero */
.hero{position:relative;min-height:210px;padding:28px 0 8px;margin-bottom:6px}
.hero__card{position:relative;border-radius:18px;overflow:hidden;border:1px solid rgba(255,255,255,.06);background:#0b1224}
.hero__bg{position:absolute;inset:0;background-size:cover;background-position:center;filter:blur(14px) saturate(1.2);transform:scale(1.12);opacity:.45}
.hero__overlay{position:absolute;inset:0;background:linear-gradient(90deg,rgba(8,12,28,.92),rgba(8,12,28,.72),rgba(8,12,28,.2))}
.hero__body{position:relative;display:flex;gap:16px;padding:16px}
.hero__poster{width:140px;border-radius:14px;overflow:hidden;flex:0 0 auto;background:#0e1426;border:1px solid rgba(255,255,255,.06)}
.hero__poster img{width:100%;height:210px;object-fit:cover;display:block}
.badges{display:flex;flex-wrap:wrap;gap:6px;margin:6px 0}
.badge{font-size:12px;padding:4px 8px;border-radius:999px;background:rgba(255,255,255,.09);border:1px solid rgba(255,255,255,.12)}
.hero h1{margin:4px 0 6px;font-size:20px;font-weight:800}
.hero .desc{color:#d0d6e5;max-height:66px;overflow:hidden}

/* Sections */
.sec{display:flex;align-items:center;justify-content:space-between;margin:14px 2px 8px}
.sec h2{font-size:18px;margin:0;color:#dbeafe;text-shadow:0 2px 14px rgba(59,130,246,.25)}
.row{position:relative}
.movie-row{display:flex;gap:14px;overflow-x:auto;padding:2px 2px 14px;scroll-behavior:smooth}
.nav{position:absolute;inset-block:auto 20px;top:calc(50% - 36px);width:44px;height:44px;display:grid;place-items:center;border-radius:50%;
  border:1px solid rgba(255,255,255,.12);background:rgba(10,16,31,.6);cursor:pointer;z-index:5}
.nav:hover{transform:scale(1.06)}.nav.left{left:-6px}.nav.right{right:-6px}

.movie{width:176px;flex:0 0 auto;cursor:pointer;perspective:700px}
.poster{position:relative;height:0;padding-top:150%;border-radius:16px;overflow:hidden;background:#0e1426;border:1px solid rgba(255,255,255,.06);
  transform:perspective(700px) rotateX(var(--rx,0)) rotateY(var(--ry,0))}
.poster img{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;display:block}
.shine::after{content:"";position:absolute;inset:-130% -50% auto auto;width:60%;height:220%;transform:rotate(25deg);opacity:0;
  background:linear-gradient(90deg,transparent,rgba(255,255,255,.18),transparent);transition:transform .4s ease,opacity .4s ease}
.movie:hover .shine::after{transform:translateX(-40%) rotate(25deg);opacity:.9}
.movie:hover .poster{transform:perspective(700px) rotateX(calc(var(--rx,0)*1.15)) rotateY(calc(var(--ry,0)*1.15)) translateZ(6px)}
.meta{position:absolute;left:8px;right:8px;bottom:8px;background:linear-gradient(180deg,transparent,rgba(0,0,0,.85));border-radius:12px;padding:46% 8px 8px}
.tl{font-size:13px;font-weight:800;line-height:1.3;margin-bottom:6px}
.pills{display:flex;gap:6px;flex-wrap:wrap}
.pill{font-size:11px;padding:3px 6px;border-radius:999px;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.1)}

/* Grid Explore/Search */
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:14px}
#explore{padding-bottom:22px}

/* Skeleton */
.skeleton{position:relative;overflow:hidden;background:#0f162b;border-radius:16px;height:0;padding-top:150%}
.skeleton::after{content:"";position:absolute;inset:0;background:linear-gradient(90deg,transparent,rgba(255,255,255,.08),transparent);transform:translateX(-100%);animation:sh 1.4s infinite}
@keyframes sh{to{transform:translateX(100%)}}
.toast{position:fixed;left:50%;transform:translateX(-50%);bottom:22px;background:#0b1220;border:1px solid #22304c;color:#fff;padding:10px 14px;border-radius:10px;box-shadow:0 10px 24px rgba(0,0,0,.35);z-index:80}

/* Popup */
.popup{position:fixed;inset:0;display:none;justify-content:center;align-items:flex-start;background:rgba(0,0,0,.9);z-index:90;overflow:auto;padding:30px 12px}
.popup-content{width:100%;max-width:1100px;display:flex;flex-direction:column;gap:12px}
.player{width:100%;aspect-ratio:16/9;background:#000;border-radius:12px;overflow:hidden;border:1px solid rgba(255,255,255,.06)}
.player video,.player iframe{width:100%;height:100%;border:0;display:block}
.pb{display:flex;gap:18px;flex-wrap:wrap;padding:8px}
.pb img{width:240px;border-radius:12px;object-fit:cover}
.pi{flex:1;min-width:260px}
.pi h3{margin:0 0 6px;font-size:24px;font-family:"Cinzel",serif}
.pi .m{color:var(--muted);font-size:14px;line-height:1.5}
.desc{color:#e6e6f0;margin-top:10px;font-size:15px;line-height:1.6;max-height:110px;overflow:hidden;transition:max-height .25s ease}
.desc.exp{max-height:640px}
.toggle{margin-top:10px;padding:8px 12px;background:#1d2542;border-radius:8px;border:1px solid rgba(255,255,255,.08);cursor:pointer}
.eps{margin-top:12px;display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:8px}
.eps button{padding:8px;background:#151c36;border:1px solid rgba(255,255,255,.08);color:white;border-radius:8px;cursor:pointer;font-weight:800}
.close{position:fixed;right:18px;top:18px;font-size:30px;color:white;cursor:pointer;z-index:95}

footer{background:var(--panel);color:var(--muted);padding:24px 12px;border-top:1px solid rgba(255,255,255,.08);margin-top:36px;text-align:center}
footer .footer-content{max-width:900px;margin:0 auto}
footer h3{color:#a78bfa;margin-bottom:12px}
footer a{color:#93c5fd}
@media(max-width:640px){.movie{width:44.5vw;max-width:200px}.hero__poster{display:none}}
</style>
</head>
<body>

<header class="hdr">
  <div class="hdr__row container">
    <div class="brand">
      <img src="https://i.postimg.cc/8P1JNgVV/Black-White-Modern-Grunge-Typographic-Brand-Logo-1-Edited.png" alt="Logo" width="42" height="42" decoding="async">
      <div class="brand__t">THANHPHAT</div>
    </div>
    <nav class="tabs" id="tabs">
      <button class="tab active" data-view="home">Trang ch·ªß</button>
      <button class="tab" data-type="phim-le" data-view="explore">Phim l·∫ª</button>
      <button class="tab" data-type="phim-bo" data-view="explore">Phim b·ªô</button>
      <button class="tab" data-type="tv-shows" data-view="explore">TV Shows</button>
      <button class="tab" data-type="hoat-hinh" data-view="explore">Ho·∫°t h√¨nh</button>
      <button class="tab" data-view="fav">Y√™u th√≠ch</button>
      <button class="tab" data-view="his">L·ªãch s·ª≠</button>
    </nav>
    <div class="search">
      <input id="q" placeholder="T√¨m phim... (·∫•n / ƒë·ªÉ focus)" aria-label="T√¨m phim">
      <button id="btnSearch" class="btn btn-pill">T√¨m</button>
    </div>
  </div>
</header>

<!-- HOME -->
<section id="home" class="container">
  <div class="hero">
    <div class="hero__card">
      <div id="heroBg" class="hero__bg" aria-hidden="true"></div>
      <div class="hero__overlay"></div>
      <div class="hero__body">
        <div class="hero__poster"><img id="heroPoster" src="" alt="" loading="lazy" decoding="async" referrerpolicy="no-referrer"></div>
        <div>
          <h1 id="heroTitle">ƒêang t·∫£i...</h1>
          <div class="badges" id="heroBadges"></div>
          <div id="heroDesc" class="desc"></div>
          <div style="margin-top:10px;display:flex;gap:8px">
            <button id="heroPlay" class="btn btn-pill">Xem ngay</button>
            <button id="heroSave" class="btn btn-pill" style="background:#1f2937">+ L∆∞u</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- C√°c h√†ng -->
  <div class="sec container"><h2>üî• Phim Hot</h2></div>
  <div class="row container">
    <button class="nav left" data-target="row-hot" aria-label="L√πi">‚Äπ</button>
    <div id="row-hot" class="movie-row"></div>
    <button class="nav right" data-target="row-hot" aria-label="Ti·∫øn">‚Ä∫</button>
  </div>

  <div class="sec container"><h2>‚öîÔ∏è H√†nh ƒë·ªông</h2></div>
  <div class="row container">
    <button class="nav left" data-target="row-hd">‚Äπ</button>
    <div id="row-hd" class="movie-row"></div>
    <button class="nav right" data-target="row-hd">‚Ä∫</button>
  </div>

  <div class="sec container"><h2>üíû T√¨nh c·∫£m</h2></div>
  <div class="row container">
    <button class="nav left" data-target="row-tc">‚Äπ</button>
    <div id="row-tc" class="movie-row"></div>
    <button class="nav right" data-target="row-tc">‚Ä∫</button>
  </div>

  <div class="sec container"><h2>üéÉ Kinh d·ªã</h2></div>
  <div class="row container">
    <button class="nav left" data-target="row-kd">‚Äπ</button>
    <div id="row-kd" class="movie-row"></div>
    <button class="nav right" data-target="row-kd">‚Ä∫</button>
  </div>

  <div class="sec container"><h2>üé¨ Phim l·∫ª</h2></div>
  <div class="row container">
    <button class="nav left" data-target="row-le">‚Äπ</button>
    <div id="row-le" class="movie-row"></div>
    <button class="nav right" data-target="row-le">‚Ä∫</button>
  </div>

  <div class="sec container"><h2>üéûÔ∏è Phim b·ªô</h2></div>
  <div class="row container">
    <button class="nav left" data-target="row-bo">‚Äπ</button>
    <div id="row-bo" class="movie-row"></div>
    <button class="nav right" data-target="row-bo">‚Ä∫</button>
  </div>
</section>

<!-- EXPLORE / SEARCH GRID -->
<section id="explore" class="container" style="display:none">
  <div class="sec"><h2 id="exploreTitle">Kh√°m ph√°</h2></div>
  <div id="grid" class="grid"></div>
  <div id="sentinel" style="height:1px"></div>
</section>

<!-- FAV / HISTORY -->
<section id="fav" class="container" style="display:none">
  <div class="sec"><h2>üìå Y√™u th√≠ch</h2></div>
  <div id="favGrid" class="grid"></div>
</section>
<section id="his" class="container" style="display:none">
  <div class="sec"><h2>üïò L·ªãch s·ª≠</h2></div>
  <div id="hisGrid" class="grid"></div>
</section>

<!-- POPUP -->
<div id="popup" class="popup" role="dialog" aria-modal="true">
  <span class="close" id="close">‚úï</span>
  <div class="popup-content">
    <div id="player" class="player"></div>
    <div class="pb">
      <img id="pPoster" src="" alt="Poster" loading="lazy" decoding="async" referrerpolicy="no-referrer">
      <div class="pi">
        <h3 id="pTitle">...</h3>
        <div id="pMeta" class="m"></div>
        <div id="pDesc" class="desc"></div>
        <button id="pToggle" class="toggle" style="display:none">Xem th√™m ‚ñº</button>
        <div style="margin:10px 0;display:flex;gap:8px">
          <button id="pSave" class="btn btn-pill">+ L∆∞u</button>
          <button id="pReport" class="btn btn-pill" style="background:#1f2937">B√°o l·ªói</button>
          <button id="pShare" class="btn btn-pill" style="background:#1f2937">Chia s·∫ª</button>
        </div>
        <h4>Danh s√°ch t·∫≠p</h4>
        <div id="eps" class="eps"></div>
      </div>
    </div>
  </div>
</div>

<footer>
  <div class="footer-content">
    <img src="https://i.postimg.cc/8P1JNgVV/Black-White-Modern-Grunge-Typographic-Brand-Logo-1-Edited.png" alt="Logo" style="height:210px" />
    <p>THANHPHAT cung c·∫•p th√¥ng tin phim hot, c·∫≠p nh·∫≠t nhanh ‚Äì d·ªØ li·ªáu t·ªïng h·ª£p t·ª´ Internet / phimapi.com. Ch√∫ng t√¥i kh√¥ng l∆∞u tr·ªØ n·ªôi dung video.</p>
    <p>¬© 2025 THANHPHAT</p>
  </div>
</footer>

<script>
/* =================== Helpers & API =================== */
const API_BASE='https://phimapi.com';
const API_V1=API_BASE+'/v1/api';
const $=s=>document.querySelector(s);const $$=s=>document.querySelectorAll(s);
const toast=(m,t=1800)=>{const d=document.createElement('div');d.className='toast';d.textContent=m;document.body.appendChild(d);setTimeout(()=>d.remove(),t)};
function absUrl(p,cdn='https://phimimg.com'){if(!p)return'';if(/^https?:\/\//i.test(p))return p;if(p.startsWith('//'))return (location.protocol||'https:')+p;if(p.startsWith('/upload/'))return cdn+p;return cdn.replace(/\/+$/,'')+'/'+p.replace(/^\/+/,'')}
function wsrv(u){try{const x=new URL(u);return 'https://wsrv.nl/?url='+encodeURIComponent(x.host+x.pathname+(x.search||''))}catch{return''}}
function ph(t){const s=(t||'Poster').replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));return `data:image/svg+xml;utf8,`+encodeURIComponent(`<svg xmlns='http://www.w3.org/2000/svg' width='480' height='720'><defs><linearGradient id='g' x1='0' y1='0' x2='1' y2='1'><stop stop-color='#0b1020'/><stop offset='1' stop-color='#111827'/></linearGradient></defs><rect width='100%' height='100%' fill='url(#g)'/><g fill='#9ca3af' transform='translate(240,280)'><circle r='38'/><rect x='-60' y='50' width='120' height='6' rx='3'/></g><text x='50%' y='92%' font-size='26' fill='#9ca3af' text-anchor='middle' font-family='system-ui,Segoe UI,Roboto,sans-serif'>${s}</text></svg>`)}
function imgChain(raw,cdn){const a=absUrl(raw,cdn);if(!a)return [ph('Poster')];const httpsFix=(location.protocol==='https:'&&/^http:\/\//i.test(a))?a.replace(/^http:/,'https:'):'';const proxy=`${API_BASE}/image.php?url=${encodeURIComponent(a)}`;const w=wsrv(a);const list=[proxy,w,httpsFix,a].filter(Boolean);list.push(ph('Poster'));return [...new Set(list)]}
function onImgError(img){const l=(img.dataset.f||'').split('|').filter(Boolean);let i=+img.dataset.i||0;if(i<l.length-1){img.dataset.i=++i;img.src=l[i]}else{img.onerror=null;img.src=l[l.length-1]}}
window.onImgError=onImgError;

const memCache=new Map(); // cache nh·∫π trong phi√™n
async function fetchJSON(u,t=10000){if(memCache.has(u)) return memCache.get(u);const c=new AbortController();const k=setTimeout(()=>c.abort(),t);try{const r=await fetch(u,{signal:c.signal,credentials:'omit',cache:'force-cache'});clearTimeout(k);if(!r.ok)throw new Error('HTTP '+r.status);const j=await r.json();memCache.set(u,j);return j}catch(e){clearTimeout(k);throw e}}

function normList(raw){let it=[],cp=1,tp=1,cdn='https://phimimg.com';if(raw?.data?.items){it=raw.data.items;const p=raw.data.params?.pagination||{};cp=p.currentPage||p.current_page||1;tp=p.totalPages||p.total_pages||1;cdn=raw.data.APP_DOMAIN_CDN_IMAGE||cdn}else{it=raw.items||[];cp=raw.pagination?.currentPage||1;tp=raw.pagination?.totalPages||1;cdn=raw.APP_DOMAIN_CDN_IMAGE||cdn}return {items:it,cp,tp,cdn}}

/* =================== UI building =================== */
function card(movie, cdn){
  const t=movie.name||movie.origin_name||'Kh√¥ng t√™n';
  const srcs=imgChain(movie.poster_url||movie.thumb_url||movie.poster||movie.image||'',cdn);
  const div=document.createElement('div');div.className='movie';div.dataset.slug=movie.slug||'';
  div.innerHTML=`<div class="poster shine">
      <img src="${srcs[0]}" alt="${t.replace(/"/g,'&quot;')}" loading="lazy" decoding="async" referrerpolicy="no-referrer"
           data-f="${srcs.join('|')}" data-i="0" onerror="onImgError(this)">
      <div class="meta">
        <div class="tl">${t}</div>
        <div class="pills">
          ${movie.year?`<span class="pill">${movie.year}</span>`:''}
          ${movie.lang?`<span class="pill">${movie.lang}</span>`:''}
          ${movie.quality?`<span class="pill">${movie.quality}</span>`:''}
        </div>
      </div>
    </div>`;
  const posterEl=()=>div.querySelector('.poster');
  div.addEventListener('mousemove',e=>{const r=posterEl().getBoundingClientRect();const x=(e.clientX-r.left)/r.width,y=(e.clientY-r.top)/r.height;posterEl().style.setProperty('--rx',((.5-y)*10)+'deg');posterEl().style.setProperty('--ry',((x-.5)*10)+'deg')},{passive:true});
  div.addEventListener('mouseleave',()=>{const p=posterEl();p.style.setProperty('--rx','0deg');p.style.setProperty('--ry','0deg')});
  div.addEventListener('click',()=>openDetail(movie.slug));
  return div;
}
function fillRow(containerId, items, cdn){const el=document.getElementById(containerId);el.innerHTML='';items.forEach(m=>el.appendChild(card(m,cdn)))}
function skeletonRow(containerId,n=10){const el=document.getElementById(containerId);el.innerHTML='';for(let i=0;i<n;i++){const d=document.createElement('div');d.className='movie';d.innerHTML='<div class="skeleton"></div>';el.appendChild(d)}}

/* =================== Home data =================== */
async function loadHome(){
  try{
    skeletonRow('row-hot');skeletonRow('row-hd');skeletonRow('row-tc');skeletonRow('row-kd');skeletonRow('row-le');skeletonRow('row-bo');
    const urls=[`${API_BASE}/danh-sach/phim-moi-cap-nhat-v3?page=1`,`${API_BASE}/danh-sach/phim-moi-cap-nhat-v2?page=1`,`${API_BASE}/danh-sach/phim-moi-cap-nhat?page=1`];
    let hot=null;for(const u of urls){try{hot=normList(await fetchJSON(u));break}catch{}}
    if(hot){fillRow('row-hot', hot.items.slice(0,12), hot.cdn);buildHero(hot.items[0],hot.cdn)}
    // category / lists
    loadBy(`${API_V1}/the-loai/hanh-dong?page=1&limit=36`,'row-hd');
    loadBy(`${API_V1}/the-loai/tinh-cam?page=1&limit=36`,'row-tc');
    loadBy(`${API_V1}/the-loai/kinh-di?page=1&limit=36`,'row-kd');
    loadBy(`${API_V1}/danh-sach/phim-le?page=1&limit=36`,'row-le');
    loadBy(`${API_V1}/danh-sach/phim-bo?page=1&limit=36`,'row-bo');

    // Prefetch Explore nh·∫π sau khi idle
    (window.requestIdleCallback||setTimeout)(()=>startExplore('phim-le','Kh√°m ph√°: Phim l·∫ª'),800);
  }catch(e){toast('L·ªói t·∫£i trang ch·ªß')}
}
async function loadBy(url, cid){try{const d=normList(await fetchJSON(url));fillRow(cid,d.items,d.cdn)}catch{}}
function buildHero(m,cdn){
  if(!m) return;
  const poster=imgChain(m.poster_url||m.thumb_url||'',cdn)[0];
  $('#heroPoster').src=poster;
  $('#heroBg').style.backgroundImage=`url('${poster}')`;
  $('#heroTitle').textContent=m.name||m.origin_name||'';
  const b=[]; if(m.year)b.push(`<span class="badge">${m.year}</span>`); if(m.lang)b.push(`<span class="badge">${m.lang}</span>`); if(m.quality)b.push(`<span class="badge">${m.quality}</span>`);
  $('#heroBadges').innerHTML=b.join('');
  $('#heroDesc').textContent=m.content || m.description || '...';
  $('#heroPlay').onclick=()=>openDetail(m.slug);
  $('#heroSave').onclick=()=>toggleFav(m);
}

/* =================== Explore/Search =================== */
let explorePage=1, exploreType='phim-le', exploreKey='', exploreTotal=1, exploreCDN='https://phimimg.com';
function setView(id){['home','explore','fav','his'].forEach(v=>document.getElementById(v).style.display=(v===id)?'block':'none')}
$('#tabs').addEventListener('click',e=>{
  const t=e.target.closest('.tab'); if(!t) return;
  $$('#tabs .tab').forEach(x=>x.classList.remove('active')); t.classList.add('active');
  const view=t.dataset.view;
  if(view==='home'){setView('home');return}
  if(view==='explore'){exploreType=t.dataset.type;startExplore(exploreType,'Kh√°m ph√°: '+t.textContent);return}
  if(view==='fav'){renderFav();setView('fav');return}
  if(view==='his'){renderHistory();setView('his');return}
});
function exploreUrl(page){
  if(exploreKey){
    const p=new URLSearchParams({keyword:exploreKey,page,limit:36});
    return `${API_V1}/tim-kiem?${p}`;
  }
  return `${API_V1}/danh-sach/${exploreType}?page=${page}&limit=36`;
}
async function startExplore(typeOrKey, title){
  setView('explore'); $('#grid').innerHTML=''; $('#exploreTitle').textContent=title||'Kh√°m ph√°';
  explorePage=1; exploreTotal=2; exploreCDN='https://phimimg.com';
  if(typeof typeOrKey==='string' && (typeOrKey==='phim-le'||typeOrKey==='phim-bo'||typeOrKey==='tv-shows'||typeOrKey==='hoat-hinh')){ exploreType=typeOrKey; exploreKey=''; }
  else { exploreKey=typeOrKey; }
  for(let i=0;i<12;i++){const d=document.createElement('div');d.className='skeleton';$('#grid').appendChild(d)}
  await loadMoreExplore();
}
async function loadMoreExplore(){
  if(explorePage>exploreTotal) return;
  try{
    const d=normList(await fetchJSON(exploreUrl(explorePage)));
    exploreCDN=d.cdn; exploreTotal=d.tp;
    const grid=$('#grid'); if(explorePage===1) grid.innerHTML='';
    d.items.forEach(m=>grid.appendChild(card(m,exploreCDN)));
    explorePage++;
  }catch{}
}
const io=new IntersectionObserver(es=>{es.forEach(e=>{if(e.isIntersecting) loadMoreExplore()})},{rootMargin:'1200px'}); io.observe($('#sentinel'));

/* =================== Search box (debounced) =================== */
const debounce=(fn,ms=350)=>{let t;return(...a)=>{clearTimeout(t);t=setTimeout(()=>fn(...a),ms)}}
const doSearch=()=>{const k=$('#q').value.trim();if(!k)return toast('Nh·∫≠p t·ª´ kho√°');startExplore(k,`K·∫øt qu·∫£: ‚Äú${k}‚Äù`);location.hash='#search='+encodeURIComponent(k)}
$('#btnSearch').addEventListener('click',doSearch);
$('#q').addEventListener('input',debounce(()=>{const v=$('#q').value.trim();if(v.length>2) startExplore(v,`K·∫øt qu·∫£: ‚Äú${v}‚Äù`)},600));
$('#q').addEventListener('keypress',e=>{if(e.key==='Enter') doSearch()});
document.addEventListener('keydown',e=>{if(e.key==='/'&&document.activeElement!==$('#q')){e.preventDefault();$('#q').focus()}},{passive:true});

/* =================== Detail & Player =================== */
let hls=null, currentMovie=null;
async function openDetail(slug){
  if(!slug) return;
  try{
    const d=await fetchJSON(`${API_BASE}/phim/${slug}`);
    if(!d?.status) return toast('Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu');
    const m=d.movie||{}; currentMovie=m; location.hash='#/p/'+slug;
    const cdn=d.APP_DOMAIN_CDN_IMAGE||'https://phimimg.com';
    $('#pPoster').src=imgChain(m.poster_url||m.thumb_url||'',cdn)[0];
    $('#pTitle').textContent=`${m.name||m.origin_name||''} ${m.year?`(${m.year})`:''}`;
    $('#pMeta').innerHTML=`‚è≥ ${m.time||'N/A'} ‚Ä¢ ${m.quality||'N/A'}<br>üé≠ ${(m.category||[]).map(x=>x.name).join(', ')||'Kh√¥ng r√µ'}<br>üåê ${(m.country||[]).map(x=>x.name).join(', ')||'Kh√¥ng r√µ'}`;
    const desc=m.content||'Kh√¥ng c√≥ m√¥ t·∫£'; const el=$('#pDesc'); el.textContent=desc; const tg=$('#pToggle');
    if(desc.length>220){tg.style.display='inline-block';tg.textContent='Xem th√™m ‚ñº';tg.onclick=()=>{const ex=el.classList.toggle('exp');tg.textContent=ex?'Thu g·ªçn':'Xem th√™m ‚ñº'} } else tg.style.display='none';
    const eps=(d.episodes||[]).flatMap(sv=>(sv.server_data||[]).map((ep,i)=>({name:ep.name||`T·∫≠p ${i+1}`,embed:ep.link_embed,m3u8:ep.link_m3u8})));
    const wrap=$('#eps'); wrap.innerHTML=''; eps.forEach(ep=>{const b=document.createElement('button');b.textContent=ep.name; b.onclick=()=>play(ep); wrap.appendChild(b)});
    $('#pSave').onclick=()=>toggleFav(m);
    $('#pReport').onclick=()=>{prompt('M√¥ t·∫£ l·ªói ph√°t (copy link n√†y g·ª≠i cho admin):', location.href)};
    $('#pShare').onclick=()=>{navigator.clipboard?.writeText(location.href); toast('ƒê√£ sao ch√©p link')};
    openPopup(); if(eps[0]) play(eps[0]);
    addHistory(m);
  }catch{toast('L·ªói t·∫£i chi ti·∫øt')}
}
function openPopup(){ $('#popup').style.display='flex'; window.scrollTo({top:0,behavior:'smooth'}) }
function closePopup(){ cleanup(); $('#popup').style.display='none'; if(location.hash.startsWith('#/p/')) history.pushState('',document.title,window.location.pathname+window.location.search) }
$('#close').onclick=closePopup;
function cleanup(){ if(hls){try{hls.destroy()}catch{} hls=null} $('#player').innerHTML='' }
function play(ep){
  cleanup();
  if(ep.m3u8 && ep.m3u8.endsWith('.m3u8')){
    const v=document.createElement('video'); v.controls=true; v.autoplay=true; v.playsInline=true; v.crossOrigin='anonymous'; $('#player').appendChild(v);
    if(Hls.isSupported()){
      hls=new Hls({enableWorker:true,lowLatencyMode:true,maxBufferLength:30,maxMaxBufferLength:60});
      hls.loadSource(ep.m3u8); hls.attachMedia(v);
      hls.on(Hls.Events.ERROR,(_,d)=>{ if(d.fatal){ try{hls.recoverMediaError()}catch{ if(ep.embed) playEmbed(ep.embed) } } });
    } else if(v.canPlayType('application/vnd.apple.mpegurl')){ v.src=ep.m3u8 }
      else if(ep.embed) playEmbed(ep.embed); else toast('Thi·∫øt b·ªã kh√¥ng h·ªó tr·ª£ HLS');
  }else if(ep.embed) playEmbed(ep.embed); else toast('Kh√¥ng c√≥ ngu·ªìn ph√°t');
}
function playEmbed(u){ $('#player').innerHTML=`<iframe src="${u}" allow="autoplay; encrypted-media; picture-in-picture" referrerpolicy="no-referrer" allowfullscreen></iframe>` }

/* =================== Fav & History =================== */
function lsGet(k,def){try{return JSON.parse(localStorage.getItem(k)||def)}catch{return JSON.parse(def)}}
function lsSet(k,v){localStorage.setItem(k, JSON.stringify(v))}
function favList(){return lsGet('fav','[]')}
function isFav(slug){return favList().some(x=>x.slug===slug)}
function toggleFav(m){let f=favList(); if(isFav(m.slug)){f=f.filter(x=>x.slug!==m.slug); toast('ƒê√£ xo√° kh·ªèi Y√™u th√≠ch')}else{f.unshift({slug:m.slug,name:m.name||m.origin_name,poster:m.poster_url||m.thumb_url,year:m.year,lang:m.lang}); toast('ƒê√£ l∆∞u Y√™u th√≠ch')} lsSet('fav',f); renderFav()}
function renderFav(){const grid=$('#favGrid'); grid.innerHTML=''; favList().forEach(x=>{const div=card(x,'https://phimimg.com'); grid.appendChild(div)}); if(!favList().length) grid.innerHTML='<p style="color:#9aa4b5">Ch∆∞a c√≥ m·ª•c y√™u th√≠ch n√†o.</p>'}
function hisList(){return lsGet('his','[]')}
function addHistory(m){let h=hisList().filter(x=>x.slug!==m.slug); h.unshift({slug:m.slug,name:m.name||m.origin_name,poster:m.poster_url||m.thumb_url,year:m.year,lang:m.lang}); h=h.slice(0,60); lsSet('his',h)}
function renderHistory(){const grid=$('#hisGrid'); grid.innerHTML=''; hisList().forEach(x=>grid.appendChild(card(x,'https://phimimg.com'))); if(!hisList().length) grid.innerHTML='<p style="color:#9aa4b5">Ch∆∞a c√≥ l·ªãch s·ª≠ xem.</p>'}

/* =================== Row nav arrows =================== */
document.addEventListener('click',e=>{const n=e.target.closest('.nav');if(!n)return;const id=n.dataset.target;const row=document.getElementById(id);row.scrollBy({left:(n.classList.contains('left')?-1:1)*row.clientWidth*.9,behavior:'smooth'})},{passive:true});

/* =================== Routing (hash) =================== */
window.addEventListener('hashchange',()=>{const h=location.hash; if(h.startsWith('#/p/')) openDetail(h.split('/p/')[1]); else if(h.startsWith('#search=')){const kw=decodeURIComponent(h.split('=')[1]||''); $('#q').value=kw; startExplore(kw,`K·∫øt qu·∫£: ‚Äú${kw}‚Äù`) }});

/* =================== Kickoff =================== */
loadHome();
</script>
</body>
</html>

